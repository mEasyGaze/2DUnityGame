### **聲音系統模組(Audio System Module)**

1. AudioLibrarySO.cs(ScriptableObject)：
(1) 資料結構：定義 SoundData 類別，包含 soundID、clip、outputGroup、volume、pitchVariance 和 loop。
(2) 快速查找：確保運行時能以 O(1) 的效率透過 ID 查找音效。
(3) 防呆機制：包含嚴格的空值檢查與自動重新初始化邏輯，防止在編輯器中因重新編譯導致的引用遺失。

2. AudioManager.cs(管理器)：
(1) 多軌道管理
* Music Channels：配置雙軌 AudioSource，實現背景音樂的 Cross-fade (淡入淡出) 無縫切換。
* SFX Pool：維護一個 AudioSource 物件池，輪替播放短促音效，避免頻繁 Instantiate/Destroy 造成的效能開銷。
* UI Source：獨立的 AudioSource，專門播放不受 3D 空間影響的介面音效。
(2) 播放控制：提供簡單的 API (PlayMusic, PlaySFX, PlayUI, StopMusic) 供其他系統調用。
(3) 時間獨立性：淡入淡出協程使用 unscaledDeltaTime，確保即使遊戲暫停（TimeScale=0），音樂切換仍能流暢執行。
(4) 混音器整合：直接控制 Unity Audio Mixer 的參數，實現全局音量調整。

3. AudioBackground.cs(背景音樂)：
(1) 自動播放功能、場景過渡控制。

4. SoundOnButton.cs(按鈕音效)：
(1) 事件監聽：實作 IPointerEnterHandler (滑鼠懸停) 和 IPointerClickHandler (點擊)。
(2) 動態配置：允許外部透過 Setup() 方法動態指定懸停與點擊的音效 ID。

5. AudioSettingsUI.cs(聲音系統UI)：
(1) 音量控制：包含 Master、Music、SFX 三個滑桿，分別控制 Audio Mixer 的對應群組。
(2) 數據持久化：使用 PlayerPrefs 自動保存與讀取玩家的音量設定，確保下次開啟遊戲時設定不變。

6. UISoundAutoHook.cs(音效自動掛載器)：
(1) 全場景掃描：能自動搜尋場景中所有的 Canvas 與 Button。
(2) 智能掛載：自動檢查按鈕是否已有音效組件，若無則動態添加 SoundOnButton 並設定預設音效 ID。

---

### **腳本**

#### 1. `AudioLibrarySO.cs`
```
using UnityEngine;
using UnityEngine.Audio;
using System.Collections.Generic;

public enum AudioType { SFX, Music, UI, Ambience }

[System.Serializable]
public class SoundData
{
    [Tooltip("程式呼叫用的 ID，例如 'BGM_Battle', 'SFX_Sword_Hit'")]
    public string soundID;
    public AudioClip clip;
    
    [Header("細節設定")]
    [Range(0f, 1f)] public float volume = 1f;
    [Tooltip("音高隨機變化範圍 (0 = 無變化, 0.1 = 輕微變化)。用於 SFX 避免機械感。")]
    [Range(0f, 0.5f)] public float pitchVariance = 0f;
    
    [Tooltip("指定輸出軌道 (Master/Music/SFX/UI)")]
    public AudioMixerGroup outputGroup;
    public bool loop = false;
}

[CreateAssetMenu(fileName = "AudioLibrary", menuName = "Audio/Audio Library")]
public class AudioLibrarySO : ScriptableObject
{
    public List<SoundData> sounds = new List<SoundData>();

    [System.NonSerialized]
    private Dictionary<string, SoundData> soundDictionary;
    
    public void Initialize()
    {
        soundDictionary = new Dictionary<string, SoundData>();
        
        if (sounds == null) return;

        foreach (var sound in sounds)
        {
            if (sound == null || string.IsNullOrEmpty(sound.soundID)) continue;

            if (!soundDictionary.ContainsKey(sound.soundID))
            {
                soundDictionary.Add(sound.soundID, sound);
            }
            else
            {
                Debug.LogWarning($"[AudioLibrary] 重複的 Sound ID: {sound.soundID}");
            }
        }
        Debug.Log($"[AudioLibrary] 已初始化，載入 {soundDictionary.Count} 個音效資料。");
    }

    public SoundData GetSound(string id)
    {
        if (soundDictionary == null) 
        {
            Initialize();
        }
        if (soundDictionary == null)
        {
            Debug.LogError("[AudioLibrary] 嚴重錯誤：字典初始化失敗！");
            return null;
        }
        if (soundDictionary.TryGetValue(id, out SoundData data))
        {
            return data;
        }
        Debug.LogWarning($"[AudioLibrary] 找不到音效 ID: {id}。請檢查 Library 設定或 ID 拼字。");
        return null;
    }
    
    private void OnValidate()
    {
        #if UNITY_EDITOR
        if (Application.isPlaying)
        {
            Initialize();
        }
        #endif
    }
}
```

#### 2. `AudioManager.cs`
```
using UnityEngine;
using UnityEngine.Audio;
using System.Collections;
using System.Collections.Generic;

public class AudioManager : MonoBehaviour
{
    public static AudioManager Instance { get; private set; }

    [Header("設定")]
    [SerializeField] private AudioLibrarySO audioLibrary;
    [SerializeField] private AudioMixer audioMixer;

    [Header("音源配置")]
    [SerializeField] private AudioSource musicSource1;
    [SerializeField] private AudioSource musicSource2;
    [SerializeField] private AudioSource uiSource;
    [SerializeField] private GameObject sfxSourcePrefab;
    [SerializeField] private int sfxPoolSize = 10;

    private List<AudioSource> sfxPool;
    private bool isMusicSource1Playing = false;

    void Awake()
    {
        if (Instance != null && Instance != this)
        {
            Destroy(gameObject);
            return;
        }
        Instance = this;
        DontDestroyOnLoad(gameObject);

        if (audioLibrary != null) audioLibrary.Initialize();
        InitializeSFXPool();
    }

    private void InitializeSFXPool()
    {
        sfxPool = new List<AudioSource>();
        GameObject poolParent = new GameObject("SFX_Pool");
        poolParent.transform.SetParent(this.transform);

        for (int i = 0; i < sfxPoolSize; i++)
        {
            CreateSFXSource(poolParent.transform);
        }
    }

    private AudioSource CreateSFXSource(Transform parent)
    {
        GameObject go = Instantiate(sfxSourcePrefab, parent);
        AudioSource source = go.GetComponent<AudioSource>();
        go.SetActive(false);
        sfxPool.Add(source);
        return source;
    }

    #region 播放方法 (API)

    public void PlaySFX(string soundID, Vector3 position = default)
    {
        SoundData data = audioLibrary.GetSound(soundID);
        if (data == null) return;

        AudioSource source = GetAvailableSFXSource();
        source.transform.position = position;
        source.clip = data.clip;
        source.outputAudioMixerGroup = data.outputGroup;
        source.volume = data.volume;
        source.pitch = 1f + Random.Range(-data.pitchVariance, data.pitchVariance);
        
        source.gameObject.SetActive(true);
        source.Play();
        StartCoroutine(DisableSourceAfterPlay(source));
    }

    public void PlayUI(string soundID)
    {
        SoundData data = audioLibrary.GetSound(soundID);
        if (data == null) return;

        uiSource.outputAudioMixerGroup = data.outputGroup;
        uiSource.volume = data.volume;
        uiSource.pitch = 1f + Random.Range(-data.pitchVariance, data.pitchVariance);
        uiSource.PlayOneShot(data.clip);
    }

    public void PlayMusic(string soundID, float fadeDuration = 1.5f)
    {
        SoundData data = audioLibrary.GetSound(soundID);
        if (data == null) return;

        AudioSource activeSource = isMusicSource1Playing ? musicSource1 : musicSource2;
        AudioSource newSource = isMusicSource1Playing ? musicSource2 : musicSource1;

        if (activeSource.isPlaying && activeSource.clip == data.clip) return;

        StartCoroutine(CrossFadeMusic(activeSource, newSource, data, fadeDuration));
        isMusicSource1Playing = !isMusicSource1Playing;
    }

    public void StopMusic(float fadeDuration = 1.0f)
    {
        AudioSource activeSource = isMusicSource1Playing ? musicSource1 : musicSource2;
        StartCoroutine(FadeOut(activeSource, fadeDuration));
    }

    #endregion

    #region 內部邏輯 & Coroutines

    private AudioSource GetAvailableSFXSource()
    {
        foreach (var source in sfxPool)
        {
            if (!source.gameObject.activeInHierarchy)
            {
                return source;
            }
        }
        return CreateSFXSource(sfxPool[0].transform.parent);
    }

    private IEnumerator DisableSourceAfterPlay(AudioSource source)
    {
        yield return new WaitForSeconds(source.clip.length + 0.1f);
        source.gameObject.SetActive(false);
    }

    private IEnumerator CrossFadeMusic(AudioSource current, AudioSource next, SoundData nextData, float duration)
    {
        next.clip = nextData.clip;
        next.outputAudioMixerGroup = nextData.outputGroup;
        next.volume = 0;
        next.loop = nextData.loop;
        next.Play();

        float timer = 0;
        float startVolume = current.volume;
        float targetVolume = nextData.volume;

        while (timer < duration)
        {
            timer += Time.unscaledDeltaTime; 
            float progress = timer / duration;
            if (current.isPlaying) current.volume = Mathf.Lerp(startVolume, 0, progress);
            
            next.volume = Mathf.Lerp(0, targetVolume, progress);
            yield return null;
        }
        current.Stop();
        current.volume = startVolume;
        next.volume = targetVolume;
    }

    private IEnumerator FadeOut(AudioSource source, float duration)
    {
        float startVolume = source.volume;
        float timer = 0;

        while (timer < duration)
        {
            timer += Time.unscaledDeltaTime;
            source.volume = Mathf.Lerp(startVolume, 0, timer / duration);
            yield return null;
        }
        source.Stop();
        source.volume = startVolume;
    }
    #endregion

    #region 設定 (Settings)
    public void SetMasterVolume(float value)
    {
        float db = (value <= 0.001f) ? -80f : Mathf.Log10(value) * 20f;
        audioMixer.SetFloat("MasterVolume", db);
    }
    public void SetMusicVolume(float value)
    {
        float db = (value <= 0.001f) ? -80f : Mathf.Log10(value) * 20f;
        audioMixer.SetFloat("MusicVolume", db);
    }
    public void SetSFXVolume(float value)
    {
        float db = (value <= 0.001f) ? -80f : Mathf.Log10(value) * 20f;
        audioMixer.SetFloat("SFXVolume", db);
    }
    #endregion
}
```

#### 3. `AudioBackground.cs`
```
using UnityEngine;

public class AudioBackground : MonoBehaviour
{
    [Header("背景音樂設定")]
    [Tooltip("進入此場景或啟用此物件時，要播放的音樂 ID")]
    [SerializeField] private string bgmID;
    
    [Tooltip("淡入淡出時間 (秒)。設為 0 代表瞬間切換。")]
    [SerializeField] private float fadeDuration = 2.0f;

    [Tooltip("是否在播放新音樂前，強制立即停止上一首音樂？(解決重疊問題)")]
    [SerializeField] private bool forceStopPrevious = false;

    [Tooltip("是否在 Start 時自動播放")]
    [SerializeField] private bool playOnStart = true;

    void Start()
    {
        if (playOnStart)
        {
            PlayBGM();
        }
    }

    public void PlayBGM()
    {
        if (AudioManager.Instance == null || string.IsNullOrEmpty(bgmID))
        {
            Debug.LogWarning($"[AudioBackground] 無法播放 BGM。Manager是否存在? ID是否為空? ({bgmID})");
            return;
        }
        if (forceStopPrevious)
        {
            AudioManager.Instance.StopMusic(0f);
        }
        AudioManager.Instance.PlayMusic(bgmID, fadeDuration);
    }
    
    public void ChangeBGM(string newID)
    {
        bgmID = newID;
        PlayBGM();
    }
}
```

#### 4. `SoundOnButton.cs`
```
using UnityEngine;
using UnityEngine.UI;
using UnityEngine.EventSystems;

[RequireComponent(typeof(Button))]
public class SoundOnButton : MonoBehaviour, IPointerEnterHandler, IPointerClickHandler
{
    [Header("音效設定")]
    [Tooltip("滑鼠懸停時的音效 ID (留空則不播放)")]
    [SerializeField] private string hoverSoundID = "UI_Hover";
    
    [Tooltip("點擊時的音效 ID")]
    [SerializeField] private string clickSoundID = "UI_Click";

    private Button button;

    void Awake()
    {
        button = GetComponent<Button>();
    }

    public void Setup(string hoverID, string clickID)
    {
        this.hoverSoundID = hoverID;
        this.clickSoundID = clickID;
    }

    public void OnPointerEnter(PointerEventData eventData)
    {
        if (button == null) button = GetComponent<Button>();
        if (button.interactable && !string.IsNullOrEmpty(hoverSoundID))
        {
            AudioManager.Instance?.PlayUI(hoverSoundID);
        }
    }

    public void OnPointerClick(PointerEventData eventData)
    {
        if (button == null) button = GetComponent<Button>();
        if (button.interactable && !string.IsNullOrEmpty(clickSoundID))
        {
            AudioManager.Instance?.PlayUI(clickSoundID);
        }
    }
}
```

#### 5. `AudioSettingsUI.cs`
```
using UnityEngine;
using UnityEngine.UI;

public class AudioSettingsUI : MonoBehaviour
{
    [Header("Sliders")]
    [SerializeField] private Slider masterSlider;
    [SerializeField] private Slider musicSlider;
    [SerializeField] private Slider sfxSlider;

    [Header("Buttons")]
    [SerializeField] private Button closeButton;
    
    void Start()
    {
        if (masterSlider != null)
        {
            masterSlider.onValueChanged.AddListener(OnMasterVolumeChanged);
            masterSlider.value = PlayerPrefs.GetFloat("Vol_Master", 0.8f);
        }

        if (musicSlider != null)
        {
            musicSlider.onValueChanged.AddListener(OnMusicVolumeChanged);
            musicSlider.value = PlayerPrefs.GetFloat("Vol_Music", 0.8f);
        }

        if (sfxSlider != null)
        {
            sfxSlider.onValueChanged.AddListener(OnSFXVolumeChanged);
            sfxSlider.value = PlayerPrefs.GetFloat("Vol_SFX", 0.8f);
        }

        if (closeButton != null)
        {
            closeButton.onClick.AddListener(Hide);
        }
        OnMasterVolumeChanged(masterSlider.value);
        OnMusicVolumeChanged(musicSlider.value);
        OnSFXVolumeChanged(sfxSlider.value);
    }

    private void OnMasterVolumeChanged(float value)
    {
        if (AudioManager.Instance != null)
        {
            AudioManager.Instance.SetMasterVolume(value);
            PlayerPrefs.SetFloat("Vol_Master", value);
        }
    }

    private void OnMusicVolumeChanged(float value)
    {
        if (AudioManager.Instance != null)
        {
            AudioManager.Instance.SetMusicVolume(value);
            PlayerPrefs.SetFloat("Vol_Music", value);
        }
    }

    private void OnSFXVolumeChanged(float value)
    {
        if (AudioManager.Instance != null)
        {
            AudioManager.Instance.SetSFXVolume(value);
            PlayerPrefs.SetFloat("Vol_SFX", value);
        }
    }

    public void Show()
    {
        gameObject.SetActive(true);
    }

    public void Hide()
    {
        gameObject.SetActive(false);
        PlayerPrefs.Save();
    }
}
```

#### 6. `UISoundAutoHook.cs`
```
using UnityEngine;
using UnityEngine.UI;

public static class UISoundAutoHook
{
    public static void HookAllButtons(GameObject root, string hoverID = "UI_Hover", string clickID = "UI_Click")
    {
        if (root == null) return;
        Button[] allButtons = root.GetComponentsInChildren<Button>(true);
        int count = 0;
        foreach (var btn in allButtons)
        {
            if (btn.GetComponent<SoundOnButton>() == null)
            {
                var soundScript = btn.gameObject.AddComponent<SoundOnButton>();
                soundScript.Setup(hoverID, clickID);
                count++;
            }
        }
        if (count > 0)
        {
            Debug.Log($"[UISoundAutoHook] 已為 {root.name} 下的 {count} 個按鈕自動掛載音效。");
        }
    }

    public static void HookEntireScene(string hoverID = "UI_Hover", string clickID = "UI_Click")
    {
        Canvas[] allCanvases = GameObject.FindObjectsOfType<Canvas>(true);
        foreach (var canvas in allCanvases)
        {
            HookAllButtons(canvas.gameObject, hoverID, clickID);
        }
    }
}
```