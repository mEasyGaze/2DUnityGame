### **交易系統(Trading System)**

1. ShopInventorySO.cs(ScriptableObject)：
(1) 基本結構：商店名稱、初始資金、商品列表、隨機商品池(可選)、刷新時間(可選)
(2) 商店刷新：
    *   每次刷新時，從隨機池中抽取的商品數量。
    *   庫存刷新的時間間隔（以遊戲內天數計）。

2. ShopManager.cs：
(1) 會話管理：
    *   OpenShop -> 接收來自 DialogueManager 的開店請求，創建對應 NPC 的庫存，檢查庫存是否刷新，最後通知 ShopUI 顯示運行時數據。
    *   CloseShop -> 關閉 ShopUI 並觸發 OnShopClosed 事件，讓 DialogueManager 可以繼續後續對話。
(2) 數據管理：以 NPC 的唯一實例 ID 為鍵，存儲所有互動過的商人的運行時數據。
(3) 購買邏輯：
    *    驗證：玩家是否有足夠金錢、商店是否有足夠庫存。
    *    執行：扣除玩家金錢，增加玩家物品，減少商店庫存，增加商人資金。
(4) 出售邏輯：
    *   驗證：檢查玩家是否有足夠物品、商人是否有足夠資金。
    *   執行：增加玩家金錢，減少玩家物品，增加商店庫存，減少商人資金。
(5) 事件廣播：每次成功交易後觸發，通知 ShopUI 刷新介面。

3. ShopUI.cs：
(1) 雙向佈局：同時渲染商人和玩家的物品列表。
(2) 數據顯示：顯示商店名稱、玩家和商人的金錢等信息。
(3) 交互路由：接收來自 ShopSlotUI 的各種事件（單擊、雙擊、拖拽），並調用相應的處理邏輯。
(4) 托拽處理：判斷托拽的起始點和終點，如果跨越了商店/玩家面板，觸發交易請求。
(5) 實時刷新：監聽 ShopManager，在交易後刷新整個 UI，確保數據同步。

4. ShopSlotUI.cs：
(1) 顯示：根據傳入的數據(ShopItem, InvertorySlot)顯示物品圖標、數量和對應價格(買/賣)。
(2) 交互功能：
    *   左鍵單擊：通知 ShopUI 顯示物品詳情。
    *   左鍵雙擊：內置雙擊檢測邏輯，打開批量交易面板。
    *   右鍵單擊：執行快速交易，直接調用 ShopManager 買/賣 1 個單位。
(3) 托拽功能：
    *   托拽時：通知 ShopUI 顯示一個跟隨鼠標的臨時圖標，並使自身半透明。
    *   托拽期間：持續更新臨時圖標的位置。
    *   托拽結束瞬間：隱藏臨時圖標，恢復自身外觀，並通知 ShopUI 處理拖放結果。

5. ShopItemDetailsPanel.cs(商店專用物品詳情面板)：
(1) 顯示 Item 的基本訊息：物品圖標、名稱、類型、描述。

6. TransactionUI.cs(批量買賣的彈出式確認窗口)：
(1) 智能數量上限：購買還是出售，結合玩家金錢、商店庫存、商人資金等因素，自動計算並設置滑動條的最大可交易數量。
(2) 數量選擇：提供滑動條和輸入框，讓玩家方便地選擇數量。
(3) 實時總價：根據選擇的數量和單價，實時更新顯示總金額。
(4) 確認執行：點擊「確認」按鈕後，將選擇的物品和數量提交給 ShopManager 執行最終的交易。

---

### **腳本**

#### 1. `ShopInventorySO.cs`
```csharp
using System;
using UnityEngine;
using System.Collections.Generic;

public enum UnlockConditionType 
{ 
    QuestCompleted,
    GameEventTriggered
}

[Serializable]
public class ShopUnlockableItem
{
    [Tooltip("需要解鎖的商品及其數量。")]
    public ShopItem itemToUnlock;

    [Tooltip("解鎖此商品的條件類型。")]
    public UnlockConditionType conditionType;
    
    [Tooltip("條件的唯一標識符，例如 QuestID 或一個自定義的 GameEvent ID。")]
    public string conditionID;
}

[System.Serializable]
public class ShopItem
{
    public Item item;
    [Tooltip("庫存數量, -1 代表無限供應")]
    public int quantity;
}

[CreateAssetMenu(fileName = "New Shop Inventory", menuName = "Shop/Shop Inventory")]
public class ShopInventorySO : ScriptableObject
{
    [Header("商店基本資訊")]
    public string shopName = "雜貨店";
    public int initialFund = 1000;

    [Header("固定商品清單")]
    [Tooltip("定義此商店總是會販賣的商品及其初始庫存。")]
    public List<ShopItem> fixedStock = new List<ShopItem>();

    [Header("階段式解鎖商品")]
    [Tooltip("這些商品只有在滿足特定條件（如完成某個任務）後才會出現在商店中。")]
    public List<ShopUnlockableItem> unlockableStock = new List<ShopUnlockableItem>();
    
    [Header("刷新與隨機商品設定")]
    [Tooltip("商店庫存刷新的時間間隔（以遊戲內天數計）。設為0或負數則永不刷新。")]
    public int refreshIntervalDays = 1;

    [Tooltip("每次刷新時，從下面的隨機池中抽取的商品數量。")]
    public int randomItemsPerRefresh = 3;
    
    [Tooltip("一個商品池，商店刷新時會從中隨機抽取商品加入庫存。")]
    public List<ShopItem> randomStockPool = new List<ShopItem>();
}
```

#### 2. `ShopManager.cs`
```csharp
using System.Collections.Generic;
using UnityEngine;
using System.Linq;
using System;

#region 運行數據
public class ShopRuntimeData
{
    public ShopInventorySO BaseData { get; private set; }
    public int CurrentFund { get; set; }
    public List<ShopItem> CurrentStock { get; set; }
    public int LastRefreshDay { get; set; }

    public ShopRuntimeData(ShopInventorySO so)
    {
        BaseData = so;
        ResetToDefault();
    }
    
    public void ResetToDefault()
    {
        CurrentFund = BaseData.initialFund;
        CurrentStock = BaseData.fixedStock.Select(item => new ShopItem { item = item.item, quantity = item.quantity }).ToList();
        LastRefreshDay = 0;
    }
    
    public void RefreshStock()
    {
        Debug.Log($"[ShopRuntimeData] 正在為商店 '{BaseData.shopName}' 刷新庫存...");
        ResetToDefault();

        foreach (var unlockable in BaseData.unlockableStock)
        {
            bool isUnlocked = false;
            switch (unlockable.conditionType)
            {
                case UnlockConditionType.QuestCompleted:
                    isUnlocked = QuestManager.Instance.HasQuestBeenCompleted(unlockable.conditionID);
                    break;
                case UnlockConditionType.GameEventTriggered:
                    isUnlocked = GameEventManager.Instance.HasEventBeenTriggered(unlockable.conditionID);
                    break;
            }

            if (isUnlocked)
            {
                AddItemToStock(unlockable.itemToUnlock);
                Debug.Log($"[ShopRuntimeData] 條件滿足，已解鎖商品: {unlockable.itemToUnlock.item.itemName}");
            }
        }
        
        if (BaseData.randomStockPool.Count > 0 && BaseData.randomItemsPerRefresh > 0)
        {
            List<ShopItem> poolCopy = new List<ShopItem>(BaseData.randomStockPool);
            int itemsToAdd = Mathf.Min(BaseData.randomItemsPerRefresh, poolCopy.Count);

            for (int i = 0; i < itemsToAdd; i++)
            {
                if (poolCopy.Count == 0) break;
                int randomIndex = UnityEngine.Random.Range(0, poolCopy.Count);
                AddItemToStock(poolCopy[randomIndex]);
                poolCopy.RemoveAt(randomIndex);
            }
        }
        LastRefreshDay = WorldTimeSystem.Instance.CurrentDay;
    }
    
    private void AddItemToStock(ShopItem itemToAdd)
    {
        ShopItem existingItem = CurrentStock.FirstOrDefault(si => si.item == itemToAdd.item);
        if (existingItem != null)
        {
            if (existingItem.quantity != -1)
            {
                existingItem.quantity += itemToAdd.quantity;
            }
        }
        else
        {
            CurrentStock.Add(new ShopItem { item = itemToAdd.item, quantity = itemToAdd.quantity });
        }
    }
}
#endregion

#region 管理器
public class ShopManager : MonoBehaviour, IGameSaveable
{
    public static ShopManager Instance { get; private set; }
    private ShopUI shopUI;

    private Dictionary<string, ShopRuntimeData> traderRuntimeData = new Dictionary<string, ShopRuntimeData>();
    private Dictionary<string, NPC> npcDatabase = new Dictionary<string, NPC>();
    private ShopRuntimeData currentShop;
    private NPC currentTrader;

    public event Action OnTransactionCompleted;
    public event Action<string> OnShopClosed;
    private string dialogueSegmentToContinue;
    
    private bool isLoading = false;

    void Awake()
    {
        if (Instance != null && Instance != this) { Destroy(gameObject); return; }
        Instance = this;
        DontDestroyOnLoad(gameObject);
        SaveManager.Instance.Register(this);
        UnityEngine.SceneManagement.SceneManager.sceneLoaded += OnSceneLoaded;
        CacheAllNPCs();
    }

    void OnDestroy()
    {
        if (SaveManager.Instance != null)
        {
            SaveManager.Instance.Unregister(this);
        }
        UnityEngine.SceneManagement.SceneManager.sceneLoaded -= OnSceneLoaded;
    }

    private void OnSceneLoaded(UnityEngine.SceneManagement.Scene scene, UnityEngine.SceneManagement.LoadSceneMode mode)
    {
        CacheAllNPCs();
    }

    private void CacheAllNPCs()
    {
        npcDatabase.Clear();
        var allNpcs = FindObjectsOfType<NPC>(true);
        foreach (var npc in allNpcs)
        {
            if (!string.IsNullOrEmpty(npc.GetNpcID()) && !npcDatabase.ContainsKey(npc.GetNpcID()))
            {
                npcDatabase.Add(npc.GetNpcID(), npc);
            }
        }
        Debug.Log($"[ShopManager] 已緩存 {npcDatabase.Count} 個 NPC。");
    }
    
    private void OnEnable()
    {
        if (InputManager.Instance != null)
        {
            InputManager.Instance.OnEscape += HandleEscape;
        }
    }

    private void OnDisable()
    {
        if (InputManager.Instance != null)
        {
            InputManager.Instance.OnEscape -= HandleEscape;
        }
    }

    public void RegisterShopUI(ShopUI ui)
    {
        shopUI = ui;
    }

    public void OpenShop(ShopInventorySO shopData, NPC trader, string continueSegmentID)
    {
        if (GameManager.Instance != null)
        {
            GameManager.Instance.SetGameState(GameState.InShop);
        }
        if (shopUI == null) { Debug.LogError("商店UI未註冊!"); return; }

        currentTrader = trader;
        string traderID = trader.GetNpcID(); 

        if (!traderRuntimeData.TryGetValue(traderID, out currentShop))
        {
            Debug.Log($"[ShopManager] 首次與商人 '{traderID}' 互動，正在創建運行時數據...");
            currentShop = new ShopRuntimeData(shopData);
            currentShop.RefreshStock(); 
            traderRuntimeData[traderID] = currentShop;
        }

        int currentDay = WorldTimeSystem.Instance.CurrentDay;
        if (currentShop.BaseData.refreshIntervalDays > 0 &&
            currentDay >= currentShop.LastRefreshDay + currentShop.BaseData.refreshIntervalDays)
        {
            Debug.Log($"[ShopManager] 商人 '{traderID}' 的庫存已過期，正在刷新...");
            currentShop.RefreshStock();
        }
        dialogueSegmentToContinue = continueSegmentID;
        shopUI.Show(currentShop);
    }

    public void CloseShop()
    {
        if (shopUI != null) shopUI.Hide();
        
        if (!string.IsNullOrEmpty(dialogueSegmentToContinue))
        {
            if (GameManager.Instance != null)
            {
                GameManager.Instance.SetGameState(GameState.InDialogue);
            }
            OnShopClosed?.Invoke(dialogueSegmentToContinue);
        }
        else
        {
            if (GameManager.Instance != null)
            {
                GameManager.Instance.SetGameState(GameState.Exploration);
            }
            DialogueManager.Instance.EndDialogue();
        }
        currentShop = null;
        currentTrader = null;
        dialogueSegmentToContinue = null;
    }
    
    private void HandleEscape()
    {
        if (GameManager.Instance != null && GameManager.Instance.CurrentGameState == GameState.InShop)
        {
            Debug.Log("[ShopManager] 透過 ESC 鍵關閉商店。");
            CloseShop();
        }
    }

    public bool BuyItem(Item itemToBuy, int quantity)
    {
        if (itemToBuy == null || quantity <= 0 || currentShop == null) return false;

        ShopItem shopItem = currentShop.CurrentStock.Find(si => si.item == itemToBuy);
        if (shopItem == null) { Debug.LogWarning($"商店不販賣 {itemToBuy.itemName}。"); return false; }
        if (shopItem.quantity != -1 && shopItem.quantity < quantity) { Debug.LogWarning($"商品 {itemToBuy.itemName} 庫存不足。"); return false; }

        int totalCost = itemToBuy.buyPrice * quantity;
        if (!PlayerState.Instance.SpendMoney(totalCost)) { Debug.LogWarning("金錢不足，無法購買。"); return false; }

        InventoryManager.TriggerAddItem(itemToBuy, quantity);
        if (shopItem.quantity != -1)
        {
            shopItem.quantity -= quantity;
        }
        currentShop.CurrentFund += totalCost;
        Debug.Log($"成功購買 {itemToBuy.itemName} x{quantity}, 花費 {totalCost} 元。");
        if (!isLoading) OnTransactionCompleted?.Invoke();
        return true;
    }

    public bool SellItem(InventorySlot playerSlot, int quantity)
    {
        if (playerSlot == null || playerSlot.IsEmpty() || quantity <= 0 || currentShop == null) return false;
        
        Item itemToSell = playerSlot.item;
        if (!itemToSell.canBeSold) { Debug.LogWarning($"物品 {itemToSell.itemName} 不可販賣。"); return false; }
        
        int totalValue = itemToSell.sellPrice * quantity;
        if(currentShop.CurrentFund < totalValue) { Debug.LogWarning($"商人資金不足，無法收購。"); return false; }

        bool removed = InventoryManager.Instance.RemoveItemFromSlot(playerSlot, quantity);
        if (!removed) { Debug.LogError("從玩家背包移除物品失敗，交易取消。"); return false; }
        
        PlayerState.Instance.AddMoney(totalValue);
        currentShop.CurrentFund -= totalValue;

        ShopItem shopItem = currentShop.CurrentStock.Find(si => si.item == itemToSell);
        if (shopItem != null) 
        {
            if (shopItem.quantity != -1) shopItem.quantity += quantity;
        }
        else
        {
            currentShop.CurrentStock.Add(new ShopItem { item = itemToSell, quantity = quantity });
        }
        Debug.Log($"成功販賣 {itemToSell.itemName} x{quantity}, 獲得 {totalValue} 元。");
        if (!isLoading) OnTransactionCompleted?.Invoke();
        return true;
    }
    #endregion

    #region 存檔資料
    public void PopulateSaveData(GameSaveData data)
    {
        data.shopManagerData.traderData.Clear();

        foreach (var pair in traderRuntimeData)
        {
            var stockToSave = pair.Value.CurrentStock
                .Select(si => new ShopItemForSave { itemID = si.item.uniqueItemID, quantity = si.quantity })
                .ToList();

            var runtimeData = new ShopRuntimeDataForSave
            {
                traderNpcID = pair.Key, 
                currentFund = pair.Value.CurrentFund,
                currentStock = stockToSave,
                lastRefreshDay = pair.Value.LastRefreshDay
            };
            data.shopManagerData.traderData.Add(runtimeData);
        }
    }

    public void LoadFromSaveData(GameSaveData data)
    {
        isLoading = true;
        traderRuntimeData.Clear();

        if (data.shopManagerData == null || data.shopManagerData.traderData == null)
        {
            isLoading = false;
            return;
        }
            
        foreach (var savedData in data.shopManagerData.traderData)
        {
            string npcID = savedData.traderNpcID;
            if (npcDatabase.TryGetValue(npcID, out NPC correspondingNpc))
            {
                ShopInventorySO shopTemplate = correspondingNpc.GetShopInventory();
                if (shopTemplate == null)
                {
                    Debug.LogWarning($"[ShopManager] 找到了 NPC '{npcID}'，但他沒有商店數據模板，無法恢復其商店狀態。");
                    continue;
                }
                ShopRuntimeData runtimeData = new ShopRuntimeData(shopTemplate);
                runtimeData.CurrentFund = savedData.currentFund;
                runtimeData.LastRefreshDay = savedData.lastRefreshDay;
                
                runtimeData.CurrentStock = savedData.currentStock
                    .Select(savedItem => {
                        Item itemTemplate = ItemDatabase.Instance.GetItemByID(savedItem.itemID);
                        if (itemTemplate != null)
                        {
                            return new ShopItem { item = itemTemplate, quantity = savedItem.quantity };
                        }
                        return null;
                    })
                    .Where(item => item != null)
                    .ToList();
                
                traderRuntimeData[npcID] = runtimeData;
            }
            else
            {
                Debug.LogWarning($"[ShopManager] 在存檔中發現了商人 '{npcID}' 的數據，但在當前場景中找不到對應的 NPC。");
            }
        }
        Debug.Log($"[ShopManager] 已從存檔中恢復了 {traderRuntimeData.Count} 個商人的數據。");
        isLoading = false;
    }
    #endregion
}
```

#### 3. `ShopUI.cs`
```csharp
using UnityEngine;
using UnityEngine.UI;
using TMPro;
using System.Collections.Generic;

public class ShopUI : MonoBehaviour
{
    [Header("主面板")]
    [SerializeField] private GameObject shopPanel;

    [Header("資訊顯示")]
    [SerializeField] private TextMeshProUGUI shopNameText;
    [SerializeField] private TextMeshProUGUI playerMoneyText;
    [SerializeField] private TextMeshProUGUI traderMoneyText;

    [Header("物品容器")]
    [SerializeField] private Transform shopSlotsContainer;
    [SerializeField] private Transform playerSlotsContainer;

    [Header("預製件 (Prefab)")]
    [SerializeField] private GameObject slotPrefab;
    
    [Header("UI 拖拽視覺效果")]
    [SerializeField] private Image draggedItemIcon;

    [Header("關聯面板")]
    [SerializeField] private TransactionUI transactionUI;
    [SerializeField] private ShopItemDetailsPanel shopItemDetailsPanel; 
    [SerializeField] private Button closeButton;

    private ShopRuntimeData currentShopData;
    private List<ShopSlotUI> shopSlotUIs = new List<ShopSlotUI>();
    private List<InventorySlotUI> playerSlotUIs = new List<InventorySlotUI>();

    public Image DraggedItemIcon => draggedItemIcon;

    void Awake()
    {
        if (ShopManager.Instance != null)
        {
            ShopManager.Instance.RegisterShopUI(this);
            ShopManager.Instance.OnTransactionCompleted += RefreshUI;
        }
        closeButton.onClick.AddListener(OnCloseButtonClicked);
    }
    
    void Start()
    {
        Hide();
        if(transactionUI) transactionUI.gameObject.SetActive(false);
        if(shopItemDetailsPanel) shopItemDetailsPanel.HideDetails();
        if(draggedItemIcon) draggedItemIcon.gameObject.SetActive(false);
    }

    void OnDestroy()
    {
        if (ShopManager.Instance != null)
        {
            ShopManager.Instance.OnTransactionCompleted -= RefreshUI;
        }
    }

    public void Show(ShopRuntimeData shopData)
    {
        currentShopData = shopData;
        shopPanel.SetActive(true);
        RefreshUI();
    }

    public void Hide()
    {
        shopPanel.SetActive(false);
        if(transactionUI) transactionUI.gameObject.SetActive(false);
        if(shopItemDetailsPanel) shopItemDetailsPanel.HideDetails();
        if(draggedItemIcon) draggedItemIcon.gameObject.SetActive(false);
    }

    public void RefreshUI()
    {
        if (!shopPanel.activeSelf || currentShopData == null) return;
        
        shopNameText.text = currentShopData.BaseData.shopName; 
        playerMoneyText.text = $"你的金錢: {PlayerState.Instance.GetCurrentMoney():N0} G";
        traderMoneyText.text = $"商店資金: {currentShopData.CurrentFund:N0} G";

        if (traderMoneyText != null) 
        {
            traderMoneyText.text = $"商店資金: {currentShopData.CurrentFund:N0} G";
        }

        RenderSlots(shopSlotsContainer, currentShopData.CurrentStock);
        RenderSlots(playerSlotsContainer, InventoryManager.Instance.playerInventoryData.slots);
    }

    private void RenderSlots(Transform container, object itemSource)
    {
        foreach (Transform child in container) { Destroy(child.gameObject); }

        if (itemSource is List<ShopItem> shopItems)
        {
            shopSlotUIs.Clear();
            foreach (var shopItem in shopItems)
            {
                if(shopItem.quantity == 0) continue;

                GameObject slotGO = Instantiate(slotPrefab, container);
                var slotUI = slotGO.GetComponent<ShopSlotUI>();
                slotUI.Initialize(this, ShopSlotUI.SlotType.Shop); 
                slotUI.DisplayShopItem(shopItem);
                shopSlotUIs.Add(slotUI);
            }
        }
        else if (itemSource is List<InventorySlot> playerSlots)
        {
            foreach (var playerSlot in playerSlots)
            {
                if (playerSlot.IsEmpty()) continue;

                GameObject slotGO = Instantiate(slotPrefab, container);
                var slotUI = slotGO.GetComponent<ShopSlotUI>();
                slotUI.Initialize(this, ShopSlotUI.SlotType.Player); 
                slotUI.DisplayPlayerItem(playerSlot);
            }
        }
    }

    public void RequestTransaction(ShopSlotUI slot)
    {
        if (slot.DisplayedItem == null || currentShopData == null) return;
        
        if (slot.CurrentSlotType == ShopSlotUI.SlotType.Shop)
        {
            int maxCanBuyByMoney = slot.DisplayedItem.buyPrice > 0 ? PlayerState.Instance.GetCurrentMoney() / slot.DisplayedItem.buyPrice : int.MaxValue;
            int maxQuantity = slot.ShopItemStock.quantity == -1 ? maxCanBuyByMoney : Mathf.Min(maxCanBuyByMoney, slot.ShopItemStock.quantity);
            if (maxQuantity > 0)
            {
                transactionUI.Show(slot.DisplayedItem, TransactionUI.TransactionType.Buy, maxQuantity);
            }
        }
        else
        {
            if(slot.PlayerInventorySlot.item.canBeSold)
            {
                int maxCanSellByFund = slot.DisplayedItem.sellPrice > 0 ? currentShopData.CurrentFund / slot.DisplayedItem.sellPrice : int.MaxValue;
                int maxQuantity = Mathf.Min(slot.PlayerInventorySlot.quantity, maxCanSellByFund);

                if(maxQuantity > 0)
                {
                    transactionUI.Show(slot.PlayerInventorySlot.item, TransactionUI.TransactionType.Sell, maxQuantity, slot.PlayerInventorySlot);
                }
                else
                {
                    Debug.Log("商人沒錢了，無法向他出售物品。");
                }
            }
        }
    }

    public void ShowItemDetails(ShopSlotUI slot)
    {
        if (shopItemDetailsPanel == null) 
        {
            Debug.LogWarning("ShopUI 未指定 ShopItemDetailsPanel。");
            return;
        }

        if (slot.DisplayedItem != null)
        {
            shopItemDetailsPanel.ShowDetails(slot.DisplayedItem);
        }
        else
        {
            shopItemDetailsPanel.HideDetails();
        }
    }

    public void HandleDrop(ShopSlotUI sourceSlot)
    {
        bool onPlayerPanel = RectTransformUtility.RectangleContainsScreenPoint(playerSlotsContainer as RectTransform, Input.mousePosition);
        bool onShopPanel = RectTransformUtility.RectangleContainsScreenPoint(shopSlotsContainer as RectTransform, Input.mousePosition);
        
        if(sourceSlot.CurrentSlotType == ShopSlotUI.SlotType.Shop && onPlayerPanel)
        {
            Debug.Log("拖拽購買請求");
            RequestTransaction(sourceSlot);
        }
        else if(sourceSlot.CurrentSlotType == ShopSlotUI.SlotType.Player && onShopPanel)
        {
            Debug.Log("拖拽出售請求");
            RequestTransaction(sourceSlot);
        }
    }

    private void OnCloseButtonClicked()
    {
        ShopManager.Instance.CloseShop();
    }
}
```

#### 4. `ShopSlotUI.cs`
```csharp
using UnityEngine;
using UnityEngine.UI;
using TMPro;
using UnityEngine.EventSystems;

public class ShopSlotUI : MonoBehaviour, IPointerClickHandler, IBeginDragHandler, IDragHandler, IEndDragHandler
{
    public enum SlotType { Shop, Player }

    [Header("UI元件")]
    [SerializeField] private Image itemIcon;
    [SerializeField] private TextMeshProUGUI quantityText;
    [SerializeField] private TextMeshProUGUI priceText;
    [SerializeField] private CanvasGroup canvasGroup;

    public Item DisplayedItem { get; private set; }
    public ShopItem ShopItemStock { get; private set; }
    public InventorySlot PlayerInventorySlot { get; private set; }
    public SlotType CurrentSlotType { get; private set; }

    private ShopUI parentUI;

    private float lastClickTime = -1f;
    private const float doubleClickThreshold = 0.3f;

    public void Initialize(ShopUI ui, SlotType type)
    {
        parentUI = ui;
        CurrentSlotType = type;
        if(canvasGroup == null) canvasGroup = gameObject.AddComponent<CanvasGroup>();
    }

    public void DisplayShopItem(ShopItem shopItem)
    {
        ShopItemStock = shopItem;
        DisplayedItem = shopItem.item;
        PlayerInventorySlot = null;
        UpdateUI();
    }

    public void DisplayPlayerItem(InventorySlot playerSlot)
    {
        PlayerInventorySlot = playerSlot;
        DisplayedItem = playerSlot.item;
        ShopItemStock = null;
        UpdateUI();
    }

    private void UpdateUI()
    {
        if (DisplayedItem == null)
        {
            ClearUI();
            return;
        }
        itemIcon.sprite = DisplayedItem.icon;
        itemIcon.enabled = true;
        if (CurrentSlotType == SlotType.Shop)
        {
            string qtyStr = ShopItemStock.quantity == -1 ? "∞" : ShopItemStock.quantity.ToString();
            quantityText.text = qtyStr;
            quantityText.enabled = true;
            priceText.text = $"${DisplayedItem.buyPrice}";
            priceText.enabled = DisplayedItem.canBeBought;
        }
        else
        {
            quantityText.text = PlayerInventorySlot.quantity > 1 ? PlayerInventorySlot.quantity.ToString() : "";
            quantityText.enabled = PlayerInventorySlot.quantity > 1;
            priceText.text = DisplayedItem.canBeSold ? $"${DisplayedItem.sellPrice}" : "不可出售";
            priceText.enabled = true;
        }
    }

    private void ClearUI()
    {
        itemIcon.sprite = null;
        itemIcon.enabled = false;
        quantityText.text = "";
        priceText.text = "";
        DisplayedItem = null;
    }

    public void OnPointerClick(PointerEventData eventData)
    {
        if (DisplayedItem == null) return;
        if (Time.time - lastClickTime < doubleClickThreshold)
        {
            Debug.Log($"雙擊了 {DisplayedItem.itemName}");
            parentUI.RequestTransaction(this);
            lastClickTime = -1f;
        }
        else
        {
            lastClickTime = Time.time;
        }
        if (eventData.button == PointerEventData.InputButton.Left)
        {
            parentUI.ShowItemDetails(this);
        }
        else if (eventData.button == PointerEventData.InputButton.Right)
        {
            if (CurrentSlotType == SlotType.Shop)
            {
                ShopManager.Instance.BuyItem(DisplayedItem, 1);
            }
            else if (PlayerInventorySlot != null && !PlayerInventorySlot.IsEmpty())
            {
                ShopManager.Instance.SellItem(PlayerInventorySlot, 1);
            }
        }
    }

    public void OnBeginDrag(PointerEventData eventData)
    {
        if (DisplayedItem == null)
        {
            eventData.pointerDrag = null;
            return;
        }
        if (parentUI == null)
        {
            Debug.LogError("ShopSlotUI 的 parentUI 引用為空！拖拽無法執行。");
            eventData.pointerDrag = null;
            return;
        }
        if (parentUI.DraggedItemIcon == null)
        {
            Debug.LogError("ShopUI 上的 DraggedItemIcon 未在 Inspector 中指定！請檢查 ShopUI 的配置。");
            eventData.pointerDrag = null;
            return;
        }
        parentUI.DraggedItemIcon.sprite = DisplayedItem.icon;
        parentUI.DraggedItemIcon.gameObject.SetActive(true);
        parentUI.DraggedItemIcon.rectTransform.position = Input.mousePosition;
        canvasGroup.alpha = 0.5f;
        canvasGroup.blocksRaycasts = false;
    }

    public void OnDrag(PointerEventData eventData)
    {
        if (parentUI.DraggedItemIcon.gameObject.activeSelf)
        {
            parentUI.DraggedItemIcon.rectTransform.position = Input.mousePosition;
        }
    }

    public void OnEndDrag(PointerEventData eventData)
    {
        parentUI.DraggedItemIcon.gameObject.SetActive(false);
        canvasGroup.alpha = 1f;
        canvasGroup.blocksRaycasts = true;
        parentUI.HandleDrop(this);
    }
}
```

#### 5. `ShopItemDetailsPanel.cs`
```csharp
using UnityEngine;
using UnityEngine.UI;
using TMPro;

public class ShopItemDetailsPanel : MonoBehaviour
{
    [Header("UI References")]
    [SerializeField] private GameObject detailsPanel;
    [SerializeField] private Image itemIcon;
    [SerializeField] private TextMeshProUGUI itemNameText;
    [SerializeField] private TextMeshProUGUI itemDescriptionText;
    [SerializeField] private TextMeshProUGUI itemTypeText;
    [SerializeField] private Button closeButton;

    void Awake()
    {
        if (closeButton != null) closeButton.onClick.AddListener(HideDetails);
        HideDetails();
    }

    public void ShowDetails(Item item)
    {
        if (item == null)
        {
            HideDetails();
            return;
        }
        detailsPanel.SetActive(true);
        if (itemIcon != null)
        {
            itemIcon.sprite = item.icon;
            itemIcon.enabled = (item.icon != null);
        }
        if (itemNameText != null) itemNameText.text = item.itemName;
        if (itemDescriptionText != null) itemDescriptionText.text = item.description;
        if (itemTypeText != null) itemTypeText.text = $"類型: {item.itemType}";
    }

    public void HideDetails()
    {
        if(detailsPanel != null)
        {
            detailsPanel.SetActive(false);
        }
    }
}
```

#### 6. `TransactionUI.cs`
```csharp
using UnityEngine;
using UnityEngine.UI;
using TMPro;

public class TransactionUI : MonoBehaviour
{
    public enum TransactionType { Buy, Sell }

    [Header("UI 元件")]
    [SerializeField] private GameObject panel;
    [SerializeField] private TextMeshProUGUI titleText;
    [SerializeField] private TextMeshProUGUI itemNameText;
    [SerializeField] private Slider quantitySlider;
    [SerializeField] private TMP_InputField quantityInputField;
    [SerializeField] private TextMeshProUGUI totalPriceText;
    [SerializeField] private Button confirmButton;
    [SerializeField] private Button cancelButton;

    private Item targetItem;
    private InventorySlot targetPlayerSlot;
    private TransactionType currentType;
    private int currentQuantity;
    private int unitPrice;

    void Awake()
    {
        quantitySlider.onValueChanged.AddListener(OnSliderChanged);
        quantityInputField.onValueChanged.AddListener(OnInputChanged);
        confirmButton.onClick.AddListener(OnConfirm);
        cancelButton.onClick.AddListener(Hide);
    }

    public void Show(Item item, TransactionType type, int maxQuantity, InventorySlot playerSlot = null)
    {
        if (maxQuantity <= 0) return;
        targetItem = item;
        currentType = type;
        targetPlayerSlot = playerSlot;
        transform.SetAsLastSibling();
        panel.SetActive(true);
        titleText.text = (type == TransactionType.Buy) ? "購買物品" : "販賣物品";
        itemNameText.text = item.itemName;
        unitPrice = (type == TransactionType.Buy) ? item.buyPrice : item.sellPrice;
        
        quantitySlider.minValue = 1;
        quantitySlider.maxValue = maxQuantity;
        quantitySlider.value = 1;
        
        OnSliderChanged(1);
    }

    public void Hide()
    {
        panel.SetActive(false);
    }

    private void OnSliderChanged(float value)
    {
        currentQuantity = Mathf.RoundToInt(value);
        quantityInputField.text = currentQuantity.ToString();
        UpdateTotalPrice();
    }
    
    private void OnInputChanged(string value)
    {
        if (int.TryParse(value, out int inputQty))
        {
            inputQty = Mathf.Clamp(inputQty, (int)quantitySlider.minValue, (int)quantitySlider.maxValue);
            currentQuantity = inputQty;
            quantitySlider.value = currentQuantity;
        }
        UpdateTotalPrice();
    }

    private void UpdateTotalPrice()
    {
        totalPriceText.text = $"總價: {(currentQuantity * unitPrice):N0}";
    }

    private void OnConfirm()
    {
        if (currentType == TransactionType.Buy)
        {
            ShopManager.Instance.BuyItem(targetItem, currentQuantity);
        }
        else
        {
            ShopManager.Instance.SellItem(targetPlayerSlot, currentQuantity);
        }
        Hide();
    }
}
```