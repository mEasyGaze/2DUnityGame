#### **三、 對話系統模組 (Dialogue System Module)**

*   `DialogueData.cs`:
    *   職責：定義對話數據的 C# 類別結構。
    *   功能：`dialogues.xml` 的結構
        (1) `DialogueLine` (連續對話),`DialogueSegment` (對話片段), `DialogueOption` (選項), `DialogueBranch` (條件分支) 和 `DialogueAction` (動作)，是 XML 數據在內存中的體現。
        (2) `DynamicOptions` (動態選項請求) 和 `DialogueOptionTemplate` (選項範本) 的結構，使程式能理解 XML 中動態生成選項的指令。

*   `DialogueManager.cs`:
    *   職責：對話系統的大腦（單例），具備動態內容生成能力。
    *   功能：
        *   負責載入和快取 XML 對話檔案，並管理整個對話流程。
        *   動態選項生成：能夠解析 `<DynamicOptions>` 標籤，主動向 `QuestManager` 等其他系統查詢數據（如可接任務列表），並根據查詢結果和範本 (`OptionTemplate`) 即時創建對話選項。
        *   當遇到被標記為 `IsEnd` 且沒有任何可用選項的對話片段時，會自動生成一個 `[離開]` 按鈕，防止遊戲流程卡死。
        *   追蹤互動對象：能記錄當前是哪個 `NPC` 觸發了對話，以便精準地處理針對該 NPC 的動態選項請求。
        *   對話流程控制：根據 `DialogueTrigger` 或 `NPC` 的請求，啟動和管理整個對話流程。核心功能是解析 `DialogueBranch`，執行 `QuestManager` 的條件檢查，並根據結果觸發對應的 `DialogueAction`（如跳轉片段、結束對話、啟動新對話模組）。

*   `DialogueUI.cs`:
    *   職責：對話的視覺界面。
    *   功能：
        *   接收 `DialogueManager` 的指令，顯示說話人姓名、對話文本，並動態生成選項按鈕。能夠完美展示由 `DialogueManager` 靜態或動態生成的任何選項列表。
        *   增加一個「繼續提示」UI元素（如下箭頭），並提供方法來控制其顯示/隱藏。

---

### 第 3 部分：對話系統模組

#### 3.1. `DialogueData.cs`
```csharp
using System.Collections.Generic;
using System.Xml.Serialization;
using UnityEngine;

#region Enums
public enum DialogueActionType { Unknown, GoToSegment, EndDialogue, StartDialogue, AcceptQuest, CompleteQuest, AddItem, RemoveItem, AddMoney, AdvanceQuestObjective, AddPartyMember, RemovePartyMember, OpenShop, TriggerGameEvent, StartStoryScene, ContinueDialogue, CloseDialogue, StartBattle }
public enum DialogueConditionType { Unknown, QuestStatus, HasItem, QuestAvailable, QuestCheck, HasPartyMember, IsTrader, GameEventTriggered }
public enum DialogueCheckType { Unknown, QuestCheck, HasItem, QuestStatus, GameEventTriggered }
public enum DynamicOptionSource { Unknown, QuestManager }
public enum DynamicOptionType { Unknown, AvailableQuests, InProgressOrCompletableQuests }
#endregion

#region 連續對話
[System.Serializable]
public class DialogueLine
{
    [XmlElement("Speaker")]
    public string speaker;
    [XmlElement("Text")]
    public string text;
}
#endregion

#region 對話片段
[System.Serializable]
public class DialogueSegment
{
    [XmlAttribute("id")]
    public string id;

    [XmlElement("Speaker")]
    public string speakerName;
    [XmlElement("Text")]
    public string dialogueText;
    [XmlArray("DialogueChain")]
    [XmlArrayItem("Line")]
    public List<DialogueLine> dialogueChain = new List<DialogueLine>();
    [XmlArray("Actions")]
    [XmlArrayItem("Action")]
    public List<DialogueAction> actions = new List<DialogueAction>();
    [XmlElement("IsEnd")]
    public bool isEnd = false;
    [XmlElement("IsContinue")]
    public bool isContinue = false;
    [XmlElement("IsClose")]
    public bool isClose = false;

    [XmlArray("Options")]
    [XmlArrayItem("Option")]
    public List<DialogueOption> options = new List<DialogueOption>();
    [XmlElement("DynamicOptions")]
    public List<DynamicOptions> dynamicOptions = new List<DynamicOptions>();
    [XmlElement("Branch")]
    public DialogueBranch branch;
}
#endregion

#region 玩家選項
[System.Serializable]
public class DialogueOption
{
    [XmlElement("Text")]
    public string text;
    [XmlElement("Condition")]
    public List<DialogueCondition> displayConditions = new List<DialogueCondition>();
    [XmlElement("Action")]
    public List<DialogueAction> actions = new List<DialogueAction>();
    [XmlElement("Branch")]
    public DialogueBranch branch;
}
#endregion

#region 動態選項範本
[System.Serializable]
public class DialogueOptionTemplate
{
    [XmlAttribute("text")]
    public string text;
    [XmlElement("Action")]
    public List<DialogueAction> actions = new List<DialogueAction>();
    [XmlElement("Branch")]
    public DialogueBranch branch;
}
#endregion

#region 動態生成請求
[System.Serializable]
public class DynamicOptions
{
    [XmlAttribute("source")]
    public string source;
    [XmlAttribute("type")]
    public string type;
    [XmlAttribute("npcID")]
    public string npcID;
    [XmlAttribute("exclude")]
    public string excludeIDs;
    [XmlElement("OptionTemplate")]
    public DialogueOptionTemplate optionTemplate;

    [XmlIgnore]
    public DynamicOptionSource SourceType
    {
        get
        {
            if (System.Enum.TryParse(source, true, out DynamicOptionSource result))
            {
                return result;
            }
            if (!string.IsNullOrEmpty(source))
            {
                Debug.LogWarning($"[DialogueData] 未知的 DynamicOptions source: '{source}'");
            }
            return DynamicOptionSource.Unknown;
        }
    }
    
    [XmlIgnore]
    public DynamicOptionType RequestType
    {
        get
        {
            if (System.Enum.TryParse(type, true, out DynamicOptionType result))
            {
                return result;
            }
            if (!string.IsNullOrEmpty(type))
            {
                Debug.LogWarning($"[DialogueData] 未知的 DynamicOptions type: '{type}'");
            }
            return DynamicOptionType.Unknown;
        }
    }
}
#endregion

#region 條件/動作基底類別
[System.Serializable]
public class BaseDialogueAction
{
    [XmlAttribute("type")]
    public string type;
    [XmlAttribute("value")]
    public string value;
}
#endregion

#region 具體條件與動作
[System.Serializable]
public class DialogueCondition : BaseDialogueAction
{
    [XmlIgnore]
    public DialogueConditionType ConditionType
    {
        get
        {
            if (System.Enum.TryParse(type, true, out DialogueConditionType result))
            {
                return result;
            }
            if (!string.IsNullOrEmpty(type))
            {
                Debug.LogWarning($"[DialogueData] 未知的 DialogueCondition type: '{type}'");
            }
            return DialogueConditionType.Unknown;
        }
    }    
}

[System.Serializable]
public class DialogueAction : BaseDialogueAction
{
    [XmlIgnore]
    public DialogueActionType ActionType
    {
        get
        {
            if (System.Enum.TryParse(type, true, out DialogueActionType result))
            {
                return result;
            }
            if (!string.IsNullOrEmpty(type)) 
            {
                Debug.LogWarning($"[DialogueData] 未知的 DialogueAction type: '{type}'");
            }
            return DialogueActionType.Unknown;
        }
    }
}
#endregion

#region 完整對話
[System.Serializable]
public class Dialogue
{
    [XmlAttribute("id")]
    public string dialogueID;
    [XmlElement("Segment")]
    public List<DialogueSegment> segments = new List<DialogueSegment>();
}
#endregion

#region 對話資料庫
[XmlRoot("DialogueDatabase")]
public class DialogueDatabase
{
    [XmlElement("Dialogue")]
    public List<Dialogue> dialogues = new List<Dialogue>();
}
#endregion

#region 分支邏輯
[System.Serializable]
public class DialogueCheck
{
    [XmlAttribute("type")]
    public string type;
    [XmlAttribute("value")]
    public string value;

    [XmlIgnore]
    public DialogueCheckType CheckType
    {
        get
        {
            if (System.Enum.TryParse(type, true, out DialogueCheckType result))
            {
                return result;
            }
            if (!string.IsNullOrEmpty(type))
            {
                Debug.LogWarning($"[DialogueData] 未知的 DialogueCheck type: '{type}'");
            }
            return DialogueCheckType.Unknown;
        }
    }
}

[System.Serializable]
public class DialogueBranch
{
    [XmlElement("Check")]
    public DialogueCheck check;
    [XmlArray("OnTrue")]
    [XmlArrayItem("Action")]
    public List<DialogueAction> trueActions = new List<DialogueAction>();
    [XmlArray("OnFalse")]
    [XmlArrayItem("Action")]
    public List<DialogueAction> falseActions = new List<DialogueAction>();
}
#endregion
```

#### 3.2. `DialogueManager.cs`
```csharp
using UnityEngine;
using System.Collections.Generic;
using System.IO;
using System.Xml.Serialization;
using System.Linq;
using System;

public class DialogueManager : MonoBehaviour
{
    public static DialogueManager Instance { get; private set; }
    public static event Action OnDialogueEnded;

    private DialogueUI dialogueUI;
    private Dictionary<string, DialogueDatabase> dialogueCache = new Dictionary<string, DialogueDatabase>();

    private Dialogue currentDialogue;
    private DialogueSegment currentSegment;
    private DialogueDatabase currentDialogueDB;
    private string currentNpcID;

    private List<DialogueLine> _activeChain;
    private bool isInChainMode = false;
    private int currentChainIndex = -1;

    void Awake()
    {
        if (Instance == null)
        {
            Instance = this;
            DontDestroyOnLoad(gameObject);
        }
        else
        {
            Destroy(gameObject);
        }

        if (ShopManager.Instance != null)
        {
            ShopManager.Instance.OnShopClosed += ContinueDialogueAfterShop;
        }
    }

    void Update()
    {
        if (isInChainMode && Input.GetKeyDown(KeyCode.Space))
        {
            AdvanceDialogueChain();
        }
    }
    
    void OnDestroy()
    {
        if (ShopManager.Instance != null)
        {
            ShopManager.Instance.OnShopClosed -= ContinueDialogueAfterShop;
        }
    }

    #region UI 管理
    public void RegisterDialogueUI(DialogueUI ui)
    {
        if (this.dialogueUI != null)
        {
            Debug.LogWarning("[DialogueManager] 嘗試註冊新的 DialogueUI，但已有一個存在。舊的將被覆蓋。");
        }
        this.dialogueUI = ui;
        Debug.Log("[DialogueManager] DialogueUI 已成功註冊。");
    }

    public void UnregisterDialogueUI(DialogueUI ui)
    {
        if (this.dialogueUI == ui)
        {
            this.dialogueUI = null;
            Debug.Log("[DialogueManager] DialogueUI 已成功反註冊。");
        }
    }
    #endregion

    #region 公開的對話流程控制
    public void StartDialogue(string relativePath, string dialogueID, string npcID = null, string startSegmentID = null)
    {
        if (GameManager.Instance != null)
        {
            GameManager.Instance.SetGameState(GameState.InDialogue);
        }

        _activeChain = null;
        if (dialogueUI == null)
        {
            Debug.LogError("[DialogueManager] 無法開始對話，因為沒有 DialogueUI 被註冊！請檢查場景中是否存在 DialogueUI 物件。");
            return;
        }
        
        currentNpcID = npcID;
        currentDialogueDB = LoadAndCacheDialogueFile(relativePath);
        if (currentDialogueDB == null)
        {
            Debug.LogError($"[DialogueManager] 無法開始對話，因為檔案 '{relativePath}.xml' 載入失敗。");
            return;
        }

        currentDialogue = currentDialogueDB.dialogues.FirstOrDefault(d => d.dialogueID == dialogueID);
        if (currentDialogue != null && currentDialogue.segments.Count > 0)
        {
            string targetSegmentID = startSegmentID;
            if (string.IsNullOrEmpty(targetSegmentID))
            {
                targetSegmentID = currentDialogue.segments[0].id;
            }
            ShowSegment(targetSegmentID);
        }
        else
        {
            Debug.LogError($"[DialogueManager] 在檔案 '{relativePath}.xml' 中找不到對話ID '{dialogueID}' 或該對話沒有任何片段。");
        }
    }

    public void EndDialogue()
    {
        if (GameManager.Instance != null && GameManager.Instance.CurrentGameState == GameState.InDialogue)
        {
            GameManager.Instance.SetGameState(GameState.Exploration);
        }

        if (dialogueUI != null) dialogueUI.HideDialogue();
        currentDialogue = null;
        currentSegment = null;
        currentDialogueDB = null;
        currentNpcID = null;
        isInChainMode = false;
        _activeChain = null;

        Debug.Log("[DialogueManager] 對話結束，觸發 OnDialogueEnded 事件。");
        OnDialogueEnded?.Invoke();
    }

    public void AdvanceDialogueChain()
    {
        if (!isInChainMode || _activeChain == null) return;

        currentChainIndex++;

        if (currentChainIndex >= _activeChain.Count)
        {
            isInChainMode = false;
            _activeChain = null;
            dialogueUI.SetChainAdvanceActive(false);
            dialogueUI.HideContinuePrompt();

            ProcessActions(currentSegment.actions);

            if (currentDialogue != null)
            {
                ProcessOptionsForCurrentSegment();
            }
        }
        else
        {
            DialogueLine currentLine = _activeChain[currentChainIndex];
            dialogueUI.ShowDialogue(currentLine.speaker, currentLine.text);

            bool isLastLine = (currentChainIndex == _activeChain.Count - 1);
            if (isLastLine)
            {
                ProcessActions(currentSegment.actions);
                
                List<DialogueOption> availableOptions = GenerateAvailableOptionsForCurrentSegment();

                if (availableOptions.Count > 0)
                {
                    dialogueUI.ShowOptions(availableOptions, OnOptionSelected);
                    isInChainMode = false;
                    _activeChain = null;
                    dialogueUI.SetChainAdvanceActive(false);
                    dialogueUI.HideContinuePrompt();
                }
                else
                {
                    dialogueUI.ShowContinuePrompt();
                }
            }
            else
            {
                dialogueUI.ShowContinuePrompt();
            }
        }
    }
    #endregion

    #region 內部對話處理流程
    private void ShowSegment(string segmentID)
    {
        currentSegment = currentDialogue.segments.FirstOrDefault(s => s.id == segmentID);
        if (currentSegment == null)
        {
            Debug.LogWarning($"[DialogueManager] 在當前對話中找不到片段ID '{segmentID}'。結束對話。");
            EndDialogue();
            return;
        }

        if (currentSegment.branch != null && string.IsNullOrEmpty(currentSegment.dialogueText) && currentSegment.dialogueChain.Count == 0)
        {
            Debug.Log($"[DialogueManager] 檢測到純邏輯 Segment '{segmentID}'，立即處理其 Branch。");
            ProcessBranch(currentSegment.branch);
            return;
        }

        var effectiveDialogueChain = new List<DialogueLine>();
        if (!string.IsNullOrEmpty(currentSegment.dialogueText))
        {
            effectiveDialogueChain.Add(new DialogueLine
            {
                speaker = string.IsNullOrEmpty(currentSegment.speakerName) ? "旁白" : currentSegment.speakerName,
                text = currentSegment.dialogueText
            });
        }
        if (currentSegment.dialogueChain != null && currentSegment.dialogueChain.Count > 0)
        {
            effectiveDialogueChain.AddRange(currentSegment.dialogueChain);
        }

        if (effectiveDialogueChain.Count > 0)
        {
            _activeChain = effectiveDialogueChain;
            isInChainMode = true;
            currentChainIndex = -1;
            dialogueUI.SetChainAdvanceActive(true);
            AdvanceDialogueChain();
        }
        else
        {
            dialogueUI.ShowDialogue("", "");
            ProcessActions(currentSegment.actions);
            ProcessOptionsForCurrentSegment();
        }
    }
    
    private void ProcessOptionsForCurrentSegment()
    {
        dialogueUI.HideContinuePrompt();
        List<DialogueOption> availableOptions = GenerateAvailableOptionsForCurrentSegment();
        
        if (availableOptions.Count > 0)
        {
            dialogueUI.ShowOptions(availableOptions, OnOptionSelected);
        }
    }
    
    private void OnOptionSelected(DialogueOption option)
    {
        if (option.branch != null && option.branch.check != null)
        {
            ProcessBranch(option.branch);
        }
        else
        {
            ProcessActions(option.actions);
        }
    }

    private void ProcessBranch(DialogueBranch branch)
    {
        Debug.Log($"[DialogueManager] 正在處理 Branch。檢查類型: {branch.check?.type}, 值: {branch.check?.value}");
        bool result = ExecuteCheck(branch.check);
        ProcessActions(result ? branch.trueActions : branch.falseActions);
    }

    private void ProcessActions(List<DialogueAction> actions)
    {
        foreach (var action in actions)
        {
            ExecuteSingleAction(action);
        }

        var goToSegmentAction = actions.FirstOrDefault(a => a.ActionType == DialogueActionType.GoToSegment);
        if (goToSegmentAction != null)
        {
            ShowSegment(goToSegmentAction.value);
            return;
        }
        
        var startBattleAction = actions.FirstOrDefault(a => a.ActionType == DialogueActionType.StartBattle);
        if (startBattleAction != null)
        {
            EndDialogue();
            return;
        }
        
        var endDialogueAction = actions.FirstOrDefault(a => 
            a.ActionType == DialogueActionType.EndDialogue ||
            a.ActionType == DialogueActionType.ContinueDialogue ||
            a.ActionType == DialogueActionType.CloseDialogue);
        if (endDialogueAction != null)
        {
            EndDialogue();
            return;
        }
        
        var startDialogueAction = actions.FirstOrDefault(a => a.ActionType == DialogueActionType.StartDialogue);
        if (startDialogueAction != null)
        {
            string[] dialogueParts = startDialogueAction.value.Split(',');
            if (dialogueParts.Length == 2)
            {
                string newRelativePath = dialogueParts[0].Trim();
                string newDialogueID = dialogueParts[1].Trim();
                string startSegmentID = goToSegmentAction?.value;
                StartDialogue(newRelativePath, newDialogueID, this.currentNpcID, startSegmentID);
            }
            else
            {
                Debug.LogError($"[DialogueManager] StartDialogue 動作的格式錯誤: '{startDialogueAction.value}'。應為 'filePath,dialogueID'。");
            }
            return;
        }
    }
    
    private void ExecuteSingleAction(DialogueAction action)
    {
        switch (action.ActionType)
        {
            case DialogueActionType.AcceptQuest:
                QuestManager.Instance.AcceptQuest(action.value);
                break;

            case DialogueActionType.CompleteQuest:
                QuestManager.Instance.CompleteQuest(action.value);
                break;

            case DialogueActionType.AdvanceQuestObjective:
                {
                    string[] partsObjective = action.value.Split(',');
                    if (partsObjective.Length >= 2)
                    {
                        string questID = partsObjective[0].Trim();
                        string objectiveTargetID = partsObjective[1].Trim();
                        int.TryParse(partsObjective.Length > 2 ? partsObjective[2].Trim() : "1", out int amount);
                        QuestManager.Instance.AdvanceObjective(questID, objectiveTargetID, QuestObjectiveType.Talk, amount);
                    }
                    break;
                }

            case DialogueActionType.AddPartyMember:
                PartyManager.Instance?.AddMemberToHolder(action.value);
                break;

            case DialogueActionType.RemovePartyMember:
                PartyManager.Instance?.RemoveMemberCompletely(action.value);
                break;

            case DialogueActionType.AddItem:
                {
                    string[] partsAdd = action.value.Split(',');
                    Item itemToAdd = ItemDatabase.Instance.GetItemByID(partsAdd[0].Trim());
                    if (itemToAdd != null)
                    {
                        int.TryParse(partsAdd.Length > 1 ? partsAdd[1].Trim() : "1", out int amount);
                        InventoryManager.Instance.AddItem(itemToAdd, amount);
                    }
                    break;
                }

            case DialogueActionType.RemoveItem:
                {
                    string[] partsRemove = action.value.Split(',');
                    Item itemToRemove = ItemDatabase.Instance.GetItemByID(partsRemove[0].Trim());
                    if (itemToRemove != null)
                    {
                        int.TryParse(partsRemove.Length > 1 ? partsRemove[1].Trim() : "1", out int amount);
                        InventoryManager.Instance.RemoveItem(itemToRemove, amount);
                    }
                    break;
                }

            case DialogueActionType.AddMoney:
                {
                    if (int.TryParse(action.value, out int amount))
                    {
                        PlayerState.Instance?.AddMoney(amount);
                    }
                    break;
                }

            case DialogueActionType.OpenShop:
                {
                    var currentNPC = FindObjectsOfType<NPC>().FirstOrDefault(n => n.GetNpcID() == currentNpcID);
                    if (currentNPC != null && currentNPC.IsTrader())
                    {
                        dialogueUI?.HideDialogue();
                        ShopManager.Instance.OpenShop(currentNPC.GetShopInventory(), currentNPC, action.value);
                    }
                    break;
                }

            case DialogueActionType.TriggerGameEvent:
                GameEventManager.Instance?.TriggerEvent(action.value);
                break;

            case DialogueActionType.StartStoryScene:
                {
                    StorySceneData sceneToStart = Resources.Load<StorySceneData>($"GameData/StoryScenes/{action.value}");
                    if (sceneToStart != null)
                    {
                        GameEventManager.Instance?.TriggerEvent(sceneToStart.sceneID);
                        Debug.Log($"[DialogueManager] 觸發了劇情場景事件: {sceneToStart.sceneID}");
                    }
                    else
                    {
                        Debug.LogWarning($"[DialogueManager] 找不到 StorySceneData 於: GameData/StoryScenes/{action.value}");
                    }
                    break;
                }
            
            case DialogueActionType.StartBattle:
                GameObject triggerObject = GameObject.Find(action.value);
                if (triggerObject != null)
                {
                    BattleTrigger trigger = triggerObject.GetComponent<BattleTrigger>();
                    if (trigger != null)
                    {
                        Debug.Log($"[DialogueManager] 透過對話觸發了 BattleTrigger: {action.value}");
                        trigger.TriggerBattle();
                        // 觸發戰鬥後，通常需要結束當前對話
                        // EndDialogue();
                    }
                    else
                    {
                        Debug.LogError($"[DialogueManager] 找到了名為 '{action.value}' 的物件，但它上面沒有 BattleTrigger 腳本！");
                    }
                }
                else
                {
                    Debug.LogError($"[DialogueManager] 無法在場景中找到名為 '{action.value}' 的 BattleTrigger 物件！");
                }
                break;
        }
    }
    #endregion
    
    #region 資料處理與條件評估
    private DialogueDatabase LoadAndCacheDialogueFile(string relativePath)
    {
        if (dialogueCache.ContainsKey(relativePath))
        {
            return dialogueCache[relativePath];
        }

        string fullPath = $"GameData/Dialogues/{relativePath}";
        TextAsset xmlFile = Resources.Load<TextAsset>(fullPath);

        if (xmlFile == null)
        {
            Debug.LogError($"[DialogueManager] 找不到對話檔案於: Resources/{fullPath}.xml");
            return null;
        }

        XmlSerializer serializer = new XmlSerializer(typeof(DialogueDatabase));
        using (StringReader reader = new StringReader(xmlFile.text))
        {
            DialogueDatabase db = (DialogueDatabase)serializer.Deserialize(reader);
            dialogueCache[relativePath] = db; 
            Debug.Log($"[DialogueManager] 成功載入並快取對話檔案: {relativePath}.xml");
            return db;
        }
    }

    private List<DialogueOption> GenerateAvailableOptionsForCurrentSegment()
    {
        List<DialogueOption> availableOptions = new List<DialogueOption>();
        if (currentSegment == null) return availableOptions;

        foreach (var option in currentSegment.options)
        {
            if (CheckDisplayConditions(option.displayConditions))
            {
                availableOptions.Add(option);
            }
        }

        foreach (var dynamicRequest in currentSegment.dynamicOptions)
        {
            availableOptions.AddRange(GenerateDynamicOptions(dynamicRequest));
        }

        if (availableOptions.Count == 0)
        {
            if (currentSegment.isEnd)
            {
                availableOptions.Add(new DialogueOption
                {
                    text = "[離開]",
                    actions = new List<DialogueAction> { new DialogueAction { type = "EndDialogue" } }
                });
            }
            else if (currentSegment.isContinue)
            {
                availableOptions.Add(new DialogueOption
                {
                    text = "[繼續]",
                    actions = new List<DialogueAction> { new DialogueAction { type = "ContinueDialogue" } }
                });
            }
            else if (currentSegment.isClose)
            {
                availableOptions.Add(new DialogueOption
                {
                    text = "[關閉]",
                    actions = new List<DialogueAction> { new DialogueAction { type = "CloseDialogue" } }
                });
            }
        }
        return availableOptions;
    }

    private List<DialogueOption> GenerateDynamicOptions(DynamicOptions request)
    {
        List<DialogueOption> generated = new List<DialogueOption>();
        string targetNpcID = (request.npcID == "self" && !string.IsNullOrEmpty(currentNpcID)) ? currentNpcID : request.npcID;
        HashSet<string> exclusionSet = string.IsNullOrEmpty(request.excludeIDs) ? null : new HashSet<string>(request.excludeIDs.Split(',').Select(id => id.Trim()));

        if (request.SourceType == DynamicOptionSource.QuestManager)
        {
            List<Quest> quests = new List<Quest>();
            switch (request.RequestType)
            {
                case DynamicOptionType.AvailableQuests:
                    quests = QuestManager.Instance.GetAvailableQuestsForNPC(targetNpcID);
                    break;
                case DynamicOptionType.InProgressOrCompletableQuests:
                    quests = QuestManager.Instance.GetInProgressOrCompletableQuestsForNPC(targetNpcID);
                    break;
            }

            foreach (var quest in quests)
            {
                if (exclusionSet != null && exclusionSet.Contains(quest.questID)) continue;

                DialogueOption newOption = new DialogueOption
                {
                    text = request.optionTemplate.text.Replace("{questName}", quest.questName),
                    actions = request.optionTemplate.actions.Select(a => new DialogueAction { type = a.type, value = a.value.Replace("{questID}", quest.questID) }).ToList()
                };

                if (request.optionTemplate.branch != null)
                {
                    newOption.branch = new DialogueBranch
                    {
                        check = new DialogueCheck { type = request.optionTemplate.branch.check.type, value = request.optionTemplate.branch.check.value.Replace("{questID}", quest.questID) },
                        trueActions = request.optionTemplate.branch.trueActions.Select(a => new DialogueAction { type = a.type, value = a.value.Replace("{questID}", quest.questID) }).ToList(),
                        falseActions = request.optionTemplate.branch.falseActions.Select(a => new DialogueAction { type = a.type, value = a.value.Replace("{questID}", quest.questID) }).ToList()
                    };
                }
                generated.Add(newOption);
            }
        }
        return generated;
    }

    private bool ExecuteCheck(DialogueCheck check)
    {
        if (check == null) return false;
        string checkValue = check.value.Replace("self", currentNpcID);
        string[] parts = checkValue.Split(',');
        string id = parts.Length > 0 ? parts[0].Trim() : "";

        switch (check.CheckType)
        {
            case DialogueCheckType.QuestStatus:
                if (parts.Length < 2) return false;
                if (System.Enum.TryParse<Quest.QuestStatus>(parts[1].Trim(), true, out var status))
                {
                    return QuestManager.Instance.GetQuestStatus(id) == status;
                }
                return false;

            case DialogueCheckType.QuestCheck:
                if (parts.Length < 2) return false;
                string npcID = parts[1].Trim();
                switch (id)
                {
                    case "HasAvailableQuests": return QuestManager.Instance.HasAvailableQuests(npcID);
                    case "HasProgressOrCompletableQuests": return QuestManager.Instance.HasProgressOrCompletableQuests(npcID);
                    case "IsCompletable": return QuestManager.Instance.IsQuestCompletable(npcID); // 假設npcID參數是questID
                }
                return false;

            case DialogueCheckType.HasItem:
                if (parts.Length < 2 || !int.TryParse(parts[1].Trim(), out int requiredAmount)) return false;
                Item item = ItemDatabase.Instance.GetItemByID(id);
                return item != null && InventoryManager.Instance.HasItem(item, requiredAmount);

            case DialogueCheckType.GameEventTriggered:
                return GameEventManager.Instance.HasEventBeenTriggered(id);
        }
        return false;
    }

    private bool CheckDisplayConditions(List<DialogueCondition> conditions)
    {
        if (conditions == null || conditions.Count == 0) return true;

        foreach (var condition in conditions)
        {
            string[] parts = condition.value.Split(',');
            string id = parts[0];
            string value = parts.Length > 1 ? parts[1].Trim() : "";
            bool conditionMet = false;

            switch (condition.ConditionType)
            {
                case DialogueConditionType.QuestStatus:
                    if (System.Enum.TryParse<Quest.QuestStatus>(value, true, out var status))
                    {
                        conditionMet = QuestManager.Instance.GetQuestStatus(id) == status;
                    }
                    break;
                case DialogueConditionType.HasItem:
                    if (int.TryParse(value, out int requiredAmount))
                    {
                        Item item = ItemDatabase.Instance.GetItemByID(id);
                        conditionMet = item != null && InventoryManager.Instance.HasItem(item, requiredAmount);
                    }
                    break;
                case DialogueConditionType.QuestAvailable:
                    conditionMet = QuestManager.Instance.GetQuestStatus(id) == Quest.QuestStatus.NotStarted && QuestManager.Instance.ArePrerequisitesMet(id);
                    break;
                case DialogueConditionType.QuestCheck:
                    string npcIdToCheck = value.Replace("self", this.currentNpcID);
                    switch (id)
                    {
                        case "HasAvailableQuests": conditionMet = QuestManager.Instance.HasAvailableQuests(npcIdToCheck); break;
                        case "HasProgressOrCompletableQuests": conditionMet = QuestManager.Instance.HasProgressOrCompletableQuests(npcIdToCheck); break;
                    }
                    break;
                case DialogueConditionType.HasPartyMember:
                    conditionMet = PartyManager.Instance?.AllMembers.Any(m => m.memberDataSO_ID == id) ?? false;
                    break;
                case DialogueConditionType.IsTrader:
                    var npcToCheck = FindObjectsOfType<NPC>().FirstOrDefault(n => n.GetNpcID() == currentNpcID);
                    conditionMet = (npcToCheck != null && npcToCheck.IsTrader());
                    break;
                case DialogueConditionType.GameEventTriggered:
                    conditionMet = GameEventManager.Instance.HasEventBeenTriggered(id);
                    break;
            }
            if (!conditionMet) return false;
        }
        return true;
    }

    private void ContinueDialogueAfterShop(string segmentID)
    {
        if (currentDialogue == null) return;
        if (!string.IsNullOrEmpty(segmentID))
        {
            ShowSegment(segmentID);
        }
        else
        {
            EndDialogue();
        }
    }
    #endregion
}
```

#### 3.3. `DialogueUI.cs`
```csharp
using UnityEngine;
using UnityEngine.UI;
using TMPro;
using System.Collections.Generic;
using System;
using UnityEngine.EventSystems;

[RequireComponent(typeof(CanvasGroup))] 
public class DialogueUI : MonoBehaviour
{
    [Header("UI 元件")]
    [SerializeField] private GameObject dialoguePanel;
    [SerializeField] private TextMeshProUGUI speakerNameText;
    [SerializeField] private TextMeshProUGUI dialogueText;
    [SerializeField] private Transform optionsContainer;
    [SerializeField] private GameObject optionButtonPrefab;
    [SerializeField] private ScrollRect optionsScrollRect;

    [Header("劇情對話元件")]
    [SerializeField] private GameObject continuePrompt;
    [SerializeField] private Button dialoguePanelButton;

    private CanvasGroup dialogueCanvasGroup;
    private List<GameObject> currentOptionButtons = new List<GameObject>();
    private List<Selectable> previouslyDisabledSelectables = new List<Selectable>();

    private RectTransform optionsContainerRect;
    private RectTransform scrollRectViewport;

    void Awake()
    {
        dialogueCanvasGroup = GetComponent<CanvasGroup>(); // 獲取 CanvasGroup
        if (optionsContainer != null) optionsContainerRect = optionsContainer.GetComponent<RectTransform>();
        if (optionsScrollRect != null) scrollRectViewport = optionsScrollRect.viewport;

        if (DialogueManager.Instance != null)
        {
            DialogueManager.Instance.RegisterDialogueUI(this);
            if (dialoguePanelButton != null)
            {
                dialoguePanelButton.onClick.AddListener(() => DialogueManager.Instance.AdvanceDialogueChain());
            }
        }
        else
        {
            Debug.LogError("[DialogueUI] 找不到 DialogueManager 的實例來進行註冊！");
        }

        if (dialoguePanel != null)
        {
            dialoguePanel.SetActive(false);
        }
    }

    private void Update()
    {
        HandleAutoScrolling();
    }

    void OnDestroy()
    {
        if (DialogueManager.Instance != null)
        {
            DialogueManager.Instance.UnregisterDialogueUI(this);
        }
    }

    public void ShowDialogue(string speakerName, string text)
    {
        dialoguePanel.SetActive(true);
        speakerNameText.text = speakerName;
        dialogueText.text = text;
        ClearOptions();
        
        SetChainAdvanceActive(true);
    }

    public void ShowOptions(List<DialogueOption> options, Action<DialogueOption> onOptionSelectedCallback)
    {
        ClearOptions();
        SetChainAdvanceActive(false);
        DisableOtherSelectables();

        for (int i = 0; i < options.Count; i++)
        {
            GameObject buttonGO = Instantiate(optionButtonPrefab, optionsContainer);
            buttonGO.GetComponentInChildren<TextMeshProUGUI>().text = options[i].text;
            
            Button button = buttonGO.GetComponent<Button>();
            DialogueOption currentOption = options[i];
            button.onClick.AddListener(() => {
                onOptionSelectedCallback?.Invoke(currentOption);
            });
            
            currentOptionButtons.Add(buttonGO);
        }
        
        SetupButtonNavigation();

        if (currentOptionButtons.Count > 0)
        {
            if (EventSystem.current != null)
            {
                EventSystem.current.SetSelectedGameObject(currentOptionButtons[0]);
            }
        }
    }

    public void HideDialogue()
    {
        dialoguePanel.SetActive(false);
        ClearOptions();
        HideContinuePrompt();
    }

    private void ClearOptions()
    {
        if (EventSystem.current != null)
        {
            EventSystem.current.SetSelectedGameObject(null);
        }
        
        foreach (var button in currentOptionButtons)
        {
            Destroy(button);
        }
        currentOptionButtons.Clear();
        EnableOtherSelectables();
    }

    private void HandleAutoScrolling()
    {
        if (!dialoguePanel.activeSelf || currentOptionButtons.Count == 0 || EventSystem.current == null) return;
        
        GameObject selectedObject = EventSystem.current.currentSelectedGameObject;
        if (selectedObject == null || selectedObject.transform.parent != optionsContainer)
        {
            return;
        }
        if (optionsScrollRect == null) return;

        RectTransform selectedRect = selectedObject.GetComponent<RectTransform>();
        
        Vector3 selectedBottomInViewport = scrollRectViewport.InverseTransformPoint(selectedRect.TransformPoint(new Vector3(0, selectedRect.rect.yMin, 0)));
        Vector3 selectedTopInViewport = scrollRectViewport.InverseTransformPoint(selectedRect.TransformPoint(new Vector3(0, selectedRect.rect.yMax, 0)));
        
        float viewportHeight = scrollRectViewport.rect.height;

        if (selectedTopInViewport.y > 0)
        {
            optionsContainerRect.anchoredPosition -= new Vector2(0, selectedTopInViewport.y);
        }
        else if (selectedBottomInViewport.y < -viewportHeight)
        {
            optionsContainerRect.anchoredPosition -= new Vector2(0, selectedBottomInViewport.y + viewportHeight);
        }
    }
    
    private void SetupButtonNavigation()
    {
        for (int i = 0; i < currentOptionButtons.Count; i++)
        {
            Button button = currentOptionButtons[i].GetComponent<Button>();
            Navigation nav = button.navigation;
            nav.mode = Navigation.Mode.Explicit;
            nav.selectOnUp = currentOptionButtons[(i - 1 + currentOptionButtons.Count) % currentOptionButtons.Count].GetComponent<Selectable>();
            nav.selectOnDown = currentOptionButtons[(i + 1) % currentOptionButtons.Count].GetComponent<Selectable>();
            
            button.navigation = nav;
        }
    }

    private void DisableOtherSelectables()
    {
        previouslyDisabledSelectables.Clear();
        foreach (var selectable in Selectable.allSelectablesArray)
        {
            bool isOutsideDialoguePanel = selectable.transform.IsChildOf(this.transform) == false;
            
            if (isOutsideDialoguePanel && selectable.interactable)
            {
                selectable.interactable = false;
                previouslyDisabledSelectables.Add(selectable);
            }
        }
    }

    private void EnableOtherSelectables()
    {
        foreach (var selectable in previouslyDisabledSelectables)
        {
            if (selectable != null)
            {
                selectable.interactable = true;
            }
        }
        previouslyDisabledSelectables.Clear();
    }

    public void ShowContinuePrompt()
    {
        if (continuePrompt != null) continuePrompt.SetActive(true);
    }
    
    public void HideContinuePrompt()
    {
        if (continuePrompt != null) continuePrompt.SetActive(false);
    }

    public void SetChainAdvanceActive(bool isActive)
    {
        if (dialogueCanvasGroup != null)
        {
            dialoguePanelButton.enabled = isActive;
            optionsScrollRect.enabled = !isActive;
        }
    }
}
```