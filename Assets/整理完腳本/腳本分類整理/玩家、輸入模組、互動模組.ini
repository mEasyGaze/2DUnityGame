### **各腳本功能簡介**

### **一、 **玩家、互動模組 (Player & Interaction Module)**

*   `Player.cs`(玩家控制器):
    (1) 被動移動：訂閱 InputManager 的 OnMove 事件，接收移動向量 Vector2，並基於 Rigidbody2D 執行物理移動。
    (2) 環境感知：通過 Collider2D 偵測並記錄周圍的可拾取物品 (`GroundItem`) 和可互動物件 (`IInteractable`)。
    (3) 事件響應：訂閱 InputManager 的 OnPickup 和 OnInteract 事件。當事件觸發時，執行 TryPickupItem() 和 TryInteract() 邏輯，找出範圍內最近的目標並與之互動。
    (4) 互動的標準合約：`IInteractable` 中只包含一個 `Interact()` 方法，任何實現了此接口的類（如 `NPC`, `DialogueTrigger`）都可以被 `Player` 識別並與之互動。

*   `PlayerState.cs`(玩家數據容器):
    (1) 儲存玩家的非背包數據（如 money、等級、經驗）。提供了增加和花費金錢的接口，是交易、任務獎勵等系統的數據基礎。

*   `PlayerStatusUI.cs`(玩家的數據的顯示器):
    (1) 訂閱 PlayerState 的事件，以顯示玩家的金錢、等級和經驗值等UI信息。

*   `NPC.cs`:
    (1) `IInteractable` 接口。
    (2) 基礎結構：npcID、任務列表(`availableQuestIDs`)、對話路徑名稱(如：`Resources/GameData/Dialogues/`)、對話入口ID(如：`NPCs/npc_mayor`)、是否為商人(isTrader)、商人庫存(ShopInventorySO)。
    (3) 對話觸發：當 Player 調用 `Interact()` 方法時，啟動 `DialogueManager` 觸發指定對話。
    (4) 傳遞身份：在觸發對話時，會將自己的 `npcID` 一併傳遞過去(實現精確的動態選項)。

*   `InteractionPrompt.cs`:
    (1) 個獨立的、可重用的提示圖組件。

*   `DialogueTrigger.cs`(對話觸發器):
    (1) `IInteractable` 接口。
    (2) 可以放置在任何物件上（如一個告示牌、一本書），當玩家與其互動時，觸發一段指定的對話。

*   `BattleTrigger.cs`(戰鬥觸發器):
    (1) 在非戰鬥場景中用於啟動戰鬥的「觸發器」，持有 BattleEncounterSO 的引用。

---

### **完整代碼**

### 第 1 部分：玩家、互動模組

#### 1.1. `Player.cs`
```csharp
using UnityEngine;
using System.Collections.Generic;
using System.Linq;

[RequireComponent(typeof(Rigidbody2D))]
[RequireComponent(typeof(Collider2D))]
public class Player : MonoBehaviour
{
    [Header("移動設定")]
    [SerializeField] private float moveSpeed = 5f;

    private Rigidbody2D rb;
    private Vector2 moveInput;

    private List<GroundItem> nearbyItems = new List<GroundItem>();
    private List<IInteractable> nearbyInteractables = new List<IInteractable>();

    [Header("隊伍初始設定")]
    [Tooltip("將定義玩家初始持有成員的 PartyDatabase 掛載於此。")]
    [SerializeField] private PartyDatabase initialMemberDatabase;
    private bool hasInitializedParty = false;
    private bool isSubscribed = false;

    void Awake()
    {
        rb = GetComponent<Rigidbody2D>();
    }

    void OnEnable()
    {
        TrySubscribeToInputEvents();
    }

    void OnDisable()
    {
        UnsubscribeFromInputEvents();
    }
    
    void Update()
    {
        if (!isSubscribed)
        {
            TrySubscribeToInputEvents();
        }
    }

    void Start()
    {
        InitializeStartingParty();
    }
    
    private void TrySubscribeToInputEvents()
    {
        if (InputManager.Instance != null && !isSubscribed)
        {
            Debug.Log("[Player.cs] 成功找到 InputManager，正在訂閱事件...");
            InputManager.Instance.OnMove += HandleMoveInput;
            InputManager.Instance.OnInteract += TryInteract;
            InputManager.Instance.OnPickup += TryPickupItem;
            isSubscribed = true;
        }
    }

    private void UnsubscribeFromInputEvents()
    {
        if (InputManager.Instance != null && isSubscribed)
        {
            Debug.Log("[Player.cs] 取消訂閱 InputManager 事件。");
            InputManager.Instance.OnMove -= HandleMoveInput;
            InputManager.Instance.OnInteract -= TryInteract;
            InputManager.Instance.OnPickup -= TryPickupItem;
            isSubscribed = false;
        }
    }

    private void HandleMoveInput(Vector2 input)
    {
        moveInput = input;
    }

    void FixedUpdate()
    {
        if (moveInput != Vector2.zero && ExplorationUIManager.Instance != null && ExplorationUIManager.Instance.IsProgressBarActive)
        {
            ExplorationUIManager.Instance.CancelCurrentProgress();
        }
        rb.MovePosition(rb.position + moveInput * moveSpeed * Time.fixedDeltaTime);
    }
    
    private void OnTriggerEnter2D(Collider2D other)
    {
        GroundItem item = other.GetComponent<GroundItem>();
        if (item != null && !nearbyItems.Contains(item))
        {
            nearbyItems.Add(item);
        }

        IInteractable interactable = other.GetComponent<IInteractable>();
        if (interactable != null && !nearbyInteractables.Contains(interactable))
        {
            nearbyInteractables.Add(interactable);
            Debug.Log($"[Player] 進入可互動物件 '{other.gameObject.name}' 的範圍。");
        }
    }

    private void OnTriggerExit2D(Collider2D other)
    {
        GroundItem item = other.GetComponent<GroundItem>();
        if (item != null)
        {
            nearbyItems.Remove(item);
        }
        
        IInteractable interactable = other.GetComponent<IInteractable>();
        if (interactable != null)
        {
            nearbyInteractables.Remove(interactable);
            Debug.Log($"[Player] 離開可互動物件 '{other.gameObject.name}' 的範圍。");
        }
    }

    public void TryPickupItem()
    {
        nearbyItems.RemoveAll(item => item == null);
        if (nearbyItems.Count == 0) return;

        GroundItem closestItem = nearbyItems.OrderBy(item => 
            Vector2.Distance(transform.position, item.transform.position)
        ).FirstOrDefault();

        closestItem?.AttemptPickup();
    }
    
    public void TryInteract()
    {
        nearbyInteractables.RemoveAll(i => i == null || (i as MonoBehaviour) == null);
        
        if (nearbyInteractables.Count == 0)
        {
            Debug.Log("[Player] 附近沒有可互動的物件。");
            return;
        }

        IInteractable closestInteractable = nearbyInteractables.OrderBy(i => 
            Vector2.Distance(transform.position, (i as MonoBehaviour).transform.position)
        ).FirstOrDefault();
        
        if (closestInteractable != null)
        {
            closestInteractable.Interact();
        }
    }

    private void InitializeStartingParty()
    {
        if (hasInitializedParty || PartyManager.Instance == null) return;

        if (initialMemberDatabase == null || initialMemberDatabase.allMembers == null)
        {
            Debug.LogWarning("Player 物件上未指定初始成員資料庫，不新增任何初始成員。");
            return;
        }
        
        if (PartyManager.Instance.AllMembers.Count > 0)
        {
            Debug.Log("偵測到玩家已有成員(可能為讀檔)，跳過初始成員新增程序。");
            hasInitializedParty = true;
            return;
        }

        Debug.Log("正在根據 Player 物件上的設定初始化玩家隊伍...");
        foreach (var memberData in initialMemberDatabase.allMembers)
        {
            if (memberData != null)
            {
                PartyManager.Instance.AddMemberToHolder(memberData.memberID);
            }
        }
        
        var initialBattleParty = PartyManager.Instance.AllMembers.Take(4).ToList();
        foreach (var member in initialBattleParty)
        {
            PartyManager.Instance.SetToBattleParty(member);
        }
        hasInitializedParty = true;
    }

    public void SetPosition(Vector3 position)
    {
        if (rb != null)
        {
            transform.position = position;
            rb.velocity = Vector2.zero;
        }
        else
        {
            transform.position = position;
        }
        Debug.Log($"玩家位置已還原至: {position}");
    }
}

public interface IInteractable
{
    void Interact();
}
```

#### 1.2. `PlayerState.cs`
```csharp
using UnityEngine;
using System;

public class PlayerState : MonoBehaviour, IGameSaveable
{
    public static PlayerState Instance { get; private set; }

    [Header("玩家狀態")]
    [SerializeField] private int money = 100;
    [SerializeField] private int level = 1;
    [SerializeField] private int currentExperience = 0;
    [SerializeField] private int experienceToNextLevel = 100;

    public static event Action<int> OnMoneyChanged;
    public static event Action<int> OnLevelChanged;
    public static event Action<int, int> OnExperienceChanged;
    
    private bool isLoading = false;

    void Awake()
    {
        if (Instance != null && Instance != this)
        {
            Destroy(gameObject);
            return;
        }
        Instance = this;
        DontDestroyOnLoad(gameObject);
        SaveManager.Instance.Register(this);
    }

    void OnDestroy()
    {
        if (SaveManager.Instance != null)
        {
            SaveManager.Instance.Unregister(this);
        }
    }

    void Start()
    {
        if (!isLoading)
        {
            OnMoneyChanged?.Invoke(money);
            OnLevelChanged?.Invoke(level);
            OnExperienceChanged?.Invoke(currentExperience, experienceToNextLevel);
        }
    }

    public void AddMoney(int amount)
    {
        if (amount <= 0) return;
        money += amount;
        Debug.Log($"[PlayerState] 獲得金錢：{amount}。目前總額：{money}");
        if (!isLoading) OnMoneyChanged?.Invoke(money);
    }

    public bool SpendMoney(int amount)
    {
        if (amount <= 0 || money < amount)
        {
            if (money < amount && amount > 0)
            {
                Debug.LogWarning($"[PlayerState] 金錢不足！需要 {amount}, 但只有 {money}。");
            }
            return false;
        }
        money -= amount;
        Debug.Log($"[PlayerState] 花費金錢：{amount}。目前餘額：{money}");
        if (!isLoading) OnMoneyChanged?.Invoke(money);
        return true;
    }

    public void GainExperience(int amount)
    {
        if (amount <= 0) return;
        currentExperience += amount;
        Debug.Log($"[PlayerState] 獲得經驗值：{amount}。目前經驗：{currentExperience}/{experienceToNextLevel}");
        while (currentExperience >= experienceToNextLevel)
        {
            currentExperience -= experienceToNextLevel;
            LevelUp();
        }
        if (!isLoading) OnExperienceChanged?.Invoke(currentExperience, experienceToNextLevel);
    }

    private void LevelUp()
    {
        level++;
        experienceToNextLevel += 50; 
        Debug.LogWarning($"[PlayerState] 等級提升！目前等級: {level}");
        if (!isLoading) OnLevelChanged?.Invoke(level); 
        if (!isLoading) OnExperienceChanged?.Invoke(currentExperience, experienceToNextLevel); 
    }

    public int GetCurrentMoney() => money;
    public int GetCurrentLevel() => level;
    public int GetCurrentExperience() => currentExperience;
    public int GetExperienceToNextLevel() => experienceToNextLevel;
    
    #region 存檔資料
    public void PopulateSaveData(GameSaveData data)
    {
        data.playerStateData.money = this.money;
        data.playerStateData.level = this.level;
        data.playerStateData.currentExperience = this.currentExperience;
        data.playerStateData.experienceToNextLevel = this.experienceToNextLevel;
    }

    public void LoadFromSaveData(GameSaveData data)
    {
        isLoading = true;
        
        this.money = data.playerStateData.money;
        this.level = data.playerStateData.level;
        this.currentExperience = data.playerStateData.currentExperience;
        this.experienceToNextLevel = data.playerStateData.experienceToNextLevel;

        isLoading = false;
    }
    #endregion
}
```

#### 1.3. `PlayerStatusUI.cs`
```csharp
using UnityEngine;
using UnityEngine.UI;
using TMPro;

public class PlayerStatusUI : MonoBehaviour
{
    [Header("UI 元件連結")]
    [SerializeField] private TextMeshProUGUI moneyText;
    [SerializeField] private TextMeshProUGUI levelText;
    [SerializeField] private Slider experienceSlider;
    [SerializeField] private TextMeshProUGUI experienceText;

    void OnEnable()
    {
        PlayerState.OnMoneyChanged += UpdateMoneyText;
        PlayerState.OnLevelChanged += UpdateLevelText;
        PlayerState.OnExperienceChanged += UpdateExperienceUI;

        SaveManager.OnGameLoadComplete += RefreshAllStats;
        RefreshAllStats();
    }

    void OnDisable()
    {
        PlayerState.OnMoneyChanged -= UpdateMoneyText;
        PlayerState.OnLevelChanged -= UpdateLevelText;
        PlayerState.OnExperienceChanged -= UpdateExperienceUI;
        
        SaveManager.OnGameLoadComplete -= RefreshAllStats;
    }

    private void RefreshAllStats()
    {
        if (PlayerState.Instance != null)
        {
            UpdateMoneyText(PlayerState.Instance.GetCurrentMoney());
            UpdateLevelText(PlayerState.Instance.GetCurrentLevel());
            UpdateExperienceUI(PlayerState.Instance.GetCurrentExperience(), PlayerState.Instance.GetExperienceToNextLevel());
        }
    }

    private void UpdateMoneyText(int newMoneyValue)
    {
        if (moneyText != null)
        {
            moneyText.text = $"金錢：{newMoneyValue.ToString("N0")}";
        }
    }

    private void UpdateLevelText(int newLevelValue)
    {
        if (levelText != null)
        {
            levelText.text = $"Lv. {newLevelValue}";
        }
    }

    private void UpdateExperienceUI(int currentExp, int maxExp)
    {
        if (experienceSlider != null)
        {
            experienceSlider.value = (maxExp > 0) ? (float)currentExp / maxExp : 0;
        }

        if (experienceText != null)
        {
            experienceText.text = $"{currentExp} / {maxExp}";
        }
    }
}
```

#### 1.4. `NPC.cs`
```csharp
using UnityEngine;
using System.Collections.Generic;
using System.Linq;

[RequireComponent(typeof(Collider2D))]
public class NPC : MonoBehaviour, IInteractable
{
    [Header("NPC 資訊")]
    [Tooltip("唯一的 NPC ID，用於任務和對話系統的內部識別")]
    [SerializeField] private string npcID;
    
    [Header("任務設定")]
    [Tooltip("此 NPC 提供的所有任務 ID 列表")]
    [SerializeField] private List<string> availableQuestIDs = new List<string>();

    [Header("對話設定")]
    [Tooltip("此 NPC 的主要對話檔案路徑，相對於 'Resources/GameData/Dialogues/'。例如: 'NPCs/npc_mayor'")]
    [SerializeField] private string dialogueFileName;

    [Tooltip("與此 NPC 互動時的入口對話 ID")]
    [SerializeField] private string mainDialogueID;

    [Header("商店設定")]
    [Tooltip("勾選此項，將此 NPC 標記為商人。")]
    [SerializeField] private bool isTrader = false;
    [Tooltip("如果此 NPC 是商人，請指定其商店庫存 ScriptableObject。")]
    [SerializeField] private ShopInventorySO shopInventory;

    [Header("任務狀態圖標")]
    [Tooltip("有可接取任務時顯示的圖標 (!)")]
    [SerializeField] private GameObject availableQuestIcon;
    [Tooltip("有可交付任務時顯示的圖標 (?)")]
    [SerializeField] private GameObject completableQuestIcon;
    [Tooltip("有進行中的任務（但未完成）時顯示的圖標")]
    [SerializeField] private GameObject inProgressQuestIcon;

    private bool isPlayerInRange = false;

    private void Awake()
    {
        SetAllIconsActive(false);
        StartCoroutine(SubscribeToLoadEvent());
    }

    private System.Collections.IEnumerator SubscribeToLoadEvent()
    {
        yield return new WaitUntil(() => SaveManager.Instance != null);
        SaveManager.OnGameLoadComplete += RefreshIconsOnLoad;
    }

    private void OnEnable()
    {
        if (QuestManager.Instance != null)
        {
            QuestManager.Instance.OnQuestAccepted += OnQuestStateChanged;
            QuestManager.Instance.OnQuestCompleted += OnQuestStateChanged;
            QuestManager.Instance.OnQuestUpdated += OnQuestStateChanged;
        }
        UpdateQuestIcons();
    }

    private void OnDisable()
    {
        if (QuestManager.Instance != null)
        {
            QuestManager.Instance.OnQuestAccepted -= OnQuestStateChanged;
            QuestManager.Instance.OnQuestCompleted -= OnQuestStateChanged;
            QuestManager.Instance.OnQuestUpdated -= OnQuestStateChanged;
        }
        
        if (SaveManager.Instance != null)
        {
            SaveManager.OnGameLoadComplete -= RefreshIconsOnLoad;
        }
    }
    
    private void RefreshIconsOnLoad()
    {
        Debug.Log($"[NPC] 遊戲加載完成，正在為 {gameObject.name} 刷新任務圖標。");
        UpdateQuestIcons();
    }

    private void OnQuestStateChanged(string questID)
    {
        if (string.IsNullOrEmpty(questID))
        {
            UpdateQuestIcons();
            return;
        }
        
        Quest quest = QuestDatabase.GetQuest(questID);
        if (quest != null && (quest.giverNPCID == this.npcID || quest.handInNPCID == this.npcID))
        {
            if (gameObject.activeInHierarchy)
            {
                StartCoroutine(UpdateIconsNextFrame());
            }
        }
    }
    
    private System.Collections.IEnumerator UpdateIconsNextFrame()
    {
        yield return null;
        UpdateQuestIcons();
    }

    private void OnTriggerEnter2D(Collider2D other)
    {
        if (other.CompareTag("Player"))
        {
            isPlayerInRange = true;
            UpdateQuestIcons();
        }
    }

    private void OnTriggerExit2D(Collider2D other)
    {
        if (other.CompareTag("Player"))
        {
            isPlayerInRange = false;
            UpdateQuestIcons();
        }
    }

    private void UpdateQuestIcons()
    {
        if (availableQuestIcon == null && completableQuestIcon == null && inProgressQuestIcon == null) return;
        if (QuestManager.Instance == null) return;
        
        SetAllIconsActive(false);
        if (!isPlayerInRange) return;
        
        bool hasCompletable = false;
        bool hasInProgress = false;

        var relatedQuests = QuestManager.Instance.GetInProgressOrCompletableQuestsForNPC(npcID);
        
        if (relatedQuests.Any(q => QuestManager.Instance.IsQuestCompletable(q.questID)))
        {
            hasCompletable = true;
        }

        if (!hasCompletable && relatedQuests.Any())
        {
            hasInProgress = true;
        }

        if (hasCompletable)
        {
            if (completableQuestIcon != null) completableQuestIcon.SetActive(true);
        }
        else if (hasInProgress)
        {
            if (inProgressQuestIcon != null) inProgressQuestIcon.SetActive(true);
        }
        else if (availableQuestIcon != null && QuestManager.Instance.HasAvailableQuests(npcID))
        {
            availableQuestIcon.SetActive(true);
        }
    }
    
    private void SetAllIconsActive(bool isActive)
    {
        if (availableQuestIcon != null) availableQuestIcon.SetActive(isActive);
        if (completableQuestIcon != null) completableQuestIcon.SetActive(isActive);
        if (inProgressQuestIcon != null) inProgressQuestIcon.SetActive(isActive);
    }


    private void OnValidate()
    {
        Collider2D col = GetComponent<Collider2D>();
        if (col != null && !col.isTrigger)
        {
            col.isTrigger = true;
        }
    }

    public string GetNpcID() => npcID;
    public List<string> GetQuestList() => availableQuestIDs;
    public bool IsTrader() => isTrader;
    public ShopInventorySO GetShopInventory() => shopInventory;

    public void Interact()
    {
        Debug.Log($"[NPC] 與 {gameObject.name} (ID: {npcID}) 互動。");

        if (string.IsNullOrEmpty(dialogueFileName) || string.IsNullOrEmpty(mainDialogueID))
        {
            Debug.LogWarning($"[NPC] {gameObject.name} 未設定 dialogueFileName 或 mainDialogueID。");
            return;
        }
        QuestManager.Instance.SyncCollectionQuests();
        DialogueManager.Instance.StartDialogue(dialogueFileName, mainDialogueID, npcID);
    }
}
```

#### 1.5. `InteractionPrompt.cs`
```csharp
using UnityEngine;

[RequireComponent(typeof(Collider2D))]
public class InteractionPrompt : MonoBehaviour
{
    [Header("提示設定")]
    [Tooltip("要顯示的提示UI物件 (例如 'E' 鍵圖標的 Prefab)。")]
    [SerializeField] private GameObject promptVisual;

    [Tooltip("提示UI相對於此物件中心點的偏移量。")]
    [SerializeField] private Vector3 offset = new Vector3(0, 1.5f, 0);

    private GameObject promptInstance;
    private Transform playerTransform;

    void Awake()
    {
        if (promptVisual == null)
        {
            Debug.LogError($"在 '{gameObject.name}' 上的 InteractionPrompt 未指定 promptVisual！");
            this.enabled = false;
            return;
        }
        promptInstance = Instantiate(promptVisual, transform.position + offset, Quaternion.identity, this.transform);
        promptInstance.SetActive(false);
    }

    private void OnTriggerEnter2D(Collider2D other)
    {
        if (other.CompareTag("Player"))
        {
            if (promptInstance != null)
            {
                promptInstance.SetActive(true);
            }
        }
    }

    private void OnTriggerExit2D(Collider2D other)
    {
        if (other.CompareTag("Player"))
        {
            if (promptInstance != null)
            {
                promptInstance.SetActive(false);
            }
        }
    }

    // 可選：如果你希望提示圖標永遠朝向攝影機或玩家
    // void Update()
    // {
    //     if (promptInstance != null && promptInstance.activeSelf)
    //     {
    //         // 例如，使其不隨父物件旋轉
    //         promptInstance.transform.rotation = Quaternion.identity;
    //     }
    // }
}
```

#### 1.6. `DialogueTrigger.cs`
```csharp
using UnityEngine;

public class DialogueTrigger : MonoBehaviour, IInteractable
{
    [Header("對話設定")]
    [Tooltip("此對話所在的 XML 檔案名稱 (不需要輸入 .xml 副檔名)")]
    [SerializeField] private string dialogueFileName;

    [Tooltip("要觸發的對話 ID (對應 XML 檔案中的 <Dialogue> 標籤的 id)")]
    [SerializeField] private string dialogueID;
    
    public void Interact()
    {
        if (string.IsNullOrEmpty(dialogueFileName) || string.IsNullOrEmpty(dialogueID))
        {
            Debug.LogWarning($"[DialogueTrigger] {gameObject.name} 未在 Inspector 中設定 dialogueFileName 或 dialogueID。");
            return;
        }
        Debug.Log($"[DialogueTrigger] 觸發對話: 檔案 '{dialogueFileName}', ID '{dialogueID}'");
        DialogueManager.Instance.StartDialogue(dialogueFileName, dialogueID);
    }
}
```

#### 1.7. `BattleTrigger.cs`
```csharp
using UnityEngine;

[RequireComponent(typeof(Collider2D))]
[RequireComponent(typeof(UniqueObjectIdentifier))]
public class BattleTrigger : MonoBehaviour
{
    [SerializeField] private BattleEncounterSO battleEncounter;
    private UniqueObjectIdentifier uniqueID;

    private void Awake()
    {
        uniqueID = GetComponent<UniqueObjectIdentifier>();
        
        Collider2D col = GetComponent<Collider2D>();
        if (!col.isTrigger)
        {
            Debug.LogWarning($"物件 '{gameObject.name}' 上的 BattleTrigger2D 腳本需要其 Collider2D 設置為 'Is Trigger'，已自動為您設定。");
            col.isTrigger = true;
        }
    }

    private void OnTriggerEnter2D(Collider2D other)
    {
        if (other.CompareTag("Player"))
        {
            Debug.Log($"[BattleTrigger2D] 偵測到 Player '{other.name}' 進入範圍，準備觸發戰鬥！");
            GetComponent<Collider2D>().enabled = false;
            if (GameManager.Instance != null && battleEncounter != null)
            {
                string myID = uniqueID != null ? uniqueID.ID : null;
                GameManager.Instance.StartBattle(battleEncounter, myID);
            }
            else
            {
                Debug.LogError("[BattleTrigger2D] 無法觸發戰鬥！GameManager 或 BattleEncounterSO 未設定！");
            }
        }
    }
    
    public void TriggerBattle()
    {
        Debug.Log($"[BattleTrigger] 在 '{gameObject.name}' 上觸發戰鬥！");
        
        var collider = GetComponent<Collider2D>();
        if(collider != null) collider.enabled = false;
        if (GameManager.Instance != null && battleEncounter != null)
        {
            string myID = uniqueID != null ? uniqueID.ID : null;
            GameManager.Instance.StartBattle(battleEncounter, myID);
        }
        else
        {
            Debug.LogError($"[BattleTrigger] 在 '{gameObject.name}' 上無法觸發戰鬥！GameManager 或 BattleEncounterSO 未設定！");
        }
    }
}
```