#### **二、 物品與背包模組 (Item & Inventory Module)**

*   `Item.cs` (ScriptableObject):
    *   **職責**：定義單個物品的所有靜態數據。
    *   **功能**：作為物品的模板，包含名稱、描述、圖標、類型、堆疊上限、唯一ID (`uniqueItemID`) 和交易價格等。

*   `ItemDatabase.cs` (ScriptableObject):
    *   **職責**：所有物品的總資料庫。
    *   **功能**：存放遊戲中所有 `Item` ScriptableObject 的列表，並提供一個靜態方法 `GetItemByID()`，讓其他系統可以透過唯一ID快速查找物品數據。

*   `Inventory.cs` (ScriptableObject):
    *   **職責**：定義一個背包的數據結構。
    *   **功能**：包含背包的容量 (`capacity`) 和一個 `InventorySlot` 列表，用於實際儲存物品。允許多個不同背包的存在（如玩家背包、倉庫）。

*   `InventorySlot.cs`:
    *   **職責**：背包中的單個格子。
    *   **功能**：儲存一個 `Item` 的引用和其數量 (`quantity`)。封裝了添加、移除、清空和交換物品的核心邏輯。

*   `GroundItem.cs`:
    *   **職責**：代表掉落在地上的物品實體。
    *   **功能**：掛載在一個遊戲物件上，使其可被玩家拾取。包含 `Item` 數據和數量，並透過 `AttemptPickup()` 方法與 `InventoryManager` 互動。

*   `InventoryManager.cs`:
    *   **職責**：背包系統的總管（單例）。
    *   **功能**：管理玩家的 `Inventory` 數據。處理添加 (`AddItem`)、移除 (`RemoveItem`)、查詢 (`HasItem`) 物品的邏輯。與 `InventoryUI` 溝通以刷新界面，並在拋棄物品時生成 `GroundItem`。

*   `InventoryUI.cs` & `InventorySlotUI.cs`:
    *   **職責**：背包的視覺表現。
    *   **功能**：`InventoryUI` 根據 `Inventory` 數據動態生成 `InventorySlotUI` 列表。`InventorySlotUI` 負責顯示單個格子的圖標和數量。同時處理拖拽 (`ItemDragHandler`) 和點擊顯示詳情 (`ItemDetailsPanel`) 的交互。

*   `ItemDetailsPanel.cs` & `ItemDropUI.cs`:
    *   **職責**：物品的交互面板。
    *   **功能**：`ItemDetailsPanel` 顯示被點擊物品的詳細資訊，並提供使用/丟棄按鈕。`ItemDropUI` 在丟棄物品時彈出，讓玩家可以選擇丟棄的數量。

*   `ItemDragHandler.cs`:
    *   **職責**：處理背包格子內物品的拖拽邏輯。
    *   **功能**：實現 Unity 的拖拽接口 (`IBeginDragHandler` 等)，允許玩家在背包內移動或堆疊物品。

---

### 第 2 部分：物品與背包模組

#### 2.1. `Item.cs`
```csharp
using UnityEngine;
using System;
public enum ItemType { Material, Equipment, Consumable, QuestItem, Misc }
[CreateAssetMenu(fileName = "New Item", menuName = "Inventory/Item Data")]
public class Item : ScriptableObject
{
    [Header("基本資訊")]
    public string itemName = "New Item";
    [TextArea(3, 5)]
    public string description = "Item Description";
    public Sprite icon = null;
    public ItemType itemType = ItemType.Misc;
    public int maxStackAmount = 1;

    [Header("識別")]
    [Tooltip("Unique ID for this item type. Generate one if needed.")]
    public string uniqueItemID;

    [Header("交易資訊")]
    public bool canBeBought = true;
    public int buyPrice = 10;
    public bool canBeSold = true;
    public int sellPrice = 5;

    [Header("消耗品效果 (僅當類型為 Consumable)")]
    [Tooltip("如果物品類型是 Consumable，則恢復的生命值。")]
    public int healAmount = 0;

    private void OnValidate()
    {
        if (string.IsNullOrEmpty(uniqueItemID))
        {
            uniqueItemID = Guid.NewGuid().ToString();
            UnityEditor.EditorUtility.SetDirty(this);
        }
        if (itemType != ItemType.Consumable)
        {
            healAmount = 0;
        }
    }

    public bool IsStackable()
    {
        return maxStackAmount > 1;
    }
}
```

#### 2.2. `ItemDatabase.cs`
```csharp
using UnityEngine;
using System.Collections.Generic;
using System.Linq;
    
[CreateAssetMenu(fileName = "ItemDatabase", menuName = "Inventory/Item Database")]
public class ItemDatabase : ScriptableObject
{
    public List<Item> allItems;

    private static ItemDatabase _instance;
    public static ItemDatabase Instance
    {
        get
        {
            if (_instance == null)
            {
                _instance = Resources.Load<ItemDatabase>("ItemDatabase");
                if (_instance == null)
                {
                    Debug.LogError("ItemDatabase not found in Resources folder! Please create one.");
                }
            }
            return _instance;
        }
    }
    
    public Item GetItemByID(string uniqueID)
    {
        return allItems.FirstOrDefault(item => item.uniqueItemID == uniqueID);
    }
}
```

#### 2.3. `Inventory.cs`
```csharp
using System.Collections.Generic;
using UnityEngine;

[CreateAssetMenu(fileName = "New Inventory", menuName = "Inventory/Inventory Data")]
public class Inventory : ScriptableObject
{
    [Header("Inventory Settings")]
    public string inventoryName = "Player Inventory";
    public int capacity = 20;

    [Header("Inventory Contents")]
    public List<InventorySlot> slots = new List<InventorySlot>();

    private void OnEnable()
    {
        while (slots.Count < capacity)
        {
            slots.Add(new InventorySlot());
        }
    }

    public void InitializeSlots()
    {
        slots.Clear();
        for (int i = 0; i < capacity; i++)
        {
            slots.Add(new InventorySlot());
        }
    }
}
```

#### 2.4. `InventorySlot.cs`
```csharp
using System;

[System.Serializable]
public class InventorySlot
{
    public Item item;
    public int quantity;

    public InventorySlot()
    {
        item = null;
        quantity = 0;
    }

    public InventorySlot(Item item, int quantity)
    {
        this.item = item;
        this.quantity = quantity;
    }

    public bool IsEmpty() => item == null || quantity <= 0;

    public int GetRemainingSpace()
    {
        if (IsEmpty()) return int.MaxValue;
        return item.maxStackAmount - quantity;
    }

    public int AddQuantity(int amountToAdd)
    {
        if (IsEmpty()) return amountToAdd;

        int spaceAvailable = GetRemainingSpace();
        int amountCanAdd = Math.Min(amountToAdd, spaceAvailable);

        quantity += amountCanAdd;
        return amountToAdd - amountCanAdd;
    }

    public int RemoveQuantity(int amountToRemove)
    {
        if (IsEmpty()) return 0;

        int amountCanRemove = Math.Min(amountToRemove, quantity);
        quantity -= amountCanRemove;

        if (quantity <= 0)
        {
            ClearSlot();
        }
        return amountCanRemove;
    }

    public void SetSlot(Item newItem, int newQuantity)
    {
        item = newItem;
        quantity = newQuantity;
        if (quantity <= 0 && item != null)
        {
            ClearSlot();
        }
    }

    public void ClearSlot()
    {
        item = null;
        quantity = 0;
    }

    public void SwapData(InventorySlot otherSlot)
    {
        Item tempItem = item;
        int tempQuantity = quantity;

        SetSlot(otherSlot.item, otherSlot.quantity);
        otherSlot.SetSlot(tempItem, tempQuantity);
    }
}
```

#### 2.5. `GroundItem.cs`
```csharp
using UnityEngine;

[System.Serializable]
public class GroundItemState
{
    public string itemID;
    public int quantity;
    public Vector3 position;
}

[RequireComponent(typeof(SpriteRenderer))]
[RequireComponent(typeof(Collider2D))]
public class GroundItem : MonoBehaviour, ISceneSaveable 
{
    [Header("物品數據")]
    public Item itemData;
    public int quantity = 1;

    [Header("拾取提示 (可選)")]
    [SerializeField] private GameObject pickupPrompt;

    private SpriteRenderer spriteRenderer;
    private Collider2D itemCollider;
    
    void Awake()
    {
        spriteRenderer = GetComponent<SpriteRenderer>();
        itemCollider = GetComponent<Collider2D>();
        if (itemCollider != null && !itemCollider.isTrigger)
        {
            Debug.LogWarning($"GroundItem '{gameObject.name}' 的 Collider2D 沒有設置為 Is Trigger，自動設置。", gameObject);
            itemCollider.isTrigger = true;
        }
        if(pickupPrompt != null) pickupPrompt.SetActive(false);
    }

    private void OnValidate()
    {
        if (spriteRenderer == null) spriteRenderer = GetComponent<SpriteRenderer>();
        SetupVisuals();
    }

    void Start()
    {
        SetupVisuals();
        if (itemData == null)
        {
            Debug.LogError($"GroundItem '{gameObject.name}' 在 Start 時仍然沒有有效的 Item Data！Spawner 可能沒有正確賦值。", gameObject);
            if (itemCollider != null) itemCollider.enabled = false;
        }
    }

    public void SetupVisuals()
    {
        if (spriteRenderer == null) return;
        if (itemData != null)
        {
            spriteRenderer.sprite = itemData.icon;
            gameObject.name = $"GroundItem - {itemData.itemName} ({quantity})";
        } else {
            spriteRenderer.sprite = null;
            gameObject.name = "GroundItem - (No Item Data!)";
        }
    }

    private void OnTriggerEnter2D(Collider2D other)
    {
        if (other.CompareTag("Player"))
        {
            Debug.Log($"玩家進入了 '{itemData?.itemName ?? "未知物品"}' 的拾取範圍。");
            if(pickupPrompt != null) pickupPrompt.SetActive(true);
        }
    }

    private void OnTriggerExit2D(Collider2D other)
    {
        if (other.CompareTag("Player"))
        {
            Debug.Log($"玩家離開了 '{itemData?.itemName ?? "未知物品"}' 的拾取範圍。");
            if(pickupPrompt != null) pickupPrompt.SetActive(false);
        }
    }
    public bool AttemptPickup()
    {
        if (itemData == null)
        {
            Debug.LogError($"嘗試拾取 '{gameObject.name}' 但其 ItemData 為 null！", gameObject);
            return false;
        }

        Debug.Log($"玩家嘗試按下拾取鍵拾取 '{itemData.itemName}'");
        bool addedSuccessfully = InventoryManager.TriggerAddItem(itemData, quantity);

        if (addedSuccessfully)
        {
            Debug.Log($"成功拾取 {itemData.itemName} x{quantity}，銷毀地上物品。");
            // 可選：在銷毀前播放拾取音效
            // AudioManager.PlayPickupSound();
            Destroy(gameObject);
            return true;
        }
        else
        {
            Debug.LogWarning($"無法拾取 {itemData.itemName} x{quantity} (可能是背包已滿?)，物品保留在地上。");
            // 可選：播放背包已滿的音效
            // AudioManager.PlayInventoryFullSound();
            return false;
        }
    }

    public object CaptureState()
    {
        if (itemData == null) return null;

        return new GroundItemState
        {
            itemID = this.itemData.uniqueItemID,
            quantity = this.quantity,
            position = this.transform.position
        };
    }

    public void RestoreState(object stateData)
    {
        if (stateData is string stateJson)
        {
            var state = JsonUtility.FromJson<GroundItemState>(stateJson);
            this.itemData = ItemDatabase.Instance.GetItemByID(state.itemID);
            this.quantity = state.quantity;
            this.transform.position = state.position;
            
            SetupVisuals();
        }
    }
}
```

#### 2.6. `InventoryManager.cs`
```csharp
using UnityEngine;
using System;
using System.Collections.Generic;
using System.Linq;

public class InventoryManager : MonoBehaviour, IGameSaveable
{
    #region 核心數據
    private static InventoryManager _instance;
    public static InventoryManager Instance
    {
        get
        {
            if (_instance == null)
            {
                _instance = FindObjectOfType<InventoryManager>();
                if (_instance == null)
                {
                    GameObject singletonObject = new GameObject("InventoryManager");
                    _instance = singletonObject.AddComponent<InventoryManager>();
                }
            }
            return _instance;
        }
    }

    [Header("背包數據 (ScriptableObject)")]
    public Inventory playerInventoryData;

    [HideInInspector]
    public InventoryUI playerInventoryUI { get; private set; }
    public event Action OnInventoryChanged;
    public static event Action<string, int> OnItemQuantityChanged;
    public static event Action<bool> OnItemSelectionModeChanged;

    [Header("拋棄物品設置")]
    [SerializeField] private GameObject groundItemPrefab;
    
    private bool isLoading = false;
    public bool IsSelectingTarget { get; private set; } = false;
    private Item itemPendingUsage;
    #endregion

    void Awake()
    {
        if (_instance != null && _instance != this)
        {
            Destroy(gameObject);
            return;
        }
        _instance = this;
        DontDestroyOnLoad(gameObject);
        if (playerInventoryData == null) Debug.LogError("Player Inventory Data not assigned in InventoryManager!");
        SaveManager.Instance.Register(this);
    }
    
    void OnDestroy()
    {
        if (SaveManager.Instance != null)
        {
            SaveManager.Instance.Unregister(this);
        }
    }

    void OnEnable()
    {
        if (InputManager.Instance != null)
        {
            InputManager.Instance.OnEscape += HandleEscape;
        }
    }

    void OnDisable()
    {
        if (InputManager.Instance != null)
        {
            InputManager.Instance.OnEscape -= HandleEscape;
        }
    }

    private void HandleEscape()
    {
        if (IsSelectingTarget)
        {
            CancelItemSelectionMode();
        }
    }

    #region UI 管理
    public void RegisterInventoryUI(InventoryUI ui)
    {
        if (this.playerInventoryUI != null)
        {
            Debug.LogWarning("[InventoryManager] 嘗試註冊新的 InventoryUI，但已有一個存在。舊的將被覆蓋。");
        }
        this.playerInventoryUI = ui;
        
        if (this.playerInventoryUI != null && playerInventoryData != null)
        {
            this.playerInventoryUI.InitializeUI(playerInventoryData);
            Debug.Log("[InventoryManager] InventoryUI 已成功註冊並初始化。");
        }
    }

    public void UnregisterInventoryUI(InventoryUI ui)
    {
        if (this.playerInventoryUI == ui)
        {
            this.playerInventoryUI = null;
            Debug.Log("[InventoryManager] InventoryUI 已成功反註冊。");
        }
    }

    public void ToggleInventoryUI() => playerInventoryUI?.TogglePanel();
    public void OpenInventoryUI() => playerInventoryUI?.ShowPanel();
    public void CloseInventoryUI() => playerInventoryUI?.HidePanel();
    #endregion

    #region 物品數據庫查詢
    private Dictionary<string, Item> _itemDatabaseCache;
    public Item GetItemDataByID(string itemID)
    {
        if (string.IsNullOrEmpty(itemID)) return null;
        if (_itemDatabaseCache == null)
        {
            _itemDatabaseCache = new Dictionary<string, Item>();
            Item[] items = Resources.LoadAll<Item>("Items");
            foreach (Item item in items)
            {
                if (!_itemDatabaseCache.ContainsKey(item.uniqueItemID))
                {
                    _itemDatabaseCache.Add(item.uniqueItemID, item);
                }
            }
            Debug.Log($"已加載 {_itemDatabaseCache.Count} 個物品到數據庫緩存。");
        }

        if (_itemDatabaseCache.TryGetValue(itemID, out Item foundItem))
        {
            return foundItem;
        }
        Debug.LogWarning($"InventoryManager: 找不到 ID 為 '{itemID}' 的物品數據。");
        return null;
    }
    #endregion

    #region 物品操作邏輯 (Add, Remove...)
    public static bool TriggerAddItem(Item itemToAdd, int quantity)
    {
        if (Instance == null)
        {
            Debug.LogError("InventoryManager 實例不存在，無法添加物品！");
            return false;
        }
        if (itemToAdd == null || quantity <= 0)
        {
            Debug.LogWarning("嘗試添加無效的物品或數量。");
            return false;
        }
        return Instance.AddItem(itemToAdd, quantity);
    }

    public bool AddItem(Item itemToAdd, int quantity = 1)
    {
        if (playerInventoryData == null) 
        {
            Debug.LogError("Player Inventory Data 未在 InventoryManager 中設置！");
            return false;
        }
        if (itemToAdd == null || quantity <= 0) return false;
        int initialQuantity = quantity;

        bool addedSuccessfully = false;

        // 1. 嘗試堆疊
        foreach (InventorySlot slot in playerInventoryData.slots)
        {
            if (!slot.IsEmpty() && slot.item == itemToAdd && slot.item.IsStackable())
            {
                int spaceLeft = slot.GetRemainingSpace();
                if (spaceLeft > 0)
                {
                    int amountToAdd = Mathf.Min(quantity, spaceLeft);
                    slot.AddQuantity(amountToAdd);
                    quantity -= amountToAdd;
                    addedSuccessfully = true;

                    if (quantity <= 0) break;
                }
            }
        }

        // 2. 嘗試放入空格子
        if (quantity > 0)
        {
            foreach (InventorySlot slot in playerInventoryData.slots)
            {
                if (slot.IsEmpty())
                {
                    int amountToAdd = Mathf.Min(quantity, itemToAdd.maxStackAmount);
                    slot.SetSlot(itemToAdd, amountToAdd);
                    quantity -= amountToAdd;
                    addedSuccessfully = true;

                    if (quantity <= 0) break;
                }
            }
        }

        if (addedSuccessfully)
        {
            if (!isLoading)
            {
                OnInventoryChanged?.Invoke();
                playerInventoryUI?.RefreshUI();
                
                int actuallyAdded = initialQuantity - quantity;
                if (actuallyAdded > 0)
                {
                    QuestManager.Instance?.AdvanceObjective(itemToAdd.uniqueItemID, QuestObjectiveType.Collect, actuallyAdded);
                    OnItemQuantityChanged?.Invoke(itemToAdd.uniqueItemID, GetItemCount(itemToAdd));
                }
            }
            if (quantity > 0)
            {
                Debug.LogWarning($"背包已滿。未能完全添加 {itemToAdd.itemName}，剩餘 {quantity} 個。");
            }
            return true;
        }
        else
        {
            Debug.LogWarning($"背包已滿，無法添加 {itemToAdd.itemName}。");
            return false;
        }
    }

    public bool RemoveItem(Item itemToRemove, int quantity = 1)
    {
        if (itemToRemove == null || quantity <= 0) return false;

        int quantityToRemove = quantity;
        bool removedAny = false;
        List<InventorySlot> slotsToUpdate = new List<InventorySlot>();
        for (int i = playerInventoryData.slots.Count - 1; i >= 0; i--)
        {
            InventorySlot slot = playerInventoryData.slots[i];
            if (!slot.IsEmpty() && slot.item == itemToRemove)
            {
                int amountRemoved = slot.RemoveQuantity(quantityToRemove);
                quantityToRemove -= amountRemoved;
                removedAny = true;

                if (quantityToRemove <= 0)
                {
                    break;
                }
            }
        }

        if (removedAny)
        {
            if (!isLoading)
            {
                OnInventoryChanged?.Invoke();
                playerInventoryUI?.RefreshUI();
                OnItemQuantityChanged?.Invoke(itemToRemove.uniqueItemID, GetItemCount(itemToRemove));
            }
        }
        return removedAny && quantityToRemove <= 0;
    }

    public bool RemoveItemFromSlot(InventorySlot slotToRemoveFrom, int quantity)
    {
        if (slotToRemoveFrom == null || slotToRemoveFrom.IsEmpty() || quantity <= 0)
        {
            Debug.LogWarning("嘗試從無效或空的格子移除物品，或數量無效。");
            return false;
        }
        if (quantity > slotToRemoveFrom.quantity)
        {
            Debug.LogWarning($"嘗試移除的數量 ({quantity}) 超過格子擁有的數量 ({slotToRemoveFrom.quantity})。");
            quantity = slotToRemoveFrom.quantity;
        }
        int actualRemoved = slotToRemoveFrom.RemoveQuantity(quantity);
        if (actualRemoved == quantity)
        {
            if (!isLoading)
            {
                OnInventoryChanged?.Invoke();
                playerInventoryUI?.RefreshUI();
                Item removedItem = slotToRemoveFrom.item;
                if (removedItem != null) 
                {
                    OnItemQuantityChanged?.Invoke(removedItem.uniqueItemID, GetItemCount(removedItem));
                }
            }
            return true;
        }
        else
        {
            Debug.LogError($"從格子移除物品時發生錯誤！預期移除 {quantity}, 實際移除 {actualRemoved}。");
            if (actualRemoved > 0) {
                OnInventoryChanged?.Invoke();
                playerInventoryUI?.RefreshUI();
            }
            return false;
        }
    }

    public void SpawnGroundItem(Item itemData, int quantity, Vector3 position)
    {
        if (groundItemPrefab == null)
        {
            Debug.LogError("InventoryManager 沒有在 Inspector 中指定 GroundItem Prefab！無法生成地上物品。");
            return;
        }
        if (itemData == null || quantity <= 0)
        {
            Debug.LogWarning("嘗試生成無效數據或數量的地上物品。");
            return;
        }
        GameObject dropped = Instantiate(groundItemPrefab, position, Quaternion.identity);
        GroundItem gi = dropped.GetComponent<GroundItem>();
        if (gi != null)
        {
            gi.itemData = itemData;
            gi.quantity = quantity;
            gi.SetupVisuals();
            var identifier = dropped.GetComponent<UniqueObjectIdentifier>();
            if (identifier == null) identifier = dropped.AddComponent<UniqueObjectIdentifier>();
            
            identifier.SetID(System.Guid.NewGuid().ToString());
            identifier.IsRuntimeInstantiated = true;

            Debug.Log($"在 {position} 生成了地上物品：{itemData.itemName} x{quantity} (ID: {identifier.ID})");
        }
        else
        {
            Debug.LogError("指定的 GroundItem Prefab 上沒有找到 GroundItem 腳本！");
            Destroy(dropped);
        }
    }
    #endregion
    
    #region 物品查詢
    public bool HasItem(Item item, int quantity = 1)
    {
        if (item == null || quantity <= 0) return false;

        int count = 0;
        foreach (InventorySlot slot in playerInventoryData.slots)
        {
            if (!slot.IsEmpty() && slot.item == item)
            {
                count += slot.quantity;
                if (count >= quantity)
                {
                    return true;
                }
            }
        }
        return false;
    }

    public int GetItemCount(Item item)
    {
         if (item == null) return 0;
        int count = 0;
        foreach (InventorySlot slot in playerInventoryData.slots)
        {
            if (!slot.IsEmpty() && slot.item == item)
            {
                count += slot.quantity;
            }
        }
        return count;
    }
    #endregion

    #region 道具圖標
    public void StartItemSelectionMode(Item item)
    {
        itemPendingUsage = item;
        IsSelectingTarget = true;
        OnItemSelectionModeChanged?.Invoke(true);
        UpdateCursorState();
        Debug.Log($"[InventoryManager] 進入目標選擇模式: {item.itemName}");
    }

    public void ConfirmItemUsageOnMember(MemberInstance member)
    {
        if (!IsSelectingTarget || itemPendingUsage == null) return;
        if (itemPendingUsage.healAmount > 0)
        {
            member.currentHP += itemPendingUsage.healAmount;
            if (member.currentHP > member.MaxHP) member.currentHP = member.MaxHP;
            Debug.Log($"對成員 {member.BaseData.memberName} 使用了 {itemPendingUsage.itemName}，HP 恢復。");
            PartyManager.Instance.NotifyPartyUpdated();
        }
        RemoveItem(itemPendingUsage, 1);
        int remainingCount = GetItemCount(itemPendingUsage);
        if (remainingCount > 0)
        {
            UpdateCursorState();
        }
        else
        {
            if (BattleVFXManager.Instance != null)
            {
                Vector3 worldPos = Camera.main.ScreenToWorldPoint(Input.mousePosition);
                worldPos.z = 0;
                BattleVFXManager.Instance.ShowText(worldPos, "物品已用盡", VFXType.Text_Info);
            }
            CancelItemSelectionMode();
        }
    }

    public void CancelItemSelectionMode()
    {
        IsSelectingTarget = false;
        itemPendingUsage = null;
        OnItemSelectionModeChanged?.Invoke(false);
        if (CursorManager.Instance != null) 
        {
            CursorManager.Instance.ResetCursor();
            CursorManager.Instance.HideTooltip();
        }
        Debug.Log("[InventoryManager] 結束目標選擇模式");
    }

    private void UpdateCursorState()
    {
        if (CursorManager.Instance != null && itemPendingUsage != null)
        {
            CursorManager.Instance.SetCursorIcon(itemPendingUsage.icon);
            int count = GetItemCount(itemPendingUsage);
            CursorManager.Instance.SetQuantityText(count.ToString());
            CursorManager.Instance.ShowTooltip("左鍵: 使用\n右鍵: 取消");
        }
    }

    void Update()
    {
        if (IsSelectingTarget && Input.GetMouseButtonDown(1))
        {
            CancelItemSelectionMode();
        }
    }
    #endregion
    
    #region 存檔資料
    public void PopulateSaveData(GameSaveData data)
    {
        data.inventoryData.slots = playerInventoryData.slots.Select(slot => 
        {
            if (slot.IsEmpty())
            {
                return new InventorySlotData { itemID = null, quantity = 0 };
            }
            else
            {
                return new InventorySlotData { itemID = slot.item.uniqueItemID, quantity = slot.quantity };
            }
        }).ToList();
    }

    public void LoadFromSaveData(GameSaveData data)
    {
        isLoading = true; 
        
        if (data.inventoryData != null && data.inventoryData.slots != null)
        {
            playerInventoryData.slots.Clear();
            foreach (var slotData in data.inventoryData.slots)
            {
                if (string.IsNullOrEmpty(slotData.itemID) || slotData.quantity <= 0)
                {
                    playerInventoryData.slots.Add(new InventorySlot());
                }
                else
                {
                    Item itemTemplate = ItemDatabase.Instance.GetItemByID(slotData.itemID);
                    if (itemTemplate != null)
                    {
                        playerInventoryData.slots.Add(new InventorySlot(itemTemplate, slotData.quantity));
                    }
                    else
                    {
                        Debug.LogWarning($"讀取背包存檔時找不到 ID 為 '{slotData.itemID}' 的物品，該格子將被清空。");
                        playerInventoryData.slots.Add(new InventorySlot());
                    }
                }
            }

            while(playerInventoryData.slots.Count < playerInventoryData.capacity)
            {
                playerInventoryData.slots.Add(new InventorySlot());
            }
        }
        isLoading = false;
        OnInventoryChanged?.Invoke();
        
        if (QuestManager.Instance != null)
        {
            QuestManager.Instance.SyncCollectionQuests();
        }
    }
    #endregion
}
```

#### 2.7. `InventoryUI.cs`
```csharp
using System;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.EventSystems;
using UnityEngine.UI;

public class InventoryUI : MonoBehaviour
{
    [Header("UI References")]
    [SerializeField] private GameObject inventoryPanel;
    [SerializeField] private Transform slotContainer;
    [SerializeField] private GameObject slotPrefab;

    private Inventory targetInventory; 

    private List<InventorySlotUI> slotUIs = new List<InventorySlotUI>();
    private ItemDetailsPanel detailsPanel;
    
    private void OnEnable()
    {
        if (InventoryManager.Instance != null)
        {
            InventoryManager.Instance.RegisterInventoryUI(this);
            InventoryManager.Instance.OnInventoryChanged += RefreshUI;
        }
        else
        {
            Debug.LogError("[InventoryUI] 找不到 InventoryManager 的實例來進行註冊！");
        }
        SaveManager.OnGameLoadComplete += RefreshUI;
        RefreshUI();
    }

    private void OnDisable()
    {
        if (InventoryManager.Instance != null)
        {
            InventoryManager.Instance.OnInventoryChanged -= RefreshUI;
            InventoryManager.Instance.UnregisterInventoryUI(this);
        }
        SaveManager.OnGameLoadComplete -= RefreshUI;
    }
    
    void Start()
    {
        detailsPanel = FindObjectOfType<ItemDetailsPanel>(true);
        if (inventoryPanel != null) inventoryPanel.SetActive(false);
        if (detailsPanel != null) detailsPanel.HideDetails();
    }

    public void InitializeUI(Inventory inventory)
    {
        targetInventory = inventory;
        if (targetInventory == null)
        {
            Debug.LogError("傳入的 Inventory Data 為空，無法初始化UI！");
            return;
        }

        foreach (Transform child in slotContainer)
        {
            Destroy(child.gameObject);
        }
        slotUIs.Clear();
        
        if (targetInventory.slots.Count != targetInventory.capacity)
        {
            targetInventory.InitializeSlots();
        }

        for (int i = 0; i < targetInventory.capacity; i++)
        {
            GameObject slotGO = Instantiate(slotPrefab, slotContainer);
            InventorySlotUI slotUI = slotGO.GetComponent<InventorySlotUI>();
            if (slotUI != null)
            {
                slotUI.AssignSlot(targetInventory.slots[i]);
                slotUIs.Add(slotUI);

                ItemDragHandler dragHandler = slotGO.GetComponent<ItemDragHandler>();
                if (dragHandler == null) dragHandler = slotGO.AddComponent<ItemDragHandler>();
                dragHandler.Initialize(this, slotUI);
            }
        }
    }

    public void RefreshUI()
    {
        if (targetInventory == null && InventoryManager.Instance != null)
        {
            InitializeUI(InventoryManager.Instance.playerInventoryData);
        }
        if (targetInventory == null || slotUIs.Count != targetInventory.capacity) return;

        if (slotUIs.Count != targetInventory.slots.Count)
        {
            InitializeUI(targetInventory);
        }

        for (int i = 0; i < targetInventory.capacity; i++)
        {
            if (i < slotUIs.Count && i < targetInventory.slots.Count)
            {
                slotUIs[i].AssignSlot(targetInventory.slots[i]);
                slotUIs[i].UpdateUI();
            }
        }
    }

    public void TogglePanel()
    {
        bool isActive = !inventoryPanel.activeSelf;
        inventoryPanel.SetActive(isActive);

        if (!isActive && detailsPanel != null)
        {
            detailsPanel.HideDetails();
        }
    }

    public void ShowPanel()
    {
        inventoryPanel.SetActive(true);
        RefreshUI();
    }

     public void HidePanel()
    {
        inventoryPanel.SetActive(false);
        if (detailsPanel != null)
        {
            detailsPanel.HideDetails();
        }
    }
    
    public bool IsPanelActive()
    {
        return inventoryPanel.activeSelf;
    }

    public void HandleDrop(InventorySlotUI draggedSlotUI, InventorySlotUI targetSlotUI)
    {
        if (draggedSlotUI == null || targetSlotUI == null || draggedSlotUI == targetSlotUI)
        {
            Debug.Log("HandleDrop: 無效的來源或目標，或來源與目標相同。");
            return;
        }

        InventorySlot sourceSlot = draggedSlotUI.AssignedSlot;
        InventorySlot targetSlot = targetSlotUI.AssignedSlot;

        if (sourceSlot.IsEmpty()) { return; }
        // 情況 1: 目標 Slot 為空
        if (targetSlot.IsEmpty())
        {
            Debug.Log($"物品 '{sourceSlot.item.itemName}' 移動到空格子 {GetSlotIndex(targetSlotUI)}。");
            sourceSlot.SwapData(targetSlot);
        }
        // 情況 2: 目標 Slot 不為空
        else
        {
            if (sourceSlot.item == targetSlot.item && targetSlot.item.IsStackable())
            {
                int spaceAvailable = targetSlot.GetRemainingSpace();
                if (spaceAvailable > 0)
                {
                    int amountToTransfer = Math.Min(sourceSlot.quantity, spaceAvailable);

                    if (amountToTransfer > 0)
                    {
                        Debug.Log($"堆疊物品 '{targetSlot.item.itemName}'：從格子 {GetSlotIndex(draggedSlotUI)} 轉移 {amountToTransfer} 個到格子 {GetSlotIndex(targetSlotUI)}。");
                        targetSlot.quantity += amountToTransfer;
                        sourceSlot.RemoveQuantity(amountToTransfer);
                    }
                    else
                    {
                        Debug.Log($"物品 '{targetSlot.item.itemName}' 相同但目標格子已滿，執行交換。");
                        sourceSlot.SwapData(targetSlot);
                    }
                }
                else
                {
                    Debug.Log($"物品 '{targetSlot.item.itemName}' 相同但目標格子已滿，執行交換。");
                    sourceSlot.SwapData(targetSlot);
                }
            }
            // 情況 3: 物品不同，或不可堆疊
            else
            {
                Debug.Log($"物品不同或不可堆疊，交換格子 {GetSlotIndex(draggedSlotUI)} 和 {GetSlotIndex(targetSlotUI)} 的內容。");
                sourceSlot.SwapData(targetSlot);
            }
        }
        draggedSlotUI.UpdateUI();
        targetSlotUI.UpdateUI();

        // 可選：如果詳情面板正顯示被操作的物品，也刷新詳情面板
        if (detailsPanel != null && detailsPanel.gameObject.activeSelf)
        {
            // 檢查詳情面板當前顯示的是哪個物品，如果與 source 或 target 相關，則刷新
            // (這部分邏輯需要 ItemDetailsPanel 提供方法來獲取當前物品，或 InventoryUI 追蹤哪個 Slot 被點擊)
            // 簡單起見，可以先隱藏詳情面板
            // detailsPanel.HideDetails();
        }
    }

    public int GetSlotIndex(InventorySlotUI slotUI)
    {
        return slotUIs.IndexOf(slotUI);
    }
    public InventorySlotUI GetSlotUIUnderPointer(PointerEventData eventData)
    {
        List<RaycastResult> results = new List<RaycastResult>();
        EventSystem.current.RaycastAll(eventData, results);

        foreach (RaycastResult result in results)
        {
            InventorySlotUI slotUI = result.gameObject.GetComponentInParent<InventorySlotUI>(); // Check parents too
            if (slotUI != null && slotUIs.Contains(slotUI))
            {
                return slotUI;
            }
        }
        return null;
    }
}
```

#### 2.8. `InventorySlotUI.cs`
```csharp
using UnityEngine;
using UnityEngine.UI;
using TMPro;
using UnityEngine.EventSystems;

public class InventorySlotUI : MonoBehaviour
{
    [SerializeField] private Image itemIconImage;
    [SerializeField] private TextMeshProUGUI quantityText;
    [SerializeField] private Button slotButton;

    public InventorySlot AssignedSlot { get; private set; }
    private ItemDetailsPanel detailsPanel;

    void Awake()
    {
        ClearUI();
        if (slotButton != null)
        {
            slotButton.onClick.AddListener(OnSlotClicked);
        }
        detailsPanel = FindObjectOfType<ItemDetailsPanel>(true);
        if (detailsPanel == null)
        {
            Debug.LogWarning("InventorySlotUI 找不到 ItemDetailsPanel！");
        }
    }

    public void AssignSlot(InventorySlot slot)
    {
        AssignedSlot = slot;
        UpdateUI();
    }

    public void UpdateUI()
    {
        if (AssignedSlot == null || AssignedSlot.IsEmpty())
        {
            ClearUI();
        }
        else
        {
            itemIconImage.sprite = AssignedSlot.item.icon;
            itemIconImage.enabled = true;

            if (AssignedSlot.item.IsStackable() && AssignedSlot.quantity > 1)
            {
                quantityText.text = AssignedSlot.quantity.ToString();
                quantityText.enabled = true;
            }
            else
            {
                quantityText.enabled = false;
            }
            slotButton.interactable = true;
        }
    }

    private void ClearUI()
    {
        itemIconImage.sprite = null;
        itemIconImage.enabled = false;
        quantityText.text = "";
        quantityText.enabled = false;
        slotButton.interactable = false;
    }

    private void OnSlotClicked()
    {
        if (AssignedSlot != null && !AssignedSlot.IsEmpty() && detailsPanel != null)
        {
            detailsPanel.ShowDetails(AssignedSlot);
        }
        else if (detailsPanel != null)
        {
            detailsPanel.HideDetails();
        }
    }
}
```

#### 2.9. `ItemDetailsPanel.cs`
```csharp
using UnityEngine;
using UnityEngine.UI;
using TMPro;

public class ItemDetailsPanel : MonoBehaviour
{
    [Header("UI References")]
    [SerializeField] private Image itemIcon;
    [SerializeField] private TextMeshProUGUI itemNameText;
    [SerializeField] private TextMeshProUGUI itemDescriptionText;
    [SerializeField] private TextMeshProUGUI itemTypeText;
    [SerializeField] private TextMeshProUGUI itemValueText;
    [SerializeField] private Button useButton;
    [SerializeField] private Button dropButton;
    [SerializeField] private Button closeButton;

    [Header("關聯 UI (新增)")]
    [SerializeField] private ItemDropUI itemDropUI;
    private InventorySlot currentSlot;
    private Item currentItem => currentSlot?.item;

    void Awake()
    {
        if (useButton != null) useButton.onClick.AddListener(OnUseButtonClicked);
        if (dropButton != null) dropButton.onClick.AddListener(OnDropButtonClicked);
        if (closeButton != null) closeButton.onClick.AddListener(HideDetails);
        if (itemDropUI == null)
        {
            Debug.LogError("ItemDetailsPanel 沒有指定 ItemDropUI！");
        }
        HideDetails();
    }

    public void ShowDetails(InventorySlot slotToShow)
    {
        if (slotToShow == null || slotToShow.IsEmpty())
        {
            HideDetails();
            return;
        }

        currentSlot = slotToShow;
        Item item = currentItem;

        gameObject.SetActive(true);

        if (itemIcon != null)
        {
            itemIcon.sprite = item.icon;
            itemIcon.enabled = (item.icon != null);
        }
        if (itemNameText != null) itemNameText.text = item.itemName;
        if (itemDescriptionText != null) itemDescriptionText.text = item.description;
        if (itemTypeText != null) itemTypeText.text = $"類型: {item.itemType}";
        if (itemValueText != null)
        {
            string valueStr = "";
            if(item.canBeBought) valueStr += $"購買: {item.buyPrice} ";
            if(item.canBeSold) valueStr += $"販賣: {item.sellPrice}";
            itemValueText.text = valueStr.Trim();
        }

        if (useButton != null)
        {
            bool canUse = (item.itemType == ItemType.Consumable || item.itemType == ItemType.Equipment);
            useButton.gameObject.SetActive(canUse);
        }

        if (dropButton != null)
        {
            bool canDrop = (item.itemType != ItemType.QuestItem);
            dropButton.gameObject.SetActive(canDrop);
            dropButton.interactable = canDrop;
        }
    }

    public void HideDetails()
    {
        currentSlot = null;
        gameObject.SetActive(false);
    }

    private void OnUseButtonClicked()
    {
        if (currentSlot == null || currentItem == null) return;
        if (currentItem.itemType == ItemType.Consumable)
        {
            if (CursorManager.Instance != null)
            {
                CursorManager.Instance.SetCursorIcon(currentItem.icon);
            }
            InventoryManager.Instance.StartItemSelectionMode(currentItem);
            var partyBattleUI = FindObjectOfType<PartyBattleUI>(true);
            if (partyBattleUI != null && !partyBattleUI.gameObject.activeSelf)
            {
                partyBattleUI.TogglePanel();
            }
            HideDetails();
            return;
        }
        Debug.Log($"嘗試直接使用/裝備 {currentItem.itemName}");

        bool consumedOrEquipped = false;

        switch (currentItem.itemType)
        {
            case ItemType.Consumable:
                Debug.Log("消耗了！");
                InventoryManager.Instance.RemoveItemFromSlot(currentSlot, 1);
                consumedOrEquipped = true;
                break;
            case ItemType.Equipment:
                Debug.Log("裝備了！");
                // 發送到裝備管理器...
                // 如果裝備系統獨立於背包，則從格子移除
                // InventoryManager.Instance.RemoveItemFromSlot(currentSlot, 1);
                // consumedOrEquipped = true; // 如果裝備後從背包移除
                break;
            default:
                break;
        }

        // 如果物品被消耗/裝備，可能需要隱藏詳情面板或更新其狀態
        if (consumedOrEquipped)
        {
            if (currentSlot.IsEmpty())
            {
                HideDetails();
            }
            else
            {
                // 否則，只刷新顯示 (如果數量變化)
                // ShowDetails(currentSlot); // 重新調用以刷新數量等 (如果UI沒自動更新)
            }
            // InventoryManager 里的 RemoveItemFromSlot 應該已經調用了 RefreshUI
        }
    }

    private void OnDropButtonClicked()
    {
        if (currentSlot == null || currentItem == null || itemDropUI == null)
        {
            Debug.LogWarning("無法拋棄：當前格子無效或未指定 ItemDropUI。");
            return;
        }
        if (currentItem.itemType == ItemType.QuestItem) {
            Debug.Log("任務物品不可拋棄。");
            return;
        }
        Debug.Log($"按下拋棄按鈕，準備打開數量選擇面板：{currentItem.itemName}");
        itemDropUI.ShowPanel(currentSlot);
        HideDetails();
    }
}
```

#### 2.10. `ItemDropUI.cs`
```csharp
using UnityEngine;
using UnityEngine.UI;
using TMPro;
using System;

public class ItemDropUI : MonoBehaviour
{
    [Header("UI 元素參考")]
    [SerializeField] private GameObject dropPanel;
    [SerializeField] private Slider quantitySlider;
    [SerializeField] private TextMeshProUGUI quantityText;
    [SerializeField] private Button confirmButton;
    [SerializeField] private Button cancelButton;
    [SerializeField] private TextMeshProUGUI maxQuantityText;

    private InventorySlot targetSlot;
    private Item targetItem;
    private int currentSelectedQuantity;

    // 事件：當確認拋棄時觸發 (可以讓其他系統監聽，例如音效)
    public event Action<Item, int> OnConfirmDropAction;

    void Awake()
    {
        confirmButton.onClick.AddListener(ConfirmDrop);
        cancelButton.onClick.AddListener(CancelDrop);
        quantitySlider.onValueChanged.AddListener(UpdateQuantityText);

        if (dropPanel != null)
        {
            dropPanel.SetActive(false);
        }
        else
        {
            gameObject.SetActive(false);
        }
    }

    public void ShowPanel(InventorySlot slotToDropFrom)
    {
        if (slotToDropFrom == null || slotToDropFrom.IsEmpty())
        {
            Debug.LogWarning("嘗試為空或無效的格子顯示拋棄面板。");
            HidePanel();
            return;
        }

        targetSlot = slotToDropFrom;
        targetItem = slotToDropFrom.item;

        quantitySlider.minValue = 1;
        quantitySlider.maxValue = targetSlot.quantity;
        quantitySlider.wholeNumbers = true;
        quantitySlider.value = 1;

        UpdateQuantityText(quantitySlider.value);
        if(maxQuantityText != null) maxQuantityText.text = $"最多: {targetSlot.quantity}";
        if (dropPanel != null) dropPanel.SetActive(true);
        else gameObject.SetActive(true);

        // 可選：讓此面板處於最上層 (如果你的 UI 結構複雜)
        // transform.SetAsLastSibling();
    }

    private void HidePanel()
    {
        if (dropPanel != null) dropPanel.SetActive(false);
        else gameObject.SetActive(false);
        targetSlot = null;
        targetItem = null;
    }

    private void UpdateQuantityText(float value)
    {
        currentSelectedQuantity = Mathf.RoundToInt(value);
        if (quantityText != null)
        {
            quantityText.text = currentSelectedQuantity.ToString();
        }
    }

    private void ConfirmDrop()
    {
        if (targetSlot == null || targetItem == null)
        {
            Debug.LogError("確認拋棄時目標格子或物品為空！");
            HidePanel();
            return;
        }
        int quantityToDrop = currentSelectedQuantity;
        Debug.Log($"確認拋棄：物品 '{targetItem.itemName}', 數量 {quantityToDrop}");

        // 1. 通知 InventoryManager 從指定格子移除指定數量
        bool removed = InventoryManager.Instance.RemoveItemFromSlot(targetSlot, quantityToDrop);

        if (removed)
        {
            // 2. 如果移除成功，在玩家位置生成 GroundItem
            InventoryManager.Instance.SpawnGroundItem(targetItem, quantityToDrop, GetPlayerPosition());
            OnConfirmDropAction?.Invoke(targetItem, quantityToDrop);
        }
        else
        {
            Debug.LogWarning("從背包移除物品失敗 (可能是數量問題?)，未生成地上物品。");
        }
        HidePanel();
    }

    private void CancelDrop()
    {
        Debug.Log("取消拋棄。");
        HidePanel();
    }

    private Vector3 GetPlayerPosition()
    {
        Player player = FindObjectOfType<Player>();
        if (player != null)
        {
            return player.transform.position + player.transform.up * -0.3f;
        }
        else
        {
            Debug.LogError("找不到玩家物件來確定拋棄位置！");
            return Vector3.zero;
        }
    }

    void OnDestroy()
    {
        if (confirmButton != null) confirmButton.onClick.RemoveListener(ConfirmDrop);
        if (cancelButton != null) cancelButton.onClick.RemoveListener(CancelDrop);
        if (quantitySlider != null) quantitySlider.onValueChanged.RemoveListener(UpdateQuantityText);
    }
}
```

#### 2.11. `ItemDragHandler.cs`
```csharp
using UnityEngine;
using UnityEngine.EventSystems;
using UnityEngine.UI;

[RequireComponent(typeof(CanvasGroup))]
public class ItemDragHandler : MonoBehaviour, IBeginDragHandler, IDragHandler, IEndDragHandler
{
    private InventoryUI inventoryUI;
    private InventorySlotUI sourceSlotUI;
    private CanvasGroup canvasGroup;
    private Transform originalParent;
    private Vector3 startPosition;
    private Image draggedIcon;

    public void Initialize(InventoryUI ui, InventorySlotUI slot)
    {
        inventoryUI = ui;
        sourceSlotUI = slot;
        canvasGroup = GetComponent<CanvasGroup>();
        if (canvasGroup == null) canvasGroup = gameObject.AddComponent<CanvasGroup>(); // Ensure it exists
    }

    public void OnBeginDrag(PointerEventData eventData)
    {
        if (sourceSlotUI == null || sourceSlotUI.AssignedSlot == null || sourceSlotUI.AssignedSlot.IsEmpty())
        {
            eventData.pointerDrag = null;
            return;
        }
        Debug.Log($"Begin Drag on: {sourceSlotUI.AssignedSlot.item.itemName}");
        CreateDraggedIcon();
        startPosition = draggedIcon.rectTransform.position;
        originalParent = transform;
        canvasGroup.alpha = 0.6f;
        canvasGroup.blocksRaycasts = false;
        draggedIcon.rectTransform.position = Input.mousePosition;

    }

     private void CreateDraggedIcon()
    {
        GameObject draggedObject = new GameObject("Dragged Icon");
        draggedObject.transform.SetParent(inventoryUI.transform);
        draggedObject.transform.SetAsLastSibling();
        draggedObject.AddComponent<CanvasRenderer>();

        draggedIcon = draggedObject.AddComponent<Image>();
        draggedIcon.sprite = sourceSlotUI.AssignedSlot.item.icon;
        draggedIcon.rectTransform.sizeDelta = sourceSlotUI.GetComponent<RectTransform>().sizeDelta; // Match size
        draggedIcon.raycastTarget = false;
    }

    public void OnDrag(PointerEventData eventData)
    {
        if (draggedIcon != null)
        {
            draggedIcon.rectTransform.position = Input.mousePosition;
        }
    }

    public void OnEndDrag(PointerEventData eventData)
    {
        Debug.Log("End Drag");

        canvasGroup.alpha = 1.0f;
        canvasGroup.blocksRaycasts = true;

        if (draggedIcon != null)
        {
            Destroy(draggedIcon.gameObject);
            draggedIcon = null;
        }

        InventorySlotUI targetSlotUI = inventoryUI.GetSlotUIUnderPointer(eventData);

        if (targetSlotUI != null && targetSlotUI != sourceSlotUI)
        {
            Debug.Log($"Dropped onto slot index: {inventoryUI.GetSlotIndex(targetSlotUI)}");
            inventoryUI.HandleDrop(sourceSlotUI, targetSlotUI);
        }
        else
        {
            Debug.Log("Drop failed or dropped on self.");
        }
    }
}
```