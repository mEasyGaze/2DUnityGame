### **隊伍系統(Party System)**

**資料層 (Data Layer)**
1. MemberDataSO.cs (ScriptableObject)：
(1) 成員基礎模板 (由開發者在Unity編輯器中設定)
*   基礎資訊：成員ID (獨一無二的編號)、成員名稱、成員圖像 (`Sprite` 引用)。
*   基礎屬性：基礎血量、基礎攻擊力、體力(攻擊、施放技能消耗)、攻擊距離。
*   技能槽位：從技能腳本中挑選技能ID輸入。
*   成長規則：每級提升的血量、每級提升的攻擊力。(目前不需要，可註解)

2. PartyDatabase.cs (ScriptableObject)：
(1) 隊伍成員核心資料庫：一個中央 ScriptableObject。
(2) 成員名冊：包含遊戲中所有 `MemberDataSO` 的列表引用。
(3) 全局訪問：在遊戲啟動時載入，提供全局靜態方法，讓其他系統可以方便地透過ID獲取任何成員的模板數據。

3. MemberInstance.cs (可序列化 Class)：
(1) 玩家擁有的成員個體 (用於存檔)
*   關聯ID：`memberDataSO_ID`，用來關聯到對應的 `MemberDataSO` 模板。
*   唯一ID：`instanceID`，每個實例都有獨一無二的識別碼。
*   動態數據：等級、經驗值。(目前不需要，可註解)
*   狀態屬性：當前HP、當前攻擊力 (根據等級計算後的值)。
(2) 可序列化為 JSON：這個類別的物件會被寫入玩家的存檔中。

---

**Prefab & UI (預製件 & 隊伍介面)**
1. MemberCardUI.cs (Prefab)：
(1) 可重用UI元件：一個包含成員圖像、成員名稱和按鈕的獨立 Prefab。
(2) 數據填充：有一個腳本，接收 `MemberInstance` 資料並更新卡片上的圖像和名稱。
(3) 狀態反饋：包含被選中、在戰鬥隊伍中等不同的視覺狀態（例如發光邊框）。

2. MemberStatCardUI.cs (Prefab)：
(1) 可重用UI元件**: 一個包含成員圖像、成員名稱、攻擊力、體力、攻擊距離和按鈕的獨立 Prefab。
(2) 數據填充：有一個腳本，接收 `MemberInstance` 資料並更新卡片上的圖像和名稱。
(3) 狀態反饋：包含被選中、在戰鬥隊伍中等不同的視覺狀態（例如發光邊框）。

3. PartyHolderUI.cs (全部成員倉庫)：
(1) 顯示模式：使用 `Scroll View` 搭配 `Grid Layout Group` 來顯示目前擁有的所有成員卡片。
(2) 點擊互動：點擊任一成員卡片，會通知 `PartyDetailUI` 顯示其詳細資料。

4. PartyBattleUI.cs (戰鬥隊伍)：
(1) 顯示模式：使用固定的容器（例如 `Horizontal Layout Group`）顯示當前出戰的成員卡片和基礎屬性(名稱、圖像、血量、攻擊力)。
(2) 互動操作：支援點擊卡片查看詳細資料，以及拖曳卡片來交換戰鬥成員的順序。

5. PartyDetailUI.cs (成員詳細資料面板)：
(1) 顯示時機：預設隱藏，點擊任一成員卡片時顯示。
(2) 數據展示：顯示該成員的詳細數據（名稱、圖像、當前/最大HP、攻擊力、體力、攻擊距離）。
(3) 動態按鈕：提供「上陣」或「卸下」按鈕，按鈕的功能和文字會根據該成員是否已在戰鬥隊伍中動態改變。
(4) 隱藏邏輯：面板上有關閉按鈕；當整個隊伍介面關閉時，此詳細面板也應同步隱藏。

---

**Manager (管理器)**
1. PartyManager.cs：
(1) 核心邏輯：管理玩家擁有的 `AllMembers` (所有成員實例列表) 和 `BattleParty` (戰鬥隊伍成員實例列表)，並限制戰鬥隊伍人數。
(2) 功能：
*   加入/移除成員：處理 `MemberInstance` 的增減。
*   戰鬥隊伍管理：指派成員上陣、從戰鬥隊伍中移除。
*   排序：交換戰鬥成員的順序。
*   狀態判斷：提供方法判斷是否有可戰鬥的成員 (HP > 0)。
(3) 事件系統：
*   提供一個全局的 `OnPartyUpdated` 事件，當隊伍資料（成員增減、順序變更）發生變化時觸發，通知所有相關UI進行刷新。
(4) 存檔與載入：觸發 `JSONSaveManager` 來儲存或載入隊伍資料。

2. JSONSaveManager.cs(JSON 儲存、讀取系統)：
(1) 序列化/反序列化：專門負責將 `PartyManager` 中的 `MemberInstance` 列表轉換為 JSON 字串，或從 JSON 字串還原。
(2) 檔案管理：
*   將隊伍資料存為 JSON 檔。
*   從指定的路徑載入 JSON 檔。
*   管理存檔路徑，並檢查檔案是否存在。
(3) 資料驗證：載入存檔時，檢查存檔中的 `memberDataSO_ID` 在當前的 `PartyDatabase` 中是否依然存在，避免因遊戲版本更新造成錯誤。

---

**SkillPanel (技能面板)**
1. MemberSkillUI.cs(成員的技能面板)：
(1) 技能列表面板、技能詳情面板。

2. SkillListSlotUI.cs(Prefabs)：
(1) 技能圖、技能名稱、按鈕、高光。

3. SkillNameUI.cs(Prefabs)：
(1) 技能名稱、按鈕。
(2) 點擊按鈕後通知開啟技能詳情面板。

---

職責分離：系統的數據流向

```mermaid
graph TD
    subgraph "靜態數據 (遊戲資產)"
        A[MemberDataSO] --> B[PartyDatabase];
        B -- "提供成員模板" --> C[PartyManager];
    end

    subgraph "動態數據 (玩家存檔)"
        D[MemberInstance] --> E[PartyManager];
        E -- "管理玩家擁有的所有成員" --> F[PartyHolderUI];
        E -- "管理戰鬥隊伍" --> G[PartyBattleUI];
        E -- "序列化為JSON" --> H[JSONSaveManager];
    end

    C -- "創建實例" --> D;
    H -- "從JSON還原" --> E;

    style A fill:#D2E9FF,stroke:#333,stroke-width:2px
    style B fill:#D2E9FF,stroke:#333,stroke-width:2px
    style D fill:#FFE6CC,stroke:#333,stroke-width:2px
    style E fill:#FFE6CC,stroke:#333,stroke-width:2px
```

---

### 第 5 部分：成員與隊伍模組

#### 5.1. `MemberDataSO.cs`
```csharp
using UnityEngine;
using System.Collections.Generic;

[CreateAssetMenu(fileName = "NewMemberData", menuName = "Party System/Member Data")]
public class MemberDataSO : ScriptableObject
{
    [Header("基礎資訊")]
    public string memberID;
    public string memberName;
    public Sprite memberIcon;
    public GameObject unitPrefab;

    [Header("基礎屬性")]
    public int baseHealth;
    public int baseAttack;
    public int baseStamina;
    public int attackRange;

    [Header("技能槽位")]
    [Tooltip("在此輸入對應 SkillData 的技能ID")]
    public List<string> skillIDs;

    [Header("成長規則 (暫不使用)")]
    public int healthPerLevel;
    public int attackPerLevel;
}
```

#### 5.2. `PartyDatabase.cs`
```csharp
using UnityEngine;
using System.Collections.Generic;
using System.Linq;

[CreateAssetMenu(fileName = "PartyDatabase", menuName = "Party System/Party Database")]
public class PartyDatabase : ScriptableObject
{
    public List<MemberDataSO> allMembers;

    private static Dictionary<string, MemberDataSO> memberDictionary;
    private static bool isLoaded = false;

    private static void LoadDatabase()
    {
        if (isLoaded) return;
        
        var databaseInstance = Resources.Load<PartyDatabase>("PartyDatabase");
        if (databaseInstance == null)
        {
            Debug.LogError("嚴重錯誤：在 'Resources' 文件夾中找不到名為 'PartyDatabase' 的 ScriptableObject！");
            memberDictionary = new Dictionary<string, MemberDataSO>();
            isLoaded = true;
            return;
        }

        if (databaseInstance.allMembers == null)
        {
            databaseInstance.allMembers = new List<MemberDataSO>();
        }
        
        try
        {
            memberDictionary = databaseInstance.allMembers.ToDictionary(member => member.memberID, member => member);
            Debug.Log("[PartyDatabase] 隊伍資料庫已載入，共 " + memberDictionary.Count + " 名成員模板。");
        }
        catch (System.ArgumentException e)
        {
            Debug.LogError($"[PartyDatabase] 初始化失敗，發現重複的 memberID！請檢查您的 MemberDataSO 檔案。錯誤: {e.Message}");
            memberDictionary = new Dictionary<string, MemberDataSO>();
        }
        isLoaded = true;
    }

    public static MemberDataSO GetMemberDataByID(string id)
    {
        if (!isLoaded)
        {
            LoadDatabase();
        }

        if (memberDictionary == null)
        {
            Debug.LogError("[PartyDatabase] 字典尚未初始化！無法查詢成員。");
            return null;
        }

        memberDictionary.TryGetValue(id, out MemberDataSO data);
        if (data == null)
        {
            Debug.LogWarning($"[PartyDatabase] 在資料庫中找不到ID為 '{id}' 的成員資料。");
        }
        return data;
    }
}
```

#### 5.3. `MemberInstance.cs`
```csharp
using System;
using System.Collections.Generic;
using System.Linq;
using UnityEngine;

[System.Serializable]
public class MemberInstance
{
    public string memberDataSO_ID;
    public string instanceID;
    public int level;
    public int experience;
    public int currentHP;
    public int currentStamina;

    [NonSerialized]
    private MemberDataSO _baseData;
    public MemberDataSO BaseData
    {
        get
        {
            if (_baseData == null)
            {
                _baseData = PartyDatabase.GetMemberDataByID(memberDataSO_ID);
                if (_baseData == null)
                {
                    Debug.LogError($"無法為 instanceID '{instanceID}' 找到 memberDataSO_ID '{memberDataSO_ID}' 對應的模板數據！這可能是因為存檔數據過時或模板被刪除。");
                }
            }
            return _baseData;
        }
    }

    public int MaxHP => BaseData != null ? BaseData.baseHealth + (level - 1) * BaseData.healthPerLevel : 1;
    public int CurrentAttack => BaseData != null ? BaseData.baseAttack + (level - 1) * BaseData.attackPerLevel : 0;
    public int MaxStamina => BaseData != null ? BaseData.baseStamina : 0;

    [NonSerialized]
    private List<SkillData> _skills;
    public List<SkillData> Skills
    {
        get
        {
            if (BaseData == null) return new List<SkillData>();
            if (_skills == null)
            {
                if (SkillManager.Instance != null)
                {
                    _skills = BaseData.skillIDs
                        .Select(id => SkillManager.Instance.Database.GetSkillDataByID(id))
                        .Where(skill => skill != null)
                        .ToList();
                }
                else
                {
                    _skills = new List<SkillData>();
                    Debug.LogError("無法獲取技能列表，因為 SkillManager 不存在！");
                }
            }
            return _skills;
        }
    }

    public MemberInstance(string so_id, int startLevel = 1)
    {
        memberDataSO_ID = so_id;
        instanceID = Guid.NewGuid().ToString();
        level = startLevel;
        experience = 0;
        
        if (BaseData != null)
        {
            currentHP = MaxHP;
            currentStamina = MaxStamina;
        }
        else
        {
            currentHP = 1;
            currentStamina = 0;
        }
    }

    public MemberInstance() { }
}
```

#### 5.4. `MemberCardUI.cs`
```csharp
using UnityEngine;
using UnityEngine.UI;
using TMPro;
using UnityEngine.EventSystems;

public class MemberCardUI : MonoBehaviour
{
    [SerializeField] private Image memberIconImage;
    [SerializeField] private TextMeshProUGUI memberNameText;
    [SerializeField] private Button cardButton;
    [SerializeField] private GameObject selectedBorder;
    [SerializeField] private GameObject inBattleIndicator;

    private MemberInstance currentMember;

    public void Setup(MemberInstance memberInstance, System.Action<MemberInstance> onClickCallback)
    {
        currentMember = memberInstance;
        if (currentMember.BaseData != null)
        {
            memberNameText.text = currentMember.BaseData.memberName;
            memberIconImage.sprite = currentMember.BaseData.memberIcon;
            cardButton.interactable = true;
        }
        else
        {
            memberNameText.text = "數據錯誤";
            memberIconImage.sprite = null; 
            cardButton.interactable = false;
        }
        
        cardButton.onClick.RemoveAllListeners();
        cardButton.onClick.AddListener(() => 
        {
            if (InventoryManager.Instance.IsSelectingTarget)
            {
                InventoryManager.Instance.ConfirmItemUsageOnMember(currentMember);
            }
            else
            {
                onClickCallback(currentMember);
            }
        });
    }

    public void UpdateVisualState(bool isSelected, bool isInBattleParty)
    {
        if (selectedBorder != null)
        {
            selectedBorder.SetActive(isSelected);
        }
        if (inBattleIndicator != null)
        {
            inBattleIndicator.SetActive(isInBattleParty);
        }
    }
}
```

#### 5.5. `MemberStatCardUI.cs`
```csharp
using UnityEngine;
using UnityEngine.UI;
using TMPro;

public class MemberStatCardUI : MonoBehaviour
{
    [Header("基礎連結")]
    [SerializeField] private Image memberIconImage;
    [SerializeField] private TextMeshProUGUI memberNameText;
    [SerializeField] private Button cardButton;
    [SerializeField] private GameObject selectedBorder;

    [Header("互動連結")]
    [SerializeField] private Button removeButton;
    [SerializeField] private Button skillButton;

    [Header("屬性連結")]
    [SerializeField] private TextMeshProUGUI hpText;
    [SerializeField] private TextMeshProUGUI attackText;
    [SerializeField] private TextMeshProUGUI staminaText;
    [SerializeField] private TextMeshProUGUI attackRangeText;

    private MemberInstance currentMember;

    public void Setup(MemberInstance memberInstance, System.Action<MemberInstance> onClickCallback)
    {
        currentMember = memberInstance;
        if (currentMember.BaseData == null) return;

        MemberDataSO baseData = currentMember.BaseData;
        memberNameText.text = baseData.memberName;
        memberIconImage.sprite = baseData.memberIcon;

        hpText.text = $"{currentMember.currentHP}/{currentMember.MaxHP}";
        attackText.text = $"{currentMember.CurrentAttack}";
        staminaText.text = $"{currentMember.currentStamina}/{currentMember.MaxStamina}";
        attackRangeText.text = $"{baseData.attackRange}";

        cardButton.onClick.RemoveAllListeners();
        cardButton.onClick.AddListener(() => 
        {
            if (InventoryManager.Instance.IsSelectingTarget)
            {
                InventoryManager.Instance.ConfirmItemUsageOnMember(currentMember);
            }
            else
            {
                onClickCallback?.Invoke(currentMember);
            }
        });
        if (removeButton != null)
        {
            removeButton.onClick.RemoveAllListeners();
            removeButton.onClick.AddListener(() => 
            {
                PartyManager.Instance.RemoveFromBattleParty(currentMember);
            });
        }
        if (skillButton != null)
        {
            skillButton.onClick.RemoveAllListeners();
            skillButton.onClick.AddListener(() => 
            {
                if (MemberSkillUI.Instance != null)
                {
                    MemberSkillUI.Instance.ShowSkillList(currentMember);
                }
            });
        }
    }

    public void UpdateVisualState(bool isSelected)
    {
        if (selectedBorder != null)
        {
            selectedBorder.SetActive(isSelected);
        }
    }

    public void SetRemoveButtonVisible(bool isVisible)
    {
        if (removeButton != null)
        {
            removeButton.gameObject.SetActive(isVisible);
        }
    }
}
```

#### 5.6. `PartyHolderUI.cs`
```csharp
using UnityEngine;
using System.Collections.Generic;

public class PartyHolderUI : MonoBehaviour
{
    [SerializeField] private GameObject holderPanel;
    [SerializeField] private Transform contentParent;
    [SerializeField] private MemberCardUI cardPrefab;

    private List<MemberCardUI> spawnedCards = new List<MemberCardUI>();

    private void Awake()
    {
        if (holderPanel == null) holderPanel = this.gameObject;
        holderPanel.SetActive(false);
        SaveManager.OnGameLoadComplete += HandleGameLoadComplete;
    }

    private void OnEnable()
    {
        PartyManager.OnPartyUpdated += UpdateUI;
        if (holderPanel.activeSelf)
        {
            UpdateUI();
        }
    }

    private void OnDisable()
    {
        PartyManager.OnPartyUpdated -= UpdateUI;
        if (PartyDetailUI.Instance != null)
        {
            PartyDetailUI.Instance.Hide();
        }
    }

    private void OnDestroy()
    {
        SaveManager.OnGameLoadComplete -= HandleGameLoadComplete;
    }

    private void HandleGameLoadComplete()
    {
        if (holderPanel.activeSelf)
        {
            Debug.Log("[PartyHolderUI] 監聽到遊戲加載完成，正在刷新...");
            UpdateUI();
        }
    }

    public void TogglePanel()
    {
        bool isActive = !holderPanel.activeSelf;
        holderPanel.SetActive(isActive);

        if (isActive)
        {
            UpdateUI();
        }
    }

    private void UpdateUI()
    {
        if (PartyManager.Instance == null) return;
        foreach (var card in spawnedCards)
        {
            Destroy(card.gameObject);
        }
        spawnedCards.Clear();

        foreach (var member in PartyManager.Instance.AllMembers)
        {
            MemberCardUI newCard = Instantiate(cardPrefab, contentParent);
            newCard.Setup(member, OnMemberCardClicked);
            
            bool isSelected = PartyDetailUI.Instance != null && PartyDetailUI.Instance.IsShowingDetailsFor(member);
            bool isInBattle = PartyManager.Instance.BattleParty.Contains(member);
            newCard.UpdateVisualState(isSelected, isInBattle);
            
            spawnedCards.Add(newCard);
        }
    }

    private void OnMemberCardClicked(MemberInstance member)
    {
        PartyDetailUI.Instance.ShowMemberDetails(member);
        UpdateUI();
    }
}
```

#### 5.7. `PartyBattleUI.cs`
```csharp
using UnityEngine;
using System.Collections.Generic;

public class PartyBattleUI : MonoBehaviour
{
    [SerializeField] private GameObject battlePanel;
    [SerializeField] private Transform battleSlotsParent;
    [SerializeField] private MemberStatCardUI cardPrefab; 

    private List<MemberStatCardUI> spawnedCards = new List<MemberStatCardUI>();

    private void Awake()
    {
        if (battlePanel == null) battlePanel = this.gameObject;
        battlePanel.SetActive(false);
    }

    private void OnEnable()
    {
        PartyManager.OnPartyUpdated += UpdateUI;
        InventoryManager.OnItemSelectionModeChanged += HandleItemSelectionModeChanged;
        HandleItemSelectionModeChanged(InventoryManager.Instance.IsSelectingTarget);
    }

    private void OnDisable()
    {
        PartyManager.OnPartyUpdated -= UpdateUI;
        InventoryManager.OnItemSelectionModeChanged -= HandleItemSelectionModeChanged;
        if (PartyDetailUI.Instance != null)
        {
            PartyDetailUI.Instance.Hide();
        }
    }

    public void TogglePanel()
    {
        bool isActive = !battlePanel.activeSelf;
        battlePanel.SetActive(isActive);
        if (isActive)
        {
            UpdateUI();
        }
    }

    private void UpdateUI()
    {
        if (PartyManager.Instance == null) return;
        foreach (var card in spawnedCards)
        {
            if (card != null) Destroy(card.gameObject);
        }
        spawnedCards.Clear();
        foreach (var member in PartyManager.Instance.BattleParty)
        {
            MemberStatCardUI newCard = Instantiate(cardPrefab, battleSlotsParent);
            
            newCard.Setup(member, null); 
            newCard.SetRemoveButtonVisible(!InventoryManager.Instance.IsSelectingTarget);
            newCard.UpdateVisualState(false); 
            
            spawnedCards.Add(newCard);
        }
    }

    private void HandleItemSelectionModeChanged(bool isSelecting)
    {
        foreach (var card in spawnedCards)
        {
            if (card != null)
            {
                card.SetRemoveButtonVisible(!isSelecting);
            }
        }
    }
}
```

#### 5.8. `PartyDetailUI.cs`
```csharp
using UnityEngine;
using UnityEngine.UI;
using TMPro;

public class PartyDetailUI : MonoBehaviour
{
    public static PartyDetailUI Instance { get; private set; }
    
    [Header("UI 連結")]
    [SerializeField] private GameObject detailPanel;
    [SerializeField] private MemberSkillUI memberSkillPanel;
    [SerializeField] private Image memberIcon;
    [SerializeField] private TextMeshProUGUI memberNameText;
    // *** 移除: [SerializeField] private TextMeshProUGUI levelText; ***
    // *** 移除: [SerializeField] private TextMeshProUGUI expText; ***
    [SerializeField] private TextMeshProUGUI hpText;
    [SerializeField] private TextMeshProUGUI attackText;
    [SerializeField] private TextMeshProUGUI staminaText;
    [SerializeField] private TextMeshProUGUI attackRangeText;

    [Header("互動元件")]
    [SerializeField] private Button actionButton;
    [SerializeField] private TextMeshProUGUI actionButtonText;
    [SerializeField] private Button closeButton;
    [SerializeField] private Button skillsButton;
    
    private MemberInstance currentMember;

    private void Awake()
    {
        if (Instance != null && Instance != this)
        {
            Destroy(gameObject);
            return;
        }
        Instance = this;
        
        detailPanel.SetActive(false);
        closeButton.onClick.AddListener(Hide);
    }
    
    public void ShowMemberDetails(MemberInstance member)
    {
        currentMember = member;
        detailPanel.SetActive(true);
        MemberDataSO baseData = member.BaseData;

        memberIcon.sprite = baseData.memberIcon;
        memberNameText.text = baseData.memberName;
        hpText.text = $"{member.currentHP} / {member.MaxHP}";
        attackText.text = $"{member.CurrentAttack}";
        staminaText.text = $"{member.currentStamina} / {member.MaxStamina}";
        attackRangeText.text = $"{baseData.attackRange}";
        // levelText.text = $"等級: {member.level}";
        // expText.text = $"經驗值: {member.experience} / 100"; 

        bool isInBattleParty = PartyManager.Instance.BattleParty.Contains(member);
        if (isInBattleParty)
        {
            actionButtonText.text = "移除";
            actionButton.onClick.RemoveAllListeners();
            actionButton.onClick.AddListener(RemoveFromBattleParty);
        }
        else
        {
            actionButtonText.text = "上陣";
            actionButton.onClick.RemoveAllListeners();
            actionButton.onClick.AddListener(AddToBattleParty);
        }

        if (skillsButton != null)
        {
            skillsButton.onClick.RemoveAllListeners();
            skillsButton.onClick.AddListener(() => 
            {
                if (MemberSkillUI.Instance != null)
                {
                    MemberSkillUI.Instance.ShowSkillList(member);
                }
            });
        }
    }

    public void Hide()
    {
        currentMember = null;
        detailPanel.SetActive(false);
        
        if (PartyManager.Instance != null)
        {
            PartyManager.Instance.NotifyPartyUpdated();
        }
    }
    
    public bool IsShowingDetailsFor(MemberInstance member)
    {
        return detailPanel.activeSelf && currentMember == member;
    }

    private void AddToBattleParty()
    {
        if (currentMember != null)
        {
            PartyManager.Instance.SetToBattleParty(currentMember);
            ShowMemberDetails(currentMember);
        }
    }

    private void RemoveFromBattleParty()
    {
        if (currentMember != null)
        {
            PartyManager.Instance.RemoveFromBattleParty(currentMember);
            ShowMemberDetails(currentMember);
        }
    }
}
```

#### 5.9. `PartyManager.cs`
```csharp
using UnityEngine;
using System.Collections.Generic;
using System.Linq;

public class PartyManager : MonoBehaviour, IGameSaveable
{
    public static PartyManager Instance { get; private set; }

    [Header("隊伍設定")]
    [SerializeField] private int maxBattlePartySize = 4;

    [Header("玩家隊伍資料 (運行時狀態)")]
    public List<MemberInstance> AllMembers = new List<MemberInstance>();
    public List<MemberInstance> BattleParty = new List<MemberInstance>();

    public static event System.Action OnPartyUpdated;

    private bool isLoading = false;

    private void Awake()
    {
        if (Instance != null && Instance != this)
        {
            Destroy(gameObject);
            return;
        }
        Instance = this;
        DontDestroyOnLoad(gameObject);
        AllMembers.Clear();
        BattleParty.Clear();
        SaveManager.Instance.Register(this);
    }

    void OnDestroy()
    {
        if (SaveManager.Instance != null)
        {
            SaveManager.Instance.Unregister(this);
        }
    }

    public void AddMemberToHolder(string memberID)
    {
        if (AllMembers.Any(m => m.memberDataSO_ID == memberID))
        {
            Debug.Log($"玩家已擁有成員模板ID '{memberID}' 的實例，不再重複添加。");
            
            MemberInstance existingMember = AllMembers.FirstOrDefault(m => m.memberDataSO_ID == memberID);
            if (existingMember != null && !BattleParty.Contains(existingMember))
            {
                SetToBattleParty(existingMember);
            }
            return;
        }

        MemberDataSO data = PartyDatabase.GetMemberDataByID(memberID);
        if (data != null)
        {
            MemberInstance newMember = new MemberInstance(memberID);
            AllMembers.Add(newMember);
            Debug.Log($"已將成員 [{data.memberName}] 加入到玩家的倉庫 (AllMembers)。");
            if (!isLoading) NotifyPartyUpdated();
        }
        else
        {
            Debug.LogWarning($"嘗試新增ID為 '{memberID}' 的成員失敗，在資料庫中找不到該成員。");
        }
    }

    public void RemoveMemberCompletely(string memberID)
    {
        MemberInstance memberToRemove = AllMembers.FirstOrDefault(m => m.memberDataSO_ID == memberID);

        if (memberToRemove != null)
        {
            if (BattleParty.Contains(memberToRemove))
            {
                BattleParty.Remove(memberToRemove);
            }
            AllMembers.Remove(memberToRemove);
            Debug.Log($"已從隊伍中徹底移除成員 [{memberToRemove.BaseData.memberName}]。");
            if (!isLoading) NotifyPartyUpdated();
        }
        else
        {
            Debug.LogWarning($"嘗試移除ID為 '{memberID}' 的成員失敗，玩家並不擁有該成員。");
        }
    }

    public bool SetToBattleParty(MemberInstance member)
    {
        if (BattleParty.Count >= maxBattlePartySize)
        {
            Debug.LogWarning("戰鬥隊伍已滿，無法新增！");
            return false;
        }
        if (AllMembers.Contains(member) && !BattleParty.Contains(member))
        {
            BattleParty.Add(member);
            Debug.Log($"成員 [{member.BaseData.memberName}] 已上陣。");
            if (!isLoading) NotifyPartyUpdated();
            return true;
        }
        return false;
    }

    public void RemoveFromBattleParty(MemberInstance member)
    {
        if (BattleParty.Contains(member))
        {
            BattleParty.Remove(member);
            Debug.Log($"成員 [{member.BaseData.memberName}] 已卸下。");
            if (!isLoading) NotifyPartyUpdated();
        }
    }

    public void SwapBattlePartyOrder(int fromIndex, int toIndex)
    {
        if (fromIndex < 0 || fromIndex >= BattleParty.Count || toIndex < 0 || toIndex >= BattleParty.Count || fromIndex == toIndex)
        {
            return;
        }
        MemberInstance temp = BattleParty[fromIndex];
        BattleParty[fromIndex] = BattleParty[toIndex];
        BattleParty[toIndex] = temp;
        Debug.Log($"交換了戰鬥隊伍位置 {fromIndex} 和 {toIndex}。");
        if (!isLoading) NotifyPartyUpdated();
    }

    public bool HasBattleReadyMembers()
    {
        return BattleParty != null && BattleParty.Any(member => member.currentHP > 0);
    }

    public void NotifyPartyUpdated()
    {
        // Debug.Log("[PartyManager] 觸發 OnPartyUpdated 事件。");
        OnPartyUpdated?.Invoke();
    }

    #region 存檔資料
    public void PopulateSaveData(GameSaveData data)
    {
        data.partyData.allMembers = this.AllMembers;
        data.partyData.battlePartyInstanceIDs = this.BattleParty.Select(m => m.instanceID).ToList();
    }

    public void LoadFromSaveData(GameSaveData data)
    {
        isLoading = true;

        if (data.partyData == null)
        {
            AllMembers = new List<MemberInstance>();
            BattleParty = new List<MemberInstance>();
            isLoading = false;
            return;
        }
        
        AllMembers = data.partyData.allMembers ?? new List<MemberInstance>();
        
        if (AllMembers.Count > 0)
        {
            AllMembers.RemoveAll(instance => 
                string.IsNullOrEmpty(instance.memberDataSO_ID) || 
                PartyDatabase.GetMemberDataByID(instance.memberDataSO_ID) == null
            );
        }
        
        BattleParty.Clear();
        if (data.partyData.battlePartyInstanceIDs != null)
        {
            foreach (string instanceId in data.partyData.battlePartyInstanceIDs)
            {
                MemberInstance member = AllMembers.FirstOrDefault(m => m.instanceID == instanceId);
                if (member != null)
                {
                    BattleParty.Add(member);
                }
            }
        }
        isLoading = false;
    }
    #endregion
}
```

#### 5.10. `JSONSaveManager.cs`
```csharp
using UnityEngine;
using System.IO;
using System.Collections.Generic;

[System.Serializable]
public class PartySaveData
{
    public List<MemberInstance> AllMembers;
    public List<string> BattlePartyInstanceIDs;
}

public static class JSONSaveManager
{
    private static readonly string fileName = "PartyData.json";

    private static string GetSavePath()
    {
        return Path.Combine(Application.persistentDataPath, fileName);
    }

    public static void SavePartyData(List<MemberInstance> allMembers, List<string> battlePartyInstanceIDs)
    {
        PartySaveData saveData = new PartySaveData
        {
            AllMembers = allMembers,
            BattlePartyInstanceIDs = battlePartyInstanceIDs
        };

        string json = JsonUtility.ToJson(saveData, true);
        File.WriteAllText(GetSavePath(), json);
    }

    public static PartySaveData LoadPartyData()
    {
        string path = GetSavePath();
        if (File.Exists(path))
        {
            string json = File.ReadAllText(path);
            PartySaveData saveData = JsonUtility.FromJson<PartySaveData>(json);

            if (saveData != null && saveData.AllMembers != null)
            {
                saveData.AllMembers.RemoveAll(instance => PartyDatabase.GetMemberDataByID(instance.memberDataSO_ID) == null);
            }

            return saveData;
        }
        else
        {
            Debug.Log("找不到存檔檔案，將創建新的隊伍資料。");
            return null;
        }
    }
}
```

#### 5.11. `MemberSkillUI.cs`
```csharp
using UnityEngine;
using UnityEngine.UI;
using TMPro;
using System.Collections.Generic;

public class MemberSkillUI : MonoBehaviour
{
    public static MemberSkillUI Instance { get; private set; }

    [Header("列表面板")]
    [SerializeField] private GameObject listPanel;
    [SerializeField] private TextMeshProUGUI listTitleText;
    [SerializeField] private Transform listContainer;
    [SerializeField] private SkillNameSlotUI slotPrefab;
    [SerializeField] private Button listCloseButton;

    [Header("詳情面板")]
    [SerializeField] private GameObject detailsPanel;
    [SerializeField] private TextMeshProUGUI skillNameText;
    [SerializeField] private TextMeshProUGUI staminaCostText;
    [SerializeField] private TextMeshProUGUI targetTypeText;
    [SerializeField] private TextMeshProUGUI descriptionText;
    [SerializeField] private Button detailsCloseButton;

    private List<SkillNameSlotUI> spawnedSlots = new List<SkillNameSlotUI>();

    void Awake()
    {
        if (Instance != null && Instance != this) { Destroy(gameObject); return; }
        Instance = this;

        listCloseButton.onClick.AddListener(CloseList);
        detailsCloseButton.onClick.AddListener(CloseDetails);
        CloseAll();
    }

    public void ShowSkillList(MemberInstance member)
    {
        if (member == null) return;
        CloseDetails();
        listPanel.SetActive(true);
        
        if (listTitleText != null) listTitleText.text = $"{member.BaseData.memberName} 的技能";
        foreach (var slot in spawnedSlots) Destroy(slot.gameObject);
        spawnedSlots.Clear();
        if (member.Skills != null)
        {
            foreach (var skill in member.Skills)
            {
                var slot = Instantiate(slotPrefab, listContainer);
                slot.Setup(skill, ShowSkillDetails);
                spawnedSlots.Add(slot);
            }
        }
    }

    private void ShowSkillDetails(SkillData skill)
    {
        detailsPanel.SetActive(true);
        // listPanel.SetActive(false); 

        skillNameText.text = skill.skillName;
        staminaCostText.text = $"消耗體力: {skill.staminaCost}";
        targetTypeText.text = $"目標: {GetTargetTypeString(skill.targetType)}";
        descriptionText.text = skill.skillDescription;
    }

    public void CloseList()
    {
        listPanel.SetActive(false);
        CloseDetails();
    }

    public void CloseDetails()
    {
        detailsPanel.SetActive(false);
    }

    public void CloseAll()
    {
        listPanel.SetActive(false);
        detailsPanel.SetActive(false);
    }

    private string GetTargetTypeString(SkillTargetType type)
    {
        switch (type)
        {
            case SkillTargetType.Enemy_Single: return "單體敵人";
            case SkillTargetType.Enemy_All: return "全體敵人";
            case SkillTargetType.Ally_Single: return "單體隊友";
            case SkillTargetType.Ally_All: return "全體隊友";
            case SkillTargetType.Self: return "自身";
            default: return type.ToString();
        }
    }
}
```

#### 5.12. `SkillListSlotUI.cs`
```csharp
using UnityEngine;
using UnityEngine.UI;
using TMPro;

public class SkillListSlotUI : MonoBehaviour
{
    [SerializeField] private Image iconImage;
    [SerializeField] private TextMeshProUGUI nameText;
    [SerializeField] private Button button;
    [SerializeField] private GameObject selectedHighlight;

    private SkillData skillData;
    private System.Action<SkillData> onClickCallback;

    public void Setup(SkillData skill, System.Action<SkillData> callback)
    {
        skillData = skill;
        onClickCallback = callback;

        if (skill != null)
        {
            nameText.text = skill.skillName;
            iconImage.sprite = skill.skillIcon;
            // iconImage.enabled = skill.icon != null;
        }

        button.onClick.RemoveAllListeners();
        button.onClick.AddListener(() => 
        {
            onClickCallback?.Invoke(skillData);
            SetSelected(true);
        });
        
        SetSelected(false);
    }

    public void SetSelected(bool isSelected)
    {
        if (selectedHighlight != null) selectedHighlight.SetActive(isSelected);
    }
}
```

#### 5.13. `SkillNameSlotUI.cs`
```csharp
using UnityEngine;
using UnityEngine.UI;
using TMPro;

public class SkillNameSlotUI : MonoBehaviour
{
    [SerializeField] private TextMeshProUGUI nameText;
    [SerializeField] private Button button;

    private SkillData skillData;
    private System.Action<SkillData> onClickCallback;

    public void Setup(SkillData skill, System.Action<SkillData> callback)
    {
        skillData = skill;
        onClickCallback = callback;

        if (skill != null)
        {
            nameText.text = skill.skillName;
        }

        button.onClick.RemoveAllListeners();
        button.onClick.AddListener(() => onClickCallback?.Invoke(skillData));
    }
}
```

#### 5.14. `SkillSelectionPanelUI.cs`
```csharp
using UnityEngine;
using System.Collections.Generic;

public class SkillSelectionPanelUI : MonoBehaviour
{
    [Header("UI 參考")]
    [SerializeField] private GameObject panel;
    [SerializeField] private Transform buttonContainer;
    [SerializeField] private SkillButtonUI buttonPrefab;

    private List<SkillButtonUI> spawnedButtons = new List<SkillButtonUI>();

    void Awake()
    {
        if (panel == null) panel = this.gameObject;
        panel.SetActive(false);
    }

    public void ShowPanel(Dictionary<SkillData, bool> skillFeasibility, System.Action<SkillData> onSkillSelectedCallback)
    {
        ClearButtons();

        if (skillFeasibility == null || skillFeasibility.Count == 0)
        {
            BattleLog.Instance.AddLog("此單位沒有可用的技能。");
            return;
        }

        foreach (var pair in skillFeasibility)
        {
            SkillData skill = pair.Key;
            bool isUsable = pair.Value;
            SkillButtonUI newButton = Instantiate(buttonPrefab, buttonContainer);
            
            System.Action<SkillData> wrappedCallback = (selectedSkill) => {
                onSkillSelectedCallback(selectedSkill);
                HidePanel();
            };
            newButton.Setup(skill, isUsable, wrappedCallback);
            spawnedButtons.Add(newButton);
        }

        panel.SetActive(true);
    }

    public void HidePanel()
    {
        panel.SetActive(false);
        ClearButtons();
    }

    private void ClearButtons()
    {
        foreach (var btn in spawnedButtons)
        {
            if (btn != null) Destroy(btn.gameObject);
        }
        spawnedButtons.Clear();
    }
}
```