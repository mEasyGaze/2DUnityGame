#### **四、 任務系統模組 (Quest System Module)**

1. QuestData.cs(任務資料藍圖)：
(1) 主要任務類別：ID、名稱、描述、目標、發布者、回報者、前提條件、可重複性、獎勵。
(2) 任務目標：type(收集,殺敵,對話,前往某地)、targetID(怪物ID,物品ID)、requiredAmount(數量)、currentAmount(已完成數量)
(3) 物品獎勵：定義物品和數量(itemID,amount)。

2. QuestDatabase.cs(任務資料庫):
(1) 讀取任務檔案：讀取所有用 XML 格式寫好的任務檔案。
(2) 建立任務目錄：將整理好 QuestData 存儲。
(3) 提供任務範本：`GetQuest()` 供 `QuestManager` 獲取任務的原始模板。

3. QuestManager.cs(任務管理器):
(1) 追蹤玩家進度：追蹤每個任務的當前狀態 (`NotStarted`, `InProgress`, `Completed`) 和進度。
(2) 處理任務流程：提供接受 (`AcceptQuest`)、完成 (`CompleteQuest`) 任務的接口。
(3) 更新任務進度：「監聽」遊戲中發生的各種事件，如：收集物品、擊殺怪物。
(4) 與 NPC 互動：顯示出驚嘆號 ! 或問號 ?。
(5) 發布通知：任務狀態有任何改變時。

4. QuestUI.cs:
(1) 顯示進行中的任務和任務詳細資訊。
(2) 自動更新畫面。

---

### 第 4 部分：任務系統模組

#### 4.1. `QuestData.cs`
```csharp
using System.Collections.Generic;
using System.Xml.Serialization;
using UnityEngine;

public enum QuestObjectiveType { Collect, Kill, Talk, GoTo }

[System.Serializable]
public class QuestObjective
{
    [XmlAttribute("type")]
    public QuestObjectiveType type;

    [XmlAttribute("targetID")]
    public string targetID;

    [XmlAttribute("amount")]
    public int requiredAmount;

    [XmlAttribute("description")]
    public string description;

    [XmlAttribute("prereqIndex")]
    [System.ComponentModel.DefaultValue(-1)]
    public int prerequisiteIndex = -1;

    [XmlIgnore]
    public int currentAmount = 0;

    [XmlIgnore]
    public int startingAmount = 0;

    [XmlIgnore]
    public bool IsComplete => currentAmount >= requiredAmount;
}

[System.Serializable]
public class ItemReward
{
    [XmlAttribute("id")]
    public string itemID;

    [XmlAttribute("amount")]
    public int amount;
}

[System.Serializable]
public class Quest
{
    public enum QuestStatus { NotStarted, InProgress, Completed, Failed }
    
    [XmlAttribute("id")]
    public string questID;
    
    [XmlElement("Name")]
    public string questName;

    [XmlElement("Description")]
    public string description;
    
    [XmlElement("GiverNPC")]
    public string giverNPCID;

    [XmlElement("HandInNPC")]
    public string handInNPCID;
    
    [XmlArray("Prerequisites")]
    [XmlArrayItem("QuestID")]
    public List<string> prerequisiteQuestIDs = new List<string>();

    [XmlElement("IsRepeatable")]
    public bool isRepeatable = false;
    
    [XmlArray("Objectives")]
    [XmlArrayItem("Objective")]
    public List<QuestObjective> objectives = new List<QuestObjective>();
    
    [XmlArray("Rewards")]
    [XmlArrayItem("Item")]
    public List<ItemReward> itemRewards = new List<ItemReward>();
    
    [XmlElement("Money")]
    public int moneyReward;
    
    public bool AreAllObjectivesComplete()
    {
        foreach (var obj in objectives)
        {
            if (obj.currentAmount < obj.requiredAmount)
            {
                return false;
            }
        }
        return true;
    }
    
    public void ResetProgress()
    {
        foreach (var obj in objectives)
        {
            obj.currentAmount = 0;
        }
    }
}
```

#### 4.2. `QuestDatabase.cs`
```csharp
using UnityEngine;
using System.Collections.Generic;
using System.IO;
using System.Xml.Serialization;
using System.Linq;

public static class QuestDatabase
{
    private static Dictionary<string, Quest> quests;
    private static bool isLoaded = false;

    private static void LoadDatabase()
    {
        if (isLoaded) return;
        quests = new Dictionary<string, Quest>();
        
        TextAsset[] questFiles = Resources.LoadAll<TextAsset>("GameData/Quests");
        if (questFiles.Length == 0)
        {
            Debug.LogWarning("[QuestDatabase] 在 'Resources/GameData/Quests' 資料夾中找不到任何任務檔案。");
            isLoaded = true;
            return;
        }

        foreach (var questFile in questFiles)
        {
            XmlSerializer serializer = new XmlSerializer(typeof(Quest));
            using (StringReader reader = new StringReader(questFile.text))
            {
                try
                {
                    Quest quest = (Quest)serializer.Deserialize(reader);
                    if (quest != null && !string.IsNullOrEmpty(quest.questID))
                    {
                        if (!quests.ContainsKey(quest.questID))
                        {
                            quests.Add(quest.questID, quest);
                        }
                        else
                        {
                            Debug.LogWarning($"[QuestDatabase] 發現重複的任務 ID: {quest.questID} (在檔案 {questFile.name} 中)。");
                        }
                    }
                }
                catch (System.Exception e)
                {
                    Debug.LogError($"[QuestDatabase] 解析任務檔案 '{questFile.name}' 失敗: {e.Message}");
                }
            }
        }
        Debug.Log($"[QuestDatabase] 成功載入 {quests.Count} 個獨立任務。");
        isLoaded = true;
    }

    public static Quest GetQuest(string questID)
    {
        LoadDatabase();
        if (quests.TryGetValue(questID, out Quest questTemplate))
        {
            return new Quest
            {
                questID = questTemplate.questID,
                questName = questTemplate.questName,
                description = questTemplate.description,
                giverNPCID = questTemplate.giverNPCID,
                handInNPCID = questTemplate.handInNPCID,
                prerequisiteQuestIDs = new List<string>(questTemplate.prerequisiteQuestIDs),
                isRepeatable = questTemplate.isRepeatable,
                
                objectives = questTemplate.objectives.Select(o => new QuestObjective {
                    type = o.type,
                    targetID = o.targetID,
                    requiredAmount = o.requiredAmount,
                    description = o.description,
                    currentAmount = 0,
                    startingAmount = 0,
                    prerequisiteIndex = o.prerequisiteIndex
                }).ToList(),
                
                itemRewards = new List<ItemReward>(questTemplate.itemRewards),
                moneyReward = questTemplate.moneyReward
            };
        }
        Debug.LogWarning($"[QuestDatabase] 找不到 ID 為 '{questID}' 的任務。");
        return null;
    }
}
```

#### 4.3. `QuestManager.cs`
```csharp
using UnityEngine;
using System;
using System.Collections.Generic;
using System.Linq;

public class QuestManager : MonoBehaviour, IGameSaveable
{
    public static QuestManager Instance { get; private set; }

    private Dictionary<string, Quest.QuestStatus> questStatuses = new Dictionary<string, Quest.QuestStatus>();
    private Dictionary<string, Quest> activeQuests = new Dictionary<string, Quest>();
    private Dictionary<string, NPC> npcCache = new Dictionary<string, NPC>();
    private HashSet<string> permanentlyCompletedQuestIDs = new HashSet<string>();

    public event Action<string> OnQuestAccepted;
    public event Action<string> OnQuestCompleted;
    public event Action<string> OnQuestUpdated;

    private bool isLoading = false;

    void Awake()
    {
        if (Instance == null)
        {
            Instance = this;
            DontDestroyOnLoad(gameObject);
        }
        else
        {
            Destroy(gameObject);
        }
        SaveManager.Instance.Register(this);
    }

    void OnEnable()
    {
        InventoryManager.OnItemQuantityChanged += HandleItemQuantityChanged;
    }

    void OnDisable()
    {
        InventoryManager.OnItemQuantityChanged -= HandleItemQuantityChanged;
    }

    void OnDestroy()
    {
        if (SaveManager.Instance != null)
        {
            SaveManager.Instance.Unregister(this);
        }
    }

    private void Start()
    {
        CacheAllNPCs();
    }

    #region 任務狀態
    public void AcceptQuest(string questID)
    {
        if (GetQuestStatus(questID) != Quest.QuestStatus.NotStarted || !ArePrerequisitesMet(questID))
        {
            Debug.LogWarning($"[QuestManager] 無法接受任務 {questID}，狀態不符或前置未完成。");
            return;
        }

        Quest newQuest = QuestDatabase.GetQuest(questID);
        if (newQuest != null)
        {
            questStatuses[questID] = Quest.QuestStatus.InProgress;

            foreach (var objective in newQuest.objectives)
            {
                if (objective.type == QuestObjectiveType.Kill)
                {
                    objective.startingAmount = PlayerStatsManager.Instance.GetKillCount(objective.targetID);
                }
                // (未來可擴充)
            }
            activeQuests[questID] = newQuest;
            Debug.Log($"[QuestManager] 已接受任務: {newQuest.questName}");
            if (!isLoading) OnQuestAccepted?.Invoke(questID);

            SyncQuestProgress(newQuest);
        }
    }

    public void CompleteQuest(string questID)
    {
        if (GetQuestStatus(questID) != Quest.QuestStatus.InProgress) return;

        if (activeQuests.TryGetValue(questID, out Quest quest))
        {
            if (!quest.AreAllObjectivesComplete())
            {
                Debug.LogWarning($"[QuestManager] 嘗試完成任務 '{questID}' 但目標未達成。");
                return;
            }
            permanentlyCompletedQuestIDs.Add(questID);

            PlayerState playerState = FindObjectOfType<PlayerState>();
            if (playerState != null)
            {
                playerState.AddMoney(quest.moneyReward);
            }
            foreach (var reward in quest.itemRewards)
            {
                Item item = ItemDatabase.Instance.GetItemByID(reward.itemID);
                InventoryManager.Instance.AddItem(item, reward.amount);
            }
            if (quest.isRepeatable)
            {
                questStatuses[questID] = Quest.QuestStatus.NotStarted;
                quest.ResetProgress();
            }
            else
            {
                questStatuses[questID] = Quest.QuestStatus.Completed;
            }
            activeQuests.Remove(questID);
            Debug.Log($"[QuestManager] 已完成任務: {quest.questName}");
            if (!isLoading) OnQuestCompleted?.Invoke(questID);
        }
    }

    public Quest.QuestStatus GetQuestStatus(string questID)
    {
        if (questStatuses.TryGetValue(questID, out Quest.QuestStatus status))
        {
            return status;
        }
        return Quest.QuestStatus.NotStarted;
    }

    public bool ArePrerequisitesMet(string questID)
    {
        Quest quest = QuestDatabase.GetQuest(questID);
        if (quest == null) return false;

        foreach (var prereqID in quest.prerequisiteQuestIDs)
        {
            if (GetQuestStatus(prereqID) != Quest.QuestStatus.Completed)
            {
                return false;
            }
        }
        return true;
    }

    public bool IsQuestCompletable(string questID)
    {
        if (activeQuests.TryGetValue(questID, out Quest quest))
        {
            if (!quest.AreAllObjectivesComplete())
            {
                return false;
            }

            foreach (var objective in quest.objectives)
            {
                if (objective.type == QuestObjectiveType.Collect)
                {
                    Item itemToCheck = ItemDatabase.Instance.GetItemByID(objective.targetID);
                    if (!InventoryManager.Instance.HasItem(itemToCheck, objective.requiredAmount))
                    {
                        return false;
                    }
                }
            }
            
            return true;
        }
        return false;
    }

    public bool IsObjectiveVisible(Quest quest, int objectiveIndex)
    {
        if (quest == null || objectiveIndex < 0 || objectiveIndex >= quest.objectives.Count)
        {
            return false;
        }
        QuestObjective objective = quest.objectives[objectiveIndex];

        if (objective.prerequisiteIndex < 0)
        {
            return true;
        }

        int prereqIndex = objective.prerequisiteIndex;
        if (prereqIndex >= 0 && prereqIndex < quest.objectives.Count)
        {
            var prereqObjective = quest.objectives[prereqIndex];
            bool isPrereqComplete = prereqObjective.IsComplete;
            return isPrereqComplete;
        }
        return false;
    }

    public bool HasQuestBeenCompleted(string questID)
    {
        return permanentlyCompletedQuestIDs.Contains(questID);
    }
    #endregion

    #region NPC
    private void CacheAllNPCs()
    {
        npcCache.Clear();
        NPC[] allNpcs = FindObjectsOfType<NPC>();
        foreach (var npc in allNpcs)
        {
            if (!npcCache.ContainsKey(npc.GetNpcID()))
            {
                npcCache.Add(npc.GetNpcID(), npc);
            }
        }
    }

    public List<Quest> GetAvailableQuestsForNPC(string npcID)
    {
        List<Quest> available = new List<Quest>();
        if (npcCache.TryGetValue(npcID, out NPC npc))
        {
            foreach (var questID in npc.GetQuestList())
            {
                if (GetQuestStatus(questID) == Quest.QuestStatus.NotStarted && ArePrerequisitesMet(questID))
                {
                    Quest q = QuestDatabase.GetQuest(questID);
                    if (q != null)
                    {
                        available.Add(q);
                    }
                }
            }
        }
        return available;
    }

    public List<Quest> GetInProgressOrCompletableQuestsForNPC(string npcID)
    {
        return activeQuests.Values.Where(q => q.handInNPCID == npcID).ToList();
    }

    public bool HasAvailableQuests(string npcID)
    {
        if (npcCache.TryGetValue(npcID, out NPC npc))
        {
            foreach (var questID in npc.GetQuestList())
            {
                if (GetQuestStatus(questID) == Quest.QuestStatus.NotStarted && ArePrerequisitesMet(questID))
                {
                    return true;
                }
            }
        }
        return false;
    }

    public bool HasProgressOrCompletableQuests(string npcID)
    {
        return activeQuests.Values.Any(q => q.handInNPCID == npcID);
    }

    public List<Quest> GetActiveQuests()
    {
        return activeQuests.Values.ToList();
    }
    #endregion

    #region 任務進程
    public void AdvanceObjective(string questID, string targetID, QuestObjectiveType type, int amount = 1)
    {
        Debug.Log($"[QuestManager] 接收到精確進度更新請求：QuestID={questID}, TargetID={targetID}, Type={type}");
        if (activeQuests.TryGetValue(questID, out Quest quest))
        {
            bool updated = false;
            foreach (var objective in quest.objectives)
            {
                if (objective.type == type && objective.targetID == targetID && !objective.IsComplete)
                {
                    objective.currentAmount = Mathf.Min(objective.currentAmount + amount, objective.requiredAmount);
                    updated = true;
                    Debug.Log($"[QuestManager] 任務 '{quest.questName}' 的目標 '{objective.description}' 進度更新為: {objective.currentAmount}/{objective.requiredAmount}");
                }
            }
            if (updated)
            {
                if (!isLoading) OnQuestUpdated?.Invoke(quest.questID);
            }
        }
        else
        {
            Debug.LogWarning($"[QuestManager] 嘗試更新任務 '{questID}' 的進度，但該任務不在活躍列表中。");
        }
    }

    public void AdvanceObjective(string targetID, QuestObjectiveType type, int amount = 1)
    {
        if (type == QuestObjectiveType.Kill) return;

        foreach (var quest in activeQuests.Values.ToList())
        {
            bool updated = false;
            foreach (var objective in quest.objectives)
            {
                if (objective.type == type && objective.targetID == targetID && !objective.IsComplete)
                {
                    objective.currentAmount = Mathf.Min(objective.currentAmount + amount, objective.requiredAmount);
                    updated = true;
                }
            }
            if (updated)
            {
                Debug.Log($"[QuestManager] 任務 '{quest.questName}' 進度更新。");
                if (!isLoading) OnQuestUpdated?.Invoke(quest.questID);
            }
        }
    }

    private void OnKillCountUpdated(string enemyID, int newTotalCount)
    {
        foreach (var quest in activeQuests.Values)
        {
            bool wasUpdated = false;
            foreach (var objective in quest.objectives)
            {
                if (objective.type == QuestObjectiveType.Kill && objective.targetID == enemyID)
                {
                    int progress = newTotalCount - objective.startingAmount;
                    objective.currentAmount = Mathf.Min(progress, objective.requiredAmount);
                    wasUpdated = true;
                }
            }
            if (wasUpdated)
            {
                Debug.Log($"[QuestManager] 任務 '{quest.questName}' 因擊殺 '{enemyID}' 而進度更新。");
                OnQuestUpdated?.Invoke(quest.questID);
            }
        }
    }

    public void SyncAllQuestsProgress()
    {
        foreach (var quest in activeQuests.Values)
        {
            SyncQuestProgress(quest);
        }
    }

    public void SyncCollectionQuests()
    {
        foreach (var quest in activeQuests.Values)
        {
            bool updated = false;
            foreach (var objective in quest.objectives)
            {
                if (objective.type == QuestObjectiveType.Collect)
                {
                    Item item = ItemDatabase.Instance.GetItemByID(objective.targetID);
                    int itemCount = InventoryManager.Instance.GetItemCount(item);
                    if (objective.currentAmount != itemCount)
                    {
                        objective.currentAmount = itemCount;
                        updated = true;
                    }
                }
            }
            if (updated)
            {
                OnQuestUpdated?.Invoke(quest.questID);
            }
        }
    }

    private void SyncQuestProgress(Quest quest)
    {
        if (quest == null) return;

        bool wasUpdated = false;
        foreach (var objective in quest.objectives)
        {
            int oldAmount = objective.currentAmount;
            int newAmount = oldAmount;

            switch (objective.type)
            {
                case QuestObjectiveType.Collect:
                    Item item = ItemDatabase.Instance.GetItemByID(objective.targetID);
                    newAmount = InventoryManager.Instance.GetItemCount(item);
                    break;
                case QuestObjectiveType.Kill:
                    int totalKills = PlayerStatsManager.Instance.GetKillCount(objective.targetID);
                    newAmount = totalKills - objective.startingAmount;
                    break;
                    // 其他任務類型...
            }

            objective.currentAmount = Mathf.Clamp(newAmount, 0, objective.requiredAmount);

            if (objective.currentAmount != oldAmount)
            {
                wasUpdated = true;
            }
        }

        if (wasUpdated)
        {
            if (!isLoading) OnQuestUpdated?.Invoke(quest.questID);
        }
    }
    #endregion

    #region 存檔資料
    public void PopulateSaveData(GameSaveData data)
    {
        data.questData.questStatuses = questStatuses.Select(kvp => new QuestStatusEntry { questID = kvp.Key, status = kvp.Value }).ToList();
        data.questData.activeQuests = activeQuests.Select(kvp => new ActiveQuestData
        {
            questID = kvp.Key,
            objectiveProgress = kvp.Value.objectives.Select(obj => obj.currentAmount).ToList()
        }).ToList();
        data.questData.permanentlyCompletedQuestIDs = permanentlyCompletedQuestIDs.ToList();
    }

    public void LoadFromSaveData(GameSaveData data)
    {
        isLoading = true;

        if (data.questData == null) return;
        
        questStatuses = data.questData.questStatuses.ToDictionary(e => e.questID, e => e.status);
        permanentlyCompletedQuestIDs = new HashSet<string>(data.questData.permanentlyCompletedQuestIDs ?? new List<string>());

        activeQuests.Clear();
        if (data.questData.activeQuests != null)
        {
            foreach (var activeQuestData in data.questData.activeQuests)
            {
                Quest questInstance = QuestDatabase.GetQuest(activeQuestData.questID);
                if (questInstance != null)
                {
                    for (int i = 0; i < questInstance.objectives.Count && i < activeQuestData.objectiveProgress.Count; i++)
                    {
                        questInstance.objectives[i].currentAmount = activeQuestData.objectiveProgress[i];
                    }
                    activeQuests[activeQuestData.questID] = questInstance;
                }
            }
        }
        isLoading = false;
    }

    private void HandleItemQuantityChanged(string changedItemID, int newTotalQuantity)
    {
        foreach (var quest in activeQuests.Values.ToList())
        {
            bool wasUpdated = false;
            foreach (var objective in quest.objectives)
            {
                if (objective.type == QuestObjectiveType.Collect && objective.targetID == changedItemID)
                {
                    if (!objective.IsComplete)
                    {
                        int oldAmount = objective.currentAmount;
                        objective.currentAmount = Mathf.Clamp(newTotalQuantity, 0, objective.requiredAmount);
                        
                        if(oldAmount != objective.currentAmount)
                        {
                            wasUpdated = true;
                        }
                    }
                }
            }
            
            if (wasUpdated)
            {
                Debug.Log($"[QuestManager] 因物品 '{changedItemID}' 數量變化，任務 '{quest.questName}' 進度已即時同步。");
                if (!isLoading) OnQuestUpdated?.Invoke(quest.questID);
            }
        }
    }
    #endregion
}
```

#### 4.4. `QuestUI.cs`
```csharp
using UnityEngine;
using TMPro;
using System.Collections.Generic;
using UnityEngine.UI;

public class QuestUI : MonoBehaviour
{
    [Header("UI 元件")]
    [SerializeField] private GameObject questPanel;
    [SerializeField] private Transform questListContainer;
    [SerializeField] private GameObject questListItemPrefab;

    [Header("詳情面板")]
    [SerializeField] private TextMeshProUGUI questNameText;
    [SerializeField] private TextMeshProUGUI questDescriptionText;
    [SerializeField] private TextMeshProUGUI questObjectivesText;
    [SerializeField] private TextMeshProUGUI questRewardsText;

    private List<GameObject> currentListItems = new List<GameObject>();

    private void OnEnable()
    {
        if (QuestManager.Instance != null)
        {
            QuestManager.Instance.OnQuestAccepted += HandleQuestChanged;
            QuestManager.Instance.OnQuestCompleted += HandleQuestChanged;
            QuestManager.Instance.OnQuestUpdated += HandleQuestChanged;
        }
        SaveManager.OnGameLoadComplete += RefreshUI;

        if (questPanel.activeSelf)
        {
            RefreshUI();
        }
    }

    private void OnDisable()
    {
        if (QuestManager.Instance != null)
        {
            QuestManager.Instance.OnQuestAccepted -= HandleQuestChanged;
            QuestManager.Instance.OnQuestCompleted -= HandleQuestChanged;
            QuestManager.Instance.OnQuestUpdated -= HandleQuestChanged;
        }
        SaveManager.OnGameLoadComplete -= RefreshUI;
    }

    private void HandleQuestChanged(string ignoredQuestID)
    {
        RefreshUI();
    }

    void Start()
    {
        questPanel.SetActive(false);
    }

    public void TogglePanel()
    {
        bool isActive = !questPanel.activeSelf;
        questPanel.SetActive(isActive);
        if (isActive)
        {
            RefreshUI();
        }
    }

    #region UI
    public void RefreshUI() 
    {
        if (this == null || questPanel == null || !questPanel.activeSelf || QuestManager.Instance == null) return;

        QuestManager.Instance.SyncCollectionQuests();

        foreach (var item in currentListItems)
        {
            if (item != null) Destroy(item);
        }
        currentListItems.Clear();

        List<Quest> activeQuests = QuestManager.Instance.GetActiveQuests();

        foreach (var quest in activeQuests)
        {
            GameObject listItem = Instantiate(questListItemPrefab, questListContainer);
            TextMeshProUGUI textComponent = listItem.GetComponentInChildren<TextMeshProUGUI>();
            if (textComponent != null) textComponent.text = quest.questName;

            Button button = listItem.GetComponent<Button>();
            if (button != null)
            {
                button.onClick.AddListener(() =>
                {
                    if (this != null) ShowQuestDetails(quest);
                });
            }
            currentListItems.Add(listItem);
        }

        if (activeQuests.Count > 0)
        {
            ShowQuestDetails(activeQuests[0]);
        }
        else
        {
            ClearDetails();
        }
    }

    private void ShowQuestDetails(Quest quest)
    {
        if (quest == null)
        {
            ClearDetails();
            return;
        }
        questNameText.text = quest.questName;
        questDescriptionText.text = quest.description;

        string objectivesStr = "";
        bool allObjectivesComplete = true;

        for (int i = 0; i < quest.objectives.Count; i++)
        {
            if (QuestManager.Instance.IsObjectiveVisible(quest, i))
            {
                var obj = quest.objectives[i];
                string statusIcon;
                string colorTagStart = "";
                string colorTagEnd = "";

                if (obj.IsComplete)
                {
                    statusIcon = "✓";
                    colorTagStart = "<color=#78FF78>";
                    colorTagEnd = "</color>";
                }
                else
                {
                    statusIcon = "☐";
                    colorTagStart = "<color=#CCCCCC>";
                    colorTagEnd = "</color>";

                    allObjectivesComplete = false;
                }
                objectivesStr += $"{colorTagStart}{statusIcon} {obj.description} ({obj.currentAmount} / {obj.requiredAmount}){colorTagEnd}\n";
            }
            else
            {
                allObjectivesComplete = false;
            }
        }

        if (allObjectivesComplete)
        {
            objectivesStr += "<color=#FFD700><b>所有目標均已完成！\n請前往交付任務。</b></color>";
        }
        questObjectivesText.text = objectivesStr.TrimEnd('\n');

        string rewardsStr = "獎勵:\n";
        bool hasAnyReward = false;
        if (quest.moneyReward > 0)
        {
            rewardsStr += $"- 金錢: {quest.moneyReward}\n";
            hasAnyReward = true;
        }
        if (quest.itemRewards != null)
        {
            foreach (var reward in quest.itemRewards)
            {
                Item item = ItemDatabase.Instance.GetItemByID(reward.itemID);
                if (item != null)
                {
                    rewardsStr += $"- {item.itemName} x{reward.amount}\n";
                    hasAnyReward = true;
                }
            }
        }

        if (!hasAnyReward)
        {
            rewardsStr += "- 無";
        }
        questRewardsText.text = rewardsStr;
    }

    private void ClearDetails()
    {
        questNameText.text = "沒有進行中的任務";
        questDescriptionText.text = "";
        questObjectivesText.text = "";
        questRewardsText.text = "";
    }
    #endregion
}
```